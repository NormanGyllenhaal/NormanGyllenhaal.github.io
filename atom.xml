<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Hi, I’m Yang Peng]]></title>
  <link href="http://yeangpeng.tech/atom.xml" rel="self"/>
  <link href="http://yeangpeng.tech/"/>
  <updated>2016-02-18T11:29:36+08:00</updated>
  <id>http://yeangpeng.tech/</id>
  <author>
    <name><![CDATA[Yang Peng]]></name>
    <email><![CDATA[me@yangpeng.tech]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Embedding PLplot in Gtk DrawingAreas]]></title>
    <link href="http://yeangpeng.tech/blog/2015/09/29/embedding-plplot-in-gtk-drawingareas/"/>
    <updated>2015-09-29T18:43:00+08:00</updated>
    <id>http://yeangpeng.tech/blog/2015/09/29/embedding-plplot-in-gtk-drawingareas</id>
    <content type="html"><![CDATA[<p><strong>Update: I have turned this post into a Github project called <a href="https://github.com/tschoonj/gtkmm-plplot">Gtkmm-PLplot</a>, under the GPLv3</strong></p>

<p>测试中文显示效果Scientific plotting and Gtk+ have never been good friends. Over the years there have been a number of efforts like <a href="http://gtkextra.sourceforge.net/cms/">GtkExtra</a>, <a href="http://sourceforge.net/projects/gtkdatabox/">GtkDataBox</a>, <a href="https://github.com/drahnr/goatplot">GoatPlot</a>, <a href="http://gtkgraph.sourceforge.net">GtkGraph</a>&hellip; Unfortunately these packages all appear to share a lack of active development (most are in fact abandoned), poor to non-existent documentation and in most cases lack of support for Gtk+3.</p>

<p>For about a year or two I have been a minor contributor to GtkExtra, and I had started migrating the plotting widgets to Gtk+3 but I had to abandon my effort due to lack of knowledge of Cairo and Gtk+ internals, and more importantly a lack of time. I still use it in the Gtk+2 based GUI of my <a href="https://github.com/tschoonj/xmimsim">XMI-MSIM</a> package though.</p>

<p>I have recently been looking into alternatives to GtkExtra as I switched to Gtk+3 (actually Gtkmm3, as I mostly code in C++ nowadays) for my new projects (e.g. <a href="https://github.com/tschoonj/bam-utils">BAM-utils</a>). I came across a package called <a href="http://plplot.sourceforge.net">PLplot</a>, which I used a long time ago for producing simple plots in PNG format in command-line utilities.</p>

<p>This package used to come with Gnome bindings that ensured easy integration into Gnome based GUIs but it looks like they have been removed some time ago (I am referring here to PLplot 5.11.0, the current stable release). Instead the documentation mentions support for a <a href="http://cairographics.org">cairo</a> driver, which can be embedded in Gtk based user interfaces. Currently the documentation that covers this feature is limited to a README file and a minimal cairo-only example that demonstrates how to use the PLplot cairo driver through the <code>extcairo</code> device by producing a PostScript file.</p>

<p>PLplot has the great advantage over the aforementioned Gtk+ based packages that it is very actively developed by several volunteers and comes with decent documentation, including a lot of examples written in the many languages supported by the toolkit. On the downside, the developers seem to have the unfortunate habit of regularly breaking backwards compatibility in their releases, as they did in their latest 5.11.0 release both at the API level as well as by changing the name of the pkg-config packages&hellip;</p>

<p>In this blogpost I will explain how I managed to embed PLplot into Gtkmm through the GtkDrawingArea widget class, and demonstrate it using a small program that allows one to zoom in on the data, save the plot in a file and print it.</p>

<!--more-->


<h1>Compiling PLplot on Windows 64-bit using TDM-GCC</h1>

<p>It would be remiss if I didn&rsquo;t share the problems I encountered compiling PLplot on my Windows 7 64-bit virtual machine using the TDM-GCC provided MinGW-w64 5.1.0 gcc and g++ compilers.
I used the following command to setup the <a href="http://www.cmake.org">CMake</a> based installation system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cmake -G <span class="s2">&quot;MSYS Makefiles&quot;</span> -DENABLE_DYNDRIVERS<span class="o">=</span>OFF -DPLD_wingcc<span class="o">=</span>OFF ..
</span></code></pre></td></tr></table></div></figure>


<p>The <code>DYNDRIVERS</code> option determines whether the drivers will be loaded at runtime using the libtool ltdl interface, or if they will be built into the main shared library. I chose the latter as this makes distribution easier (less files to copy and no need to set a environment variable or use the registry to get the locations of these drivers). Also I had a feeling PLplot has not been well-tested on Windows, so I prefer avoiding something potentially dangerous as loading dynamically loading modules using libltdl, a library I have no experience with.</p>

<p>I turned of the <code>wingcc</code> driver well simply because the linker consistently crashed when generating the dll. Again something that does not lead me to exude confidence regarding stability of PLplot on Windows 64-bit, but this could also have to do with the immature nature of MinGW-w64. Fortunately I don&rsquo;t need this driver so no great loss here&hellip;</p>

<p>The <code>cmake</code> invokation generated the necessary Makefiles, and I started the compilation using a good old fashioned <code>make</code>.</p>

<p>I noticed that a compilation error was generated in <code>drivers/cairo.c</code>, which I managed to fix after some work with the following patch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/drivers/cairo.c b/drivers/cairo.c</span>
</span><span class='line'><span class="gh">index 8d43ee9..91fbc7d 100644</span>
</span><span class='line'><span class="gd">--- a/drivers/cairo.c</span>
</span><span class='line'><span class="gi">+++ b/drivers/cairo.c</span>
</span><span class='line'><span class="gu">@@ -43,6 +43,7 @@</span>
</span><span class='line'> // Driver-dependent includes
</span><span class='line'> #if defined ( PLD_wincairo )
</span><span class='line'> #include &lt;windows.h&gt;
</span><span class='line'><span class="gi">+#include &lt;cairo-win32.h&gt;</span>
</span><span class='line'> #endif
</span><span class='line'> #if defined ( PLD_xcairo )
</span><span class='line'> #include &lt;cairo-xlib.h&gt;
</span><span class='line'><span class="gu">@@ -3289,7 +3290,7 @@ LRESULT CALLBACK PlplotCairoWndProc( HWND hwnd, UINT nMsg, WPARAM wParam, LPARAM</span>
</span><span class='line'>     }
</span><span class='line'>     else
</span><span class='line'>     {
</span><span class='line'><span class="gd">-        pls = (PLStream *) GetWindowLong( hwnd, GWL_USERDATA ); // Try to get the address to pls for this window</span>
</span><span class='line'><span class="gi">+        pls = (PLStream *) GetWindowLongPtr( hwnd, GWLP_USERDATA ); // Try to get the address to pls for this window</span>
</span><span class='line'>         if ( pls )                                              // If we got it, then we will initialise this windows plplot private data area
</span><span class='line'>         {
</span><span class='line'>             dev = (PLCairo *) pls-&gt;dev;
</span><span class='line'><span class="gu">@@ -3496,7 +3497,7 @@ void plD_init_wincairo( PLStream *pls )</span>
</span><span class='line'> // process this window
</span><span class='line'> //
</span><span class='line'>
</span><span class='line'><span class="gd">-    SetWindowLong( aStream-&gt;hwnd, GWL_USERDATA, (long) pls );</span>
</span><span class='line'><span class="gi">+    SetWindowLongPtr( aStream-&gt;hwnd, GWLP_USERDATA, (LONG_PTR) pls );</span>
</span><span class='line'>     aStream-&gt;SCRN_hdc = aStream-&gt;hdc = GetDC( aStream-&gt;hwnd );
</span><span class='line'>
</span><span class='line'> //
</span></code></pre></td></tr></table></div></figure>


<p>This patch clearly shows that the developers have never tried compiling PLplot with a 64-bit compiler on Windows, neither with gcc nor Visual Studio, as they would have run into the same issue: <code>GWL_USERDATA</code> is simply not defined for 64-bit compilations, and GetWindowLong/SetWindowLong have been <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms633584.aspx">superseded</a> by GetWindowLongPtr/SetWindowLongPtr.</p>

<p>Either way, I submitted this patch <a href="https://sourceforge.net/p/plplot/patches/31/">upstream</a> and I hope that it will be included in the next release (already merged into the master branch).</p>

<p>Obviously no problems arised while compiling PLplot on my Mac and I expect the same for Linux.</p>

<h1>Setting up the build environment</h1>

<p>As usual in my projects, I chose to use the GNU buildtools for my build environment, which in this case consisted of a simple <code>configure.ac</code> and <code>Makefile.am</code>. The former checks that we have a suitable C++ compiler with C++11 standard support as well as the GNU extensions. For this I am using the latest version of the autoconf macro called <code>ax_cxx_compile_stdcxx_11.m4</code>, which I downloaded from the <a href="http://www.gnu.org/software/autoconf-archive/">autoconf archive</a>.</p>

<p>Next I check for the presence of Gtkmm (version 3!) and PLplot. I took care to provide support for both the old and new name of the PLplot C++ bindings, respectively called <code>plplotd-c++</code> and <code>plplot-c++</code>. Using the compilation test provided by the autoconf macro <code>AC_TRY_COMPILE</code> I test for the presence of the <code>extcairo</code> device that I will be using to connect a Cairo context with the PLplot plotting stream.</p>

<h1>The PLplotDrawingArea class</h1>

<p>Moving on to the interesting part: the definition of our class. Obviously we want it to be derived from Gtkmm&rsquo;s <code>DrawingArea</code> class. Instances of this class are basically blank widgets for which the user is required to override the default handler <code>on_draw</code> for the signal <code>signal_draw</code>, as is covered in the reference manual of both <a href="https://developer.gnome.org/gtk3/stable/GtkDrawingArea.html">Gtk</a> and <a href="https://developer.gnome.org/gtkmm/stable/classGtk_1_1DrawingArea.html">Gtkmm</a>.</p>

<p>The class definition follows in the following excerpt. I will discussing the different methods in the following sections.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#ifndef PLPLOTDRAWINGAREA_H</span>
</span><span class='line'><span class="cp">#define PLPLOTDRAWINGAREA_H</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;gtkmm/drawingarea.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;plstream.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'><span class="cp">#include &lt;vector&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">sigc</span><span class="o">::</span><span class="n">signal</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&gt;</span> <span class="n">type_signal_select_region</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PLplotDrawingArea</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Gtk</span><span class="o">::</span><span class="n">DrawingArea</span> <span class="p">{</span>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLFLT</span><span class="o">&gt;</span> <span class="n">x</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLFLT</span><span class="o">&gt;</span> <span class="n">y</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">x_title</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">y_title</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">plot_title</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">start_event</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">start_cairo</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">end_event</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">end_cairo</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">selecting</span><span class="p">;</span>
</span><span class='line'>  <span class="n">plstream</span> <span class="o">*</span><span class="n">pls</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">x_pl_range</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">y_pl_range</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">x_cr_range</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">y_cr_range</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="c1">//our handler for the on_draw signal</span>
</span><span class='line'>  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">on_draw</span><span class="p">(</span><span class="k">const</span> <span class="n">Cairo</span><span class="o">::</span><span class="n">RefPtr</span><span class="o">&lt;</span><span class="n">Cairo</span><span class="o">::</span><span class="n">Context</span><span class="o">&gt;&amp;</span> <span class="n">cr</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">// This is the default handler for the signal signal_select_region().</span>
</span><span class='line'>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">on_select_region</span><span class="p">(</span><span class="kt">double</span> <span class="n">xmin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">xmax</span><span class="p">,</span> <span class="kt">double</span> <span class="n">ymin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">ymax</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="nf">on_button_press_event</span><span class="p">(</span><span class="n">GdkEventButton</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="nf">on_button_release_event</span><span class="p">(</span><span class="n">GdkEventButton</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="nf">on_motion_notify_event</span> <span class="p">(</span><span class="n">GdkEventMotion</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'>  <span class="n">type_signal_select_region</span> <span class="n">_signal_select_region</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="n">PLplotDrawingArea</span><span class="p">(</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLFLT</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLFLT</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">x_title</span><span class="p">,</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">y_title</span><span class="p">,</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">plot_title</span>
</span><span class='line'>  <span class="p">);</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">convert_plplot_to_cairo_coordinates</span><span class="p">(</span>
</span><span class='line'>    <span class="kt">double</span> <span class="n">x_pl</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y_pl</span><span class="p">,</span>
</span><span class='line'>    <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x_cr</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y_cr</span><span class="p">);</span>
</span><span class='line'>  <span class="k">virtual</span> <span class="o">~</span><span class="n">PLplotDrawingArea</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pls</span><span class="p">)</span>
</span><span class='line'>      <span class="k">delete</span> <span class="n">pls</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">type_signal_select_region</span> <span class="n">signal_select_region</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_signal_select_region</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">set_region</span><span class="p">(</span><span class="kt">double</span> <span class="n">xmin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">xmax</span><span class="p">,</span> <span class="kt">double</span> <span class="n">ymin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">ymax</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">draw_plot</span><span class="p">(</span><span class="k">const</span> <span class="n">Cairo</span><span class="o">::</span><span class="n">RefPtr</span><span class="o">&lt;</span><span class="n">Cairo</span><span class="o">::</span><span class="n">Context</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">plstream</span> <span class="o">*</span><span class="n">_pls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The constructor</h2>

<p>Let&rsquo;s start of with the constructor of the class. In this simple example I will assume that user wants to produce a simple two-dimensional plot defined by a vector of X-values and one of Y-values.Obviously our widget class has the potential of being used for far more complex plots after some re-writing and extending but is outside the scope of this blogpost. The code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">PLplotDrawingArea</span><span class="o">::</span><span class="n">PLplotDrawingArea</span><span class="p">(</span>
</span><span class='line'>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLFLT</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">_x</span><span class="p">,</span>
</span><span class='line'>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PLFLT</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">_y</span><span class="p">,</span>
</span><span class='line'>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">_x_title</span><span class="p">,</span>
</span><span class='line'>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">_y_title</span><span class="p">,</span>
</span><span class='line'>  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">_plot_title</span>
</span><span class='line'><span class="p">)</span> <span class="o">:</span> <span class="n">x</span><span class="p">(</span><span class="n">_x</span><span class="p">),</span>
</span><span class='line'>    <span class="n">y</span><span class="p">(</span><span class="n">_y</span><span class="p">),</span>
</span><span class='line'>    <span class="n">x_title</span><span class="p">(</span><span class="n">_x_title</span><span class="p">),</span>
</span><span class='line'>    <span class="n">y_title</span><span class="p">(</span><span class="n">_y_title</span><span class="p">),</span>
</span><span class='line'>    <span class="n">plot_title</span><span class="p">(</span><span class="n">_plot_title</span><span class="p">),</span>
</span><span class='line'>    <span class="n">start_event</span><span class="p">{</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">},</span>
</span><span class='line'>    <span class="n">start_cairo</span><span class="p">{</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">},</span>
</span><span class='line'>    <span class="n">end_event</span><span class="p">{</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">},</span>
</span><span class='line'>    <span class="n">end_cairo</span><span class="p">{</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">},</span>
</span><span class='line'>    <span class="n">selecting</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
</span><span class='line'>    <span class="n">pls</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>    <span class="n">x_pl_range</span><span class="p">{</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">begin</span><span class="p">()),</span> <span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)},</span>
</span><span class='line'>    <span class="n">y_pl_range</span><span class="p">{</span><span class="o">*</span><span class="n">std</span><span class="o">::</span><span class="n">min_element</span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">y</span><span class="p">.</span><span class="n">end</span><span class="p">()),</span>
</span><span class='line'>               <span class="o">*</span><span class="n">std</span><span class="o">::</span><span class="n">max_element</span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">y</span><span class="p">.</span><span class="n">end</span><span class="p">())}</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>  <span class="n">add_events</span><span class="p">(</span><span class="n">Gdk</span><span class="o">::</span><span class="n">POINTER_MOTION_MASK</span> <span class="o">|</span>
</span><span class='line'>             <span class="n">Gdk</span><span class="o">::</span><span class="n">BUTTON_PRESS_MASK</span> <span class="o">|</span>
</span><span class='line'>             <span class="n">Gdk</span><span class="o">::</span><span class="n">BUTTON_RELEASE_MASK</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//connect our default signal handler</span>
</span><span class='line'>  <span class="k">this</span><span class="o">-&gt;</span><span class="n">signal_select_region</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">sigc</span><span class="o">::</span><span class="n">mem_fun</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span>
</span><span class='line'>             <span class="o">&amp;</span><span class="n">PLplotDrawingArea</span><span class="o">::</span><span class="n">on_select_region</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our input vectors are referred to here as <code>_x</code> and <code>_y</code> in the argument list. Furthermore, the user is expected to provide axes titles and a general plot title. The initialization list shows that we will be using member variable copies of these 5 arguments. Note that I am using the PLplot <code>PLFLT</code> datatype here for the vectors, which is typedef'ed to the double datatype.
The rest of the list deals with private variables that deal with the selection box (<code>start_event</code>, <code>start_cairo</code>, <code>end_event</code>, <code>end_cairo</code> and <code>selecting</code>), our PLplot stream object <code>pls</code> and the plotting range determined by <code>x_pl_range</code> and <code>y_pl_range</code>, which are initially set to cover the entire area provided by the data.
The method body does only two things: it makes sure that the mouse events necessary to drag the selection box will be emitted as signals.
Our class defines one signal called <code>signal_on_select_region</code> (after the similarly named <code>GtkPlotCanvas</code> signal from GtkExtra). This signal will be emitted whenever a selection box has been dragged. Its default handler is the <code>on_select_region</code> virtual method, which does absolutely nothing!
So it is up to the user to either derive PLplotDrawing area with an overriding <code>on_select_region</code> method, or alternatively to connect to this signal as will be shown later on in this example. A perfect candidate (with the right function prototype) for this task is the <code>set_region</code> method, which will reduce the plot range to the selected box. This will be demonstrated further along this example when we will be discussing the Window that will hold our PLplotDrawingArea.</p>

<h2>The on_draw method</h2>

<p>The <code>on_draw</code> method will be the most important one of our class as it needs to call the PLplot routines to generate our plot. Let&rsquo;s have a closer look at it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">bool</span> <span class="n">PLplotDrawingArea</span><span class="o">::</span><span class="n">on_draw</span><span class="p">(</span><span class="k">const</span> <span class="n">Cairo</span><span class="o">::</span><span class="n">RefPtr</span><span class="o">&lt;</span><span class="n">Cairo</span><span class="o">::</span><span class="n">Context</span><span class="o">&gt;&amp;</span> <span class="n">cr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">Gtk</span><span class="o">::</span><span class="n">Allocation</span> <span class="n">allocation</span> <span class="o">=</span> <span class="n">get_allocation</span><span class="p">();</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">allocation</span><span class="p">.</span><span class="n">get_width</span><span class="p">();</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">allocation</span><span class="p">.</span><span class="n">get_height</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">pls</span><span class="p">)</span>
</span><span class='line'>    <span class="k">delete</span> <span class="n">pls</span><span class="p">;</span>
</span><span class='line'>  <span class="n">pls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">plstream</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">draw_plot</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">pls</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">selecting</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="n">start_cairo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="n">start_cairo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="n">end_cairo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="n">end_cairo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">cr</span><span class="o">-&gt;</span><span class="n">set_line_width</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="n">cr</span><span class="o">-&gt;</span><span class="n">set_source_rgb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">cr</span><span class="o">-&gt;</span><span class="n">rectangle</span><span class="p">(</span><span class="n">MIN</span><span class="p">(</span><span class="n">start_cairo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_cairo</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class='line'>                  <span class="n">MIN</span><span class="p">(</span><span class="n">start_cairo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_cairo</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span class='line'>                  <span class="n">fabs</span><span class="p">(</span><span class="n">end_cairo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_cairo</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span class='line'>                  <span class="n">fabs</span><span class="p">(</span><span class="n">end_cairo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_cairo</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</span><span class='line'>    <span class="n">cr</span><span class="o">-&gt;</span><span class="n">stroke</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">convert_plplot_to_cairo_coordinates</span><span class="p">(</span><span class="n">x_pl_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_pl_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>                                      <span class="n">x_cr_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_cr_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">convert_plplot_to_cairo_coordinates</span><span class="p">(</span><span class="n">x_pl_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_pl_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>                                      <span class="n">x_cr_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_cr_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The method provides as input argument a pointer to the Cairo context that we will draw to.
We start by querying the dimensions of the widget, followed by allocating memory for our PLplot stream <code>pls</code>, which will next be provided to a method called <code>draw_plot</code> that will take care of the actual PLplot commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">void</span> <span class="n">PLplotDrawingArea</span><span class="o">::</span><span class="n">draw_plot</span><span class="p">(</span><span class="k">const</span> <span class="n">Cairo</span><span class="o">::</span><span class="n">RefPtr</span><span class="o">&lt;</span><span class="n">Cairo</span><span class="o">::</span><span class="n">Context</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">plstream</span> <span class="o">*</span><span class="n">_pls</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">(</span><span class="s">&quot;extcairo&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">spage</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Gdk</span><span class="o">::</span><span class="n">RGBA</span> <span class="n">color</span> <span class="o">=</span> <span class="n">get_style_context</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_color</span><span class="p">();</span>
</span><span class='line'>  <span class="n">Gdk</span><span class="o">::</span><span class="n">Cairo</span><span class="o">::</span><span class="n">set_source_rgba</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">PLESC_DEVINIT</span><span class="p">,</span> <span class="n">cr</span><span class="o">-&gt;</span><span class="n">cobj</span><span class="p">());</span>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">col0</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">env</span><span class="p">(</span><span class="n">x_pl_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_pl_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>            <span class="n">y_pl_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_pl_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">lab</span><span class="p">(</span><span class="n">x_title</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">y_title</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">plot_title</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">col0</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">_pls</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The main reason I am not including this code in <code>on_draw</code> is that gives me the possibility to apply it to Cairo contexts that are not connected to Gtk widgets, but instead to Cairo surfaces for PostScript, PNG and PDF backends as I will demonstrate later on.</p>

<p>Let&rsquo;s go through the different PLplot commands. Their calling order is <em>very</em> important.</p>

<ol>
<li><code>_pls-&gt;sdev("extcairo")</code>: ensures that our stream will be using the <code>extcairo</code> device. This entire class hinges on the availability of this device.</li>
<li><code>_pls-&gt;spage(0.0, 0.0, width, height, 0, 0)</code>: sets the dimensions of the total plotting area (including axes titles etc.!) available to PLplot equal to the widget dimensions.</li>
<li><code>_pls-&gt;init()</code>: initialize the plstream. PLplot internal housekeeping.</li>
<li><code>_pls-&gt;cmd(PLESC_DEVINIT, cr-&gt;cobj())</code>: connects the PLplot internals to our Cairo context. Note the call to <code>cobj()</code>: <code>cr</code> is a Cairomm object and <code>cmd</code> expects a plain Cairo context pointer.</li>
<li><code>_pls-&gt;col0(0)</code>: sets the current color to the first entry in the default colortable: black</li>
<li><code>_pls-&gt;env(...)</code>: defines the range of our X- and Y-data that will be plotted. By default equal to the entire data-range but may be changed when properly handled with <code>signal_select_region</code> and <code>set_region</code>. The last argument determines the axes types.</li>
<li><code>_pls-&gt;lab(...)</code>: sets the axes and plot labels.</li>
<li><code>_pls-&gt;col0(1)</code>: switch to the second color of the colortable: red.</li>
<li><code>_pls-&gt;line(x.size(), &amp;x[0], &amp;y[0])</code>: plot the graph</li>
</ol>


<p>That&rsquo;s it! For more information about the commands, check the extensive PLplot documentation.</p>

<p>Back to <code>on_draw</code>: after the call to <code>draw_plot</code> we find some code that will draw the selection box (if necessary) using some basic Cairo commands. The last two lines are calls to <code>convert_plplot_to_cairo_coordinates</code>, which provide the box selection code with the Cairo coordinates of the plot grid, and will be used to constrain the selection box to the plot grid. These function needs to be called in every call to <code>on_draw</code> as it is the only way to take into account window resizing.</p>

<h2>Dragging the selection box</h2>

<p>An important feature typically found in plotting toolkits is the ability to drag selection boxes. This could be used for example for zooming in on a particular range of the data or for selecting items such as labels that could then be moved around or deleted. To implement this feature one needs to connect signal handlers to signals emitted when a mouse button is pressed and released, as well as when the mouse pointer is moved around. This is why the class contains the three methods <code>on_button_press_event</code>, <code>on_button_release_event</code> and <code>on_motion_notify_event</code>. In order to ensure that the corresponding signals are emitted, the events were added to newly created instances of our class in the constructor.</p>

<p>The hardest part when writing these methods is dealing with the different coordinate systems involved, which can be explained as follows:</p>

<ol>
<li>The Gdk events provide widget coordinates with a coordinate system with an origin in the top left corner of the widget.</li>
<li>Cairo on the other hand works with a coordinate system that has an origin in the lower left corner.</li>
<li>Using the widget height and width, these can be easily translated to normalized coordinates.</li>
<li>To determine the corresponding PLplot coordinates inside our data grid, we feed the normalized Cairo coordinates to PLplot&rsquo;s <code>calc_world</code> function.</li>
</ol>


<p>Using this information we can then properly set up our methods that deal with the mouse events.
Basically, while the mouse button is pressed in and the cursor is moved around, a selection box will be shown (look at the call to <code>rectangle</code> in <code>on_draw</code>), that will be constrained to the data grid, by setting appropriate limits to the drawing starting point and dimensions of our box. Furthermore, we do not allow the box to be drawn when the the button press event is outside of this box.
When the mouse button is released, the box is removed from the widget but the <code>signal_select_region</code> is emitted with the PLplot coordinates of the press and release events, resulting in a call to <code>on_select_region</code>.</p>

<h1>Testing our PLplotDrawingArea widget</h1>

<p>In order to demonstrate the capabilities of this widget, I have written a very basic program that tries to emulate my example from my <a href="http://tschoonj.github.io/blog/2013/07/22/exporting-and-printing-a-gtkextra-plot-canvas/">previous post on GtkExtra printing and exporting</a>. However, I have added two extra capabilities: the possibility to zoom in with the selection box and window resizing.</p>

<p>The test program is an instance of my class called PLplotWindow, which in turn derives from Gtk::Window, and contains only a few member variables corresponding to the buttons and our PLplot drawing area, as well as a Gtk::Grid instance to organize them into the window.</p>

<p>Several methods were added to handle the button click signals that allow to export and print the plot, as well as to quit the app. The code to print and export the plot is basically a literal translation of the corresponding functions in my GtkExtra post from C to C++ and will not be covered here.</p>

<p>More interestingly is the <code>on_plplot_drawing_area_double_click</code> method, which deals with a problem we have not addressed so far: after zooming in on the plot, what if we want to see to the full data range again? I had not added a method for this to our PLplotDrawingArea class (though I could have), so we have to address this issue here. This simple method consists of the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">bool</span> <span class="n">PLplotWindow</span><span class="o">::</span><span class="n">on_plplot_drawing_area_double_click</span><span class="p">(</span><span class="n">GdkEventButton</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
</span><span class='line'>  <span class="kt">double</span> <span class="n">xmin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">xmax</span><span class="p">,</span> <span class="kt">double</span> <span class="n">ymin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">ymax</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDK_2BUTTON_PRESS</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">plplot_drawing_area</span><span class="p">.</span><span class="n">set_region</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since the libsigc++ slot prototype for <code>signal_button_press_event</code> does not provide these 4 double variables, we have to provide them when we connect the signal to our handler using <code>sigc::bind</code> in the constructor:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>  <span class="n">plplot_drawing_area</span><span class="p">.</span><span class="n">signal_button_press_event</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span>
</span><span class='line'>      <span class="n">sigc</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">sigc</span><span class="o">::</span><span class="n">mem_fun</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PLplotWindow</span><span class="o">::</span><span class="n">on_plplot_drawing_area_double_click</span><span class="p">),</span>
</span><span class='line'>      <span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">begin</span><span class="p">()),</span> <span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="n">std</span><span class="o">::</span><span class="n">min_element</span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">y</span><span class="p">.</span><span class="n">end</span><span class="p">()),</span> <span class="o">*</span><span class="n">std</span><span class="o">::</span><span class="n">max_element</span><span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">y</span><span class="p">.</span><span class="n">end</span><span class="p">())));</span>
</span></code></pre></td></tr></table></div></figure>


<p>The constructor also contains our signal handler for PLplotDrawingArea&rsquo;s <code>signal_select_region</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>  <span class="n">plplot_drawing_area</span><span class="p">.</span><span class="n">signal_select_region</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span>
</span><span class='line'>     <span class="n">sigc</span><span class="o">::</span><span class="n">mem_fun</span><span class="p">(</span><span class="n">plplot_drawing_area</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PLplotDrawingArea</span><span class="o">::</span><span class="n">set_region</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>As stated before, we simply make use of our <code>set_region</code> method here which takes care of everything.</p>

<p>One last thing I feel is worth showing here is the following excerpt from the constructor:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">set_default_size</span><span class="p">(</span><span class="mi">720</span><span class="p">,</span> <span class="mi">580</span><span class="p">);</span>
</span><span class='line'><span class="n">Gdk</span><span class="o">::</span><span class="n">Geometry</span> <span class="n">geometry</span><span class="p">;</span>
</span><span class='line'><span class="n">geometry</span><span class="p">.</span><span class="n">min_aspect</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">.</span><span class="n">max_aspect</span> <span class="o">=</span> <span class="kt">double</span><span class="p">(</span><span class="mi">720</span><span class="p">)</span><span class="o">/</span><span class="kt">double</span><span class="p">(</span><span class="mi">580</span><span class="p">);</span>
</span><span class='line'><span class="n">set_geometry_hints</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">Gdk</span><span class="o">::</span><span class="n">HINT_ASPECT</span><span class="p">);</span>
</span><span class='line'><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;PLplot Gtkmm DrawingArea example&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">plplot_drawing_area</span><span class="p">.</span><span class="n">set_hexpand</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span><span class='line'><span class="n">plplot_drawing_area</span><span class="p">.</span><span class="n">set_vexpand</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This part ensures that no matter how the window is resized, the aspect ratio is set to 720/580.
For this to work properly it is crucial that the drawing area is allowed to expand in both directions. Upon a resize, the plot will then be updated accordingly by the <code>on_draw</code> method.</p>

<p>I will conclude this section with a screenshot of the graphical user interface:</p>

<p><img class="center" src="http://yeangpeng.tech/images/plplot-test.png"></p>

<p>Feel free to try it for yourself using the following steps:</p>

<ol>
<li>git clone git@gist.github.com:/c40bb9cca6719478f000.git plplot-test</li>
<li>cd plplot-test</li>
<li>autoreconf -i</li>
<li>./configure</li>
<li>make</li>
<li>./plplot-test</li>
<li>That&rsquo;s it! Start fooling around with the selection box and resizing&hellip;</li>
</ol>


<p>The full gist follows after the conclusions.</p>

<h1>Conclusions</h1>

<p>Based on the work I have put into this for the last couple of days I would say it is a very promising method of bringing high quality scientific plotting into Gtk/Gtkmm. Obviously the code I shared is very simple and needs a lot more functionality in order to become truly useful for a large audience. However the main problem is finding the time to write all the required methods that wrap the functions of PLplot that are needed, which is not necessarily a hard thing to do. Ideally, this would be done in Gtk+ instead of Gtkmm as it would open the code to usage from all languages that have bindings to Gtk+ through introspection. Extending classes in Gtk+ is really hard though (which is why almost no one does it), but trivial in Gtkmm&hellip;</p>

<p>Anyway, if I ever decide to turn this into a real library, you will read about it here.</p>

<div><script src='https://gist.github.com/c40bb9cca6719478f000.js?file=PLplotDrawingArea.h'></script>
<noscript><pre><code>#ifndef PLPLOTDRAWINGAREA_H
#define PLPLOTDRAWINGAREA_H

#include &lt;gtkmm/drawingarea.h&gt;
#include &lt;plstream.h&gt;
#include &lt;string&gt;
#include &lt;vector&gt;

typedef sigc::signal&lt;void, double, double, double, double &gt; type_signal_select_region;

class PLplotDrawingArea : public Gtk::DrawingArea {
private:
  std::vector&lt;PLFLT&gt; x;
  std::vector&lt;PLFLT&gt; y;
  std::string x_title;
  std::string y_title;
  std::string plot_title;
  double start_event[2];
  double start_cairo[2];
  double end_event[2];
  double end_cairo[2];
  bool selecting;
  plstream *pls;
  double x_pl_range[2];
  double y_pl_range[2];
  double x_cr_range[2];
  double y_cr_range[2];
protected:
  //our handler for the on_draw signal
  virtual bool on_draw(const Cairo::RefPtr&lt;Cairo::Context&gt;&amp; cr);
  // This is the default handler for the signal signal_select_region().
  virtual void on_select_region(double xmin, double xmax, double ymin, double ymax);
  bool on_button_press_event(GdkEventButton *event);
  bool on_button_release_event(GdkEventButton *event);
  bool on_motion_notify_event (GdkEventMotion *event);
  type_signal_select_region _signal_select_region;

public:
  PLplotDrawingArea(
    const std::vector&lt;PLFLT&gt; &amp;x,
    const std::vector&lt;PLFLT&gt; &amp;y,
    const std::string &amp;x_title,
    const std::string &amp;y_title,
    const std::string &amp;plot_title
  );
  void convert_plplot_to_cairo_coordinates(
    double x_pl, double y_pl,
    double &amp;x_cr, double &amp;y_cr);
  virtual ~PLplotDrawingArea() {
    if (pls)
      delete pls;
  }

  type_signal_select_region signal_select_region() {
    return _signal_select_region;
  }

  void set_region(double xmin, double xmax, double ymin, double ymax);

  void draw_plot(const Cairo::RefPtr&lt;Cairo::Context&gt; &amp;cr, plstream *_pls, int width, int height);
};
#endif
</code></pre></noscript></div>




<div><script src='https://gist.github.com/c40bb9cca6719478f000.js?file=PLplotDrawingArea.cpp'></script>
<noscript><pre><code>#include &quot;PLplotDrawingArea.h&quot;
#include &lt;iostream&gt;
#include &lt;algorithm&gt;
#include &lt;gdkmm/general.h&gt;
#include &lt;cmath&gt;

PLplotDrawingArea::PLplotDrawingArea(
  const std::vector&lt;PLFLT&gt; &amp;_x,
  const std::vector&lt;PLFLT&gt; &amp;_y,
  const std::string &amp;_x_title,
  const std::string &amp;_y_title,
  const std::string &amp;_plot_title
) : x(_x),
    y(_y),
    x_title(_x_title),
    y_title(_y_title),
    plot_title(_plot_title),
    start_event{-1.0, -1.0},
    start_cairo{-1.0, -1.0},
    end_event{-1.0, -1.0},
    end_cairo{-1.0, -1.0},
    selecting(false),
    pls(0),
    x_pl_range{*(x.begin()), *(x.end()-1)},
    y_pl_range{*std::min_element(y.begin(), y.end()),
               *std::max_element(y.begin(), y.end())}
     {
  add_events(Gdk::POINTER_MOTION_MASK |
             Gdk::BUTTON_PRESS_MASK |
             Gdk::BUTTON_RELEASE_MASK);

  //connect our default signal handler
  this-&gt;signal_select_region().connect(sigc::mem_fun(*this,
             &amp;PLplotDrawingArea::on_select_region));
}

void PLplotDrawingArea::on_select_region(double xmin, double xmax, double ymin, double ymax) {
  //this function does nothing
  //it is designed to be overridden by a derived class
}


void PLplotDrawingArea::set_region(double xmin, double xmax, double ymin, double ymax) {
  if (xmin == xmax &amp;&amp; ymin == ymax) {
    //due to signal propagation, this function will actually be called twice on a double-click event,
    //the second time after the plot has already been resized to its normal geometry
    //this condition avoids the warning message...
    return;
  }
  if (xmin &gt;= xmax || ymin &gt;= ymax ||
      xmin &lt; *(x.begin()) || xmax &gt; *(x.end()-1) ||
      ymin &lt; *std::min_element(y.begin(), y.end()) ||
      ymax &gt; *std::max_element(y.begin(), y.end())) {
    g_warning(&quot;PLplotDrawingArea::set_region(): Invalid arguments&quot;);
    return;
  }
  x_pl_range[0] = xmin;
  x_pl_range[1] = xmax;
  y_pl_range[0] = ymin;
  y_pl_range[1] = ymax;

  this-&gt;get_window()-&gt;invalidate(true);
}

bool PLplotDrawingArea::on_button_press_event(GdkEventButton *event) {
  Gtk::Allocation allocation = get_allocation();
  const int width = allocation.get_width();
  const int height = allocation.get_height();

  start_event[0] = event-&gt;x;
  start_event[1] = event-&gt;y;
  start_cairo[0] = event-&gt;x;
  start_cairo[1] = height - 1.0 * event-&gt;y;
  end_event[0] = -1.0;
  end_event[1] = -1.0;
  end_cairo[0] = -1.0;
  end_cairo[1] = -1.0;

  //check if the starting coordinates are valid
  if (start_cairo[0] &lt; x_cr_range[0] ||
      start_cairo[0] &gt; x_cr_range[1] ||
      start_cairo[1] &lt; y_cr_range[0] ||
      start_cairo[1] &gt; y_cr_range[1]) {
    g_warning(&quot;PLplotDrawingArea::on_button_press_event(): Invalid starting position in on_button_press_event&quot;);
    selecting = false;
    return true;
  }

  this-&gt;get_window()-&gt;invalidate(true);

  selecting = true;

  return false;
}

bool PLplotDrawingArea::on_button_release_event(GdkEventButton *event) {
  if (!selecting)
    return true;

  Gtk::Allocation allocation = get_allocation();
  const int width = allocation.get_width();
  const int height = allocation.get_height();

  end_event[0] = event-&gt;x;
  end_event[1] = event-&gt;y;
  end_cairo[0] = event-&gt;x;
  end_cairo[1] = height - 1.0 * event-&gt;y;

  //make sure we stay within the plot while selecting
  if (end_cairo[0] &gt; start_cairo[0]) {
    //this 1E-10 subtraction is necessary to ensure calc_world works properly
    //when dragging a box that touches the right axis.
    end_cairo[0] = MIN(end_cairo[0], x_cr_range[1] - 1E-10);
  }
  else if (end_cairo[0] &lt; start_cairo[0]) {
    end_cairo[0] = MAX(end_cairo[0], x_cr_range[0]);
  }

  if (end_cairo[1] &gt; start_cairo[1]) {
    end_cairo[1] = MIN(end_cairo[1], y_cr_range[1]);
  }
  else if (end_cairo[1] &lt; start_cairo[1]) {
    end_cairo[1] = MAX(end_cairo[1], y_cr_range[0]);
  }

  selecting = false;

  //emit signal!
  //prepare plplot coordinates
  //inspired by https://www.mail-archive.com/plplot-devel@lists.sourceforge.net/msg03079.html
  double start_cairo_norm[2] = {start_cairo[0]/width, start_cairo[1]/height};
  double end_cairo_norm[2] = {end_cairo[0]/width, end_cairo[1]/height};

  double start_plplot[2];
  double end_plplot[2];
  int index;

  //get the plot coordinates corresponding to the cairo coordinates
  pls-&gt;calc_world(start_cairo_norm[0], start_cairo_norm[1],
                  start_plplot[0], start_plplot[1], index);
  pls-&gt;calc_world(end_cairo_norm[0], end_cairo_norm[1],
                  end_plplot[0], end_plplot[1], index);

  double start_plplot_def[2];
  double end_plplot_def[2];

  //ensure that the coordinates are within the extremes based on the x and y vectors
  //in case of the full view, due to precision errors, the extremes calculated based on calc_world
  //are actually slightly outside of these data extremes, meaning that it&#39;s not possible to drag the selection
  //along the plot grid
  start_plplot_def[0] = MAX(MIN(start_plplot[0], end_plplot[0]), *(x.begin()));
  start_plplot_def[1] = MAX(MIN(start_plplot[1], end_plplot[1]), *std::min_element(y.begin(), y.end()));
  end_plplot_def[0] = MIN(MAX(start_plplot[0], end_plplot[0]), *(x.end()-1));
  end_plplot_def[1] = MIN(MAX(start_plplot[1], end_plplot[1]), *std::max_element(y.begin(), y.end()));

  this-&gt;get_window()-&gt;invalidate(true);

  _signal_select_region.emit(start_plplot_def[0], end_plplot_def[0], start_plplot_def[1], end_plplot_def[1]);

  return true;
}

bool PLplotDrawingArea::on_motion_notify_event (GdkEventMotion *event) {
  if (!selecting)
    return true;

  Gtk::Allocation allocation = get_allocation();
  const int width = allocation.get_width();
  const int height = allocation.get_height();

  end_event[0] = event-&gt;x;
  end_event[1] = event-&gt;y;
  end_cairo[0] = event-&gt;x;
  end_cairo[1] = height - 1.0 * event-&gt;y;

  //make sure we stay within the plot while selecting
  if (end_cairo[0] &gt; start_cairo[0]) {
    end_cairo[0] = MIN(end_cairo[0], x_cr_range[1]);
  }
  else if (end_cairo[0] &lt; start_cairo[0]) {
    end_cairo[0] = MAX(end_cairo[0], x_cr_range[0]);
  }

  if (end_cairo[1] &gt; start_cairo[1]) {
    end_cairo[1] = MIN(end_cairo[1], y_cr_range[1]);
  }
  else if (end_cairo[1] &lt; start_cairo[1]) {
    end_cairo[1] = MAX(end_cairo[1], y_cr_range[0]);
  }

  this-&gt;get_window()-&gt;invalidate(true);

  return true;
}

void PLplotDrawingArea::draw_plot(const Cairo::RefPtr&lt;Cairo::Context&gt; &amp;cr, plstream *_pls, int width, int height) {
  _pls-&gt;sdev(&quot;extcairo&quot;);
  _pls-&gt;spage(0.0, 0.0, width, height, 0, 0);
  _pls-&gt;init();

  Gdk::RGBA color = get_style_context()-&gt;get_color();
  Gdk::Cairo::set_source_rgba(cr, color);
  _pls-&gt;cmd(PLESC_DEVINIT, cr-&gt;cobj());
  _pls-&gt;col0(0);

  _pls-&gt;env(x_pl_range[0], x_pl_range[1],
            y_pl_range[0], y_pl_range[1],
            0, 0);

  _pls-&gt;lab(x_title.c_str(), y_title.c_str(), plot_title.c_str());
  _pls-&gt;col0(1);
  _pls-&gt;line(x.size(), &amp;x[0], &amp;y[0]);

  return;
}

bool PLplotDrawingArea::on_draw(const Cairo::RefPtr&lt;Cairo::Context&gt;&amp; cr) {
  Gtk::Allocation allocation = get_allocation();
  const int width = allocation.get_width();
  const int height = allocation.get_height();

  if (pls)
    delete pls;
  pls = new plstream;

  draw_plot(cr, pls, width, height);

  if (selecting &amp;&amp;
      start_cairo[0] &gt;= 0.0 &amp;&amp;
      start_cairo[1] &gt;= 0.0 &amp;&amp;
      end_cairo[0] &gt;= 0.0 &amp;&amp;
      end_cairo[1] &gt;= 0.0) {
    cr-&gt;set_line_width(2);
    cr-&gt;set_source_rgb(0, 0, 0);
    cr-&gt;rectangle(MIN(start_cairo[0], end_cairo[0]),
                  MIN(start_cairo[1], end_cairo[1]),
                  fabs(end_cairo[0] - start_cairo[0]),
                  fabs(end_cairo[1] - start_cairo[1]));
    cr-&gt;stroke();
  }

  convert_plplot_to_cairo_coordinates(x_pl_range[0], y_pl_range[0],
                                      x_cr_range[0], y_cr_range[0]);
  convert_plplot_to_cairo_coordinates(x_pl_range[1], y_pl_range[1],
                                      x_cr_range[1], y_cr_range[1]);
  return true;
}

void PLplotDrawingArea::convert_plplot_to_cairo_coordinates(
     double x_pl, double y_pl,
     double &amp;x_cr, double &amp;y_cr) {
  //inspired by http://www.mail-archive.com/plplot-devel@lists.sourceforge.net/msg02383.html
  //but the last equation was incorrect and is fixed here
  Gtk::Allocation allocation = get_allocation();
  const int width = allocation.get_width();
  const int height = allocation.get_height();
  double nxmin, nxmax, nymin, nymax;
  double wxmin, wxmax, wymin, wymax;

  pls-&gt;gvpd(nxmin, nxmax, nymin, nymax);
  pls-&gt;gvpw(wxmin, wxmax, wymin, wymax);

  double xmin = width * nxmin;
  double xmax = width * nxmax;
  double ymin = height * nymin;
  double ymax = height * nymax;

  x_cr = xmin + ((xmax - xmin) * ((x_pl - wxmin) / (wxmax - wxmin)));
  y_cr = ymin + ((ymax - ymin) * ((y_pl - wymin) / (wymax - wymin)));
}
</code></pre></noscript></div>




<div><script src='https://gist.github.com/c40bb9cca6719478f000.js?file=PLplotWindow.h'></script>
<noscript><pre><code>#ifndef PLPLOTWINDOW_H
#define PLPLOTWINDOW_H

#include &lt;gtkmm/window.h&gt;
#include &lt;gtkmm/grid.h&gt;
#include &lt;gtkmm/buttonbox.h&gt;
#include &lt;gtkmm/button.h&gt;
#include &quot;PLplotDrawingArea.h&quot;
#include &lt;plstream.h&gt;
#include &lt;vector&gt;
#include &lt;string&gt;
#include &lt;cmath&gt;
#include &lt;iostream&gt;
#include &lt;gtkmm/printcontext.h&gt;


class PLplotWindow : public Gtk::Window {
private:
  PLplotDrawingArea plplot_drawing_area;
  bool on_plplot_drawing_area_double_click(GdkEventButton *event,
    double xmin, double xmax, double ymin, double ymax);
  Gtk::Grid grid;
  Gtk::Button print_button;
  Gtk::Button saveas_button;
  Gtk::Button quit_button;
  Gtk::ButtonBox buttons;
  void on_quit_button_clicked() {
    get_application()-&gt;remove_window(*this);
    return;
  }
  void on_saveas_button_clicked();
  void on_print_button_clicked();
  void on_draw_page(const Glib::RefPtr&lt;Gtk::PrintContext&gt;&amp; context, int page_nr);

public:
  PLplotWindow(std::vector&lt;PLFLT&gt; &amp;x, std::vector&lt;PLFLT&gt; &amp;y,
    std::string x_title = &quot;X-axis&quot;, std::string y_title = &quot;Y-axis&quot;,
    std::string plot_title = &quot;&quot;);
  virtual ~PLplotWindow() {}


};



#endif
</code></pre></noscript></div>




<div><script src='https://gist.github.com/c40bb9cca6719478f000.js?file=PLplotWindow.cpp'></script>
<noscript><pre><code>#include &quot;PLplotWindow.h&quot;
#include &lt;gtkmm/printsettings.h&gt;
#include &lt;gtkmm/pagesetup.h&gt;
#include &lt;gtkmm/printoperation.h&gt;
#include &lt;gtkmm/filechooserdialog.h&gt;

bool PLplotWindow::on_plplot_drawing_area_double_click(GdkEventButton *event,
  double xmin, double xmax, double ymin, double ymax) {
  if (event-&gt;type == GDK_2BUTTON_PRESS) {
    plplot_drawing_area.set_region(xmin, xmax, ymin, ymax);
  }
  return false;
}

PLplotWindow::PLplotWindow(std::vector&lt;PLFLT&gt; &amp;x, std::vector&lt;PLFLT&gt; &amp;y,
    std::string x_title, std::string y_title,
    std::string plot_title) : plplot_drawing_area(x, y, x_title,
      y_title, plot_title), print_button(&quot;Print&quot;), saveas_button(&quot;Save as&quot;),
      quit_button(&quot;Quit&quot;), buttons(Gtk::ORIENTATION_HORIZONTAL) {

  set_default_size(720, 580);
  //sadly the fixed aspect ratio does not work properly on OS X
  //see https://bugzilla.gnome.org/show_bug.cgi?id=723859
  //I submitted a patch for this...
  Gdk::Geometry geometry;
  geometry.min_aspect = geometry.max_aspect = double(720)/double(580);
  set_geometry_hints(*this, geometry, Gdk::HINT_ASPECT);
  set_title(&quot;PLplot Gtkmm DrawingArea example&quot;);
  //resize on select
  //signal_select_region&#39;s default handler doesnt do anything so
  //in order for the selection box to do something at all, two options are available:
  //1) derive PLplotDrawingArea and define your own on_select_region method
  //2) if using an instance of PLplotDrawingArea, connect a signal to signal_select_region, this is done here
  //both options are encouraged to use PLplotDrawingArea::set_region, possibly combined with further calls...
  plplot_drawing_area.signal_select_region().connect(sigc::mem_fun(plplot_drawing_area, &amp;PLplotDrawingArea::set_region));

  //the double click event is not handled at all by PLplotDrawingArea (although I could...)
  plplot_drawing_area.signal_button_press_event().connect(sigc::bind(sigc::mem_fun(*this, &amp;PLplotWindow::on_plplot_drawing_area_double_click), *(x.begin()), *(x.end()-1), *std::min_element(y.begin(), y.end()), *std::max_element(y.begin(), y.end())));

  quit_button.signal_clicked().connect(sigc::mem_fun(*this, &amp;PLplotWindow::on_quit_button_clicked));
  print_button.signal_clicked().connect(sigc::mem_fun(*this, &amp;PLplotWindow::on_print_button_clicked));
  saveas_button.signal_clicked().connect(sigc::mem_fun(*this, &amp;PLplotWindow::on_saveas_button_clicked));

  buttons.pack_start(print_button);
  buttons.pack_start(saveas_button);
  buttons.pack_start(quit_button);
  buttons.set_layout(Gtk::BUTTONBOX_CENTER);
  buttons.set_spacing(10);
  buttons.set_vexpand(false);
  buttons.set_hexpand(true);

  plplot_drawing_area.set_hexpand(true);
  plplot_drawing_area.set_vexpand(true);

  grid.attach(buttons, 0, 0, 1, 1);
  grid.attach(plplot_drawing_area, 0, 1, 1, 1);
  grid.set_column_spacing(5);
    grid.set_row_spacing(5);
    grid.set_row_homogeneous(false);
    grid.set_column_homogeneous(false);

  add(grid);
  set_border_width(10);
  grid.show_all();
  //plplot_drawing_area.show();

}


void PLplotWindow::on_draw_page(const Glib::RefPtr&lt;Gtk::PrintContext&gt;&amp; context, int page_nr) {
  ::Cairo::RefPtr&lt; ::Cairo::Context&gt; cr = context-&gt;get_cairo_context();

  plstream pls;
  plplot_drawing_area.draw_plot(cr, &amp;pls, 842, 595);
}

void PLplotWindow::on_print_button_clicked() {
  //print settings
  Glib::RefPtr&lt;Gtk::PrintSettings&gt; print_settings = Gtk::PrintSettings::create();
  print_settings-&gt;set_orientation(Gtk::PAGE_ORIENTATION_LANDSCAPE);
  print_settings-&gt;set_paper_size(Gtk::PaperSize(Gtk::PAPER_NAME_A4));

  Glib::RefPtr&lt;Gtk::PageSetup&gt; page_setup = Gtk::PageSetup::create();
  page_setup-&gt;set_orientation(Gtk::PAGE_ORIENTATION_LANDSCAPE);
  page_setup-&gt;set_paper_size_and_default_margins(Gtk::PaperSize(Gtk::PAPER_NAME_A4));

  Glib::RefPtr&lt;Gtk::PrintOperation&gt; operation = Gtk::PrintOperation::create();
  operation-&gt;set_print_settings(print_settings);
  operation-&gt;set_default_page_setup(page_setup);
  operation-&gt;set_show_progress(true);
  operation-&gt;set_track_print_status(true);
  operation-&gt;set_use_full_page(true);
  operation-&gt;signal_draw_page().connect(sigc::mem_fun(*this, &amp;PLplotWindow::on_draw_page));
  operation-&gt;set_n_pages(1);

  if (Gtk::PRINT_OPERATION_RESULT_APPLY != operation-&gt;run(Gtk::PRINT_OPERATION_ACTION_PRINT_DIALOG, *this)) {
    //error handling
  }

  return;
}

void PLplotWindow::on_saveas_button_clicked() {
  Gtk::FileChooserDialog dialog(*this, &quot;Save as&quot;, Gtk::FILE_CHOOSER_ACTION_SAVE);
  dialog.add_button(&quot;_Cancel&quot;, Gtk::RESPONSE_CANCEL);
    dialog.add_button(&quot;Select&quot;, Gtk::RESPONSE_OK);
  dialog.set_do_overwrite_confirmation(true);
  Glib::RefPtr&lt;Gtk::FileFilter&gt; filter_eps = Gtk::FileFilter::create();
  filter_eps-&gt;add_pattern(&quot;*.eps&quot;);
  filter_eps-&gt;set_name(&quot;EPS&quot;);
  dialog.add_filter(filter_eps);
  Glib::RefPtr&lt;Gtk::FileFilter&gt; filter_png = Gtk::FileFilter::create();
  filter_png-&gt;add_pattern(&quot;*.png&quot;);
  filter_png-&gt;set_name(&quot;PNG&quot;);
  dialog.add_filter(filter_png);
  Glib::RefPtr&lt;Gtk::FileFilter&gt; filter_pdf = Gtk::FileFilter::create();
  filter_pdf-&gt;add_pattern(&quot;*.pdf&quot;);
  filter_pdf-&gt;set_name(&quot;PDF&quot;);
  dialog.add_filter(filter_pdf);

  if (dialog.run() == Gtk::RESPONSE_OK) {
    std::string filename = dialog.get_filename();
    Glib::RefPtr&lt;Gtk::FileFilter&gt; filter_selected = dialog.get_filter();
    if (filter_selected-&gt;get_name() == &quot;EPS&quot;) {
      if (filename.compare(filename.length()-4, std::string::npos, &quot;.eps&quot;) != 0)
                filename += &quot;.eps&quot;;

      Cairo::RefPtr&lt;Cairo::PsSurface&gt; surface = Cairo::PsSurface::create(filename, 842, 595);
      surface-&gt;set_eps(true);
      Cairo::RefPtr&lt;Cairo::Context&gt; cr = Cairo::Context::create(surface);

      plstream pls;
      plplot_drawing_area.draw_plot(cr, &amp;pls, 842, 595);

      cr-&gt;show_page();
    }
    else if (filter_selected-&gt;get_name() == &quot;PNG&quot;) {
      if (filename.compare(filename.length()-4, std::string::npos, &quot;.png&quot;) != 0)
                filename += &quot;.png&quot;;

      Cairo::RefPtr&lt;Cairo::ImageSurface&gt; surface = Cairo::ImageSurface::create(Cairo::FORMAT_ARGB32, 842, 595);
      Cairo::RefPtr&lt;Cairo::Context&gt; cr = Cairo::Context::create(surface);

      plstream pls;
      plplot_drawing_area.draw_plot(cr, &amp;pls, 842, 595);

      surface-&gt;write_to_png(filename);
    }
    else if (filter_selected-&gt;get_name() == &quot;PDF&quot;) {
      if (filename.compare(filename.length()-4, std::string::npos, &quot;.pdf&quot;) != 0)
                filename += &quot;.pdf&quot;;

      Cairo::RefPtr&lt;Cairo::PdfSurface&gt; surface = Cairo::PdfSurface::create(filename, 842, 595);
      Cairo::RefPtr&lt;Cairo::Context&gt; cr = Cairo::Context::create(surface);

      plstream pls;
      plplot_drawing_area.draw_plot(cr, &amp;pls, 842, 595);

      cr-&gt;show_page();
    }
  }
  return;
}
</code></pre></noscript></div>




<div><script src='https://gist.github.com/c40bb9cca6719478f000.js?file=main.cpp'></script>
<noscript><pre><code>#include &lt;gtkmm/application.h&gt;
#include &lt;glibmm/miscutils.h&gt;
#include &lt;glib.h&gt;
#include &quot;PLplotWindow.h&quot;
#include &lt;valarray&gt;



int main(int argc, char **argv) {
    Glib::set_application_name(&quot;plplot-test&quot;);
#if defined(G_OS_WIN32)
  //windows requires a bit more work. This example sets the PLPLOT_LIB environment variable
  //to ensure the PLplot data files are found at runtime
    gchar *installation_dir = g_win32_get_package_installation_directory_of_module(NULL);
    std::string path_to_plplot(Glib::build_filename(installation_dir, &quot;Share&quot;, &quot;plplot&quot;));
    std::cout &lt;&lt; &quot;path to plplot: &quot; &lt;&lt; path_to_plplot &lt;&lt; std::endl;
    Glib::setenv(&quot;PLPLOT_LIB&quot;, path_to_plplot, true);
    g_free(installation_dir);
#endif
    Glib::RefPtr&lt;Gtk::Application&gt; app = Gtk::Application::create(argc, argv, &quot;eu.tomschoonjans.plplot&quot;);

  //valarrays are underestimated IMHO
  std::valarray&lt;PLFLT&gt; x_va(1000), y_va(1000);
  for (unsigned int i = 0 ; i &lt; 1000 ; i++) {
    x_va[i] = 4*M_PI*i/999;
  }
  y_va = sin(x_va);

  std::vector&lt;PLFLT&gt; x(std::begin(x_va), std::end(x_va)),
    y(std::begin(y_va), std::end(y_va));
  std::string x_title(&quot;x&quot;), y_title(&quot;y = sinx(x)&quot;);

    PLplotWindow window(x, y, x_title, y_title, &quot;PLplotDrawingArea demonstration&quot;);

    return app-&gt;run(window);
}
</code></pre></noscript></div>




<div><script src='https://gist.github.com/c40bb9cca6719478f000.js?file=Makefile.am'></script>
<noscript><pre><code>bin_PROGRAMS = plplot-test
plplot_test_SOURCES = main.cpp \
                      PLplotWindow.h \
                      PLplotWindow.cpp \
                      PLplotDrawingArea.h \
                      PLplotDrawingArea.cpp
plplot_test_CPPFLAGS= $(plplotcxx_CFLAGS) $(gtkmm_CFLAGS)
plplot_test_LDADD = $(plplotcxx_LIBS) $(gtkmm_LIBS)
</code></pre></noscript></div>




<div><script src='https://gist.github.com/c40bb9cca6719478f000.js?file=configure.ac'></script>
<noscript><pre><code>AC_INIT([plplot-blog],[0.1],[tom.schoonjans@me.com],,[https://tschoonj.github.io])
AC_PREREQ([2.60])
AC_CONFIG_SRCDIR([main.cpp])
AC_CONFIG_AUX_DIR([build-aux])
AM_INIT_AUTOMAKE([-Wall -Werror foreign])
AC_CANONICAL_HOST


#m4_pattern_allow([AS_TR_SH])
AC_CONFIG_MACRO_DIR([.])

AC_USE_SYSTEM_EXTENSIONS
m4_ifdef([AM_PROG_AR], [AM_PROG_AR])


AC_PROG_CC
if test `AS_BASENAME([$CC])` = $CC ; then
  AC_CHECK_PROG(CC_FULL, [$CC], $CC, [none])
  #this next line may never be reached...
  if test x$CC_FULL = &quot;xnone&quot; ; then
          AC_MSG_ERROR([no C compiler was found on the system.])
  fi
fi
AM_PROG_CC_C_O


AC_PROG_CXX
if test `AS_BASENAME([$CXX])` = $CXX ; then
  AC_CHECK_PROG(CXX_FULL, [$CXX], $CXX, [none])
  #this next line may never be reached...
  if test x$CXX_FULL = &quot;xnone&quot; ; then
          AC_MSG_ERROR([no C++ compiler was found on the system.])
  fi
fi

AX_CXX_COMPILE_STDCXX_11(ext, mandatory)

LDFLAGS_EXTRA=&quot;&quot;
OS_WINDOWS=0
OS_WINDOWS_32=0
OS_WINDOWS_64=0

case &quot;$host&quot; in
    i686-*mingw*)
        OS_WINDOWS_32=1
        OS_WINDOWS=1
        ;;
    x86_64-*mingw*)
        OS_WINDOWS_64=1
        OS_WINDOWS=1
        ;;
esac

AC_SUBST(WINDRES_ARCH)

AC_SUBST(OS_WINDOWS)
AM_CONDITIONAL([OS_WINDOWS],[test x$OS_WINDOWS = x1])
AC_SUBST(OS_WINDOWS_32)
AM_CONDITIONAL([OS_WINDOWS_32],[test x$OS_WINDOWS_32 = x1])
AC_SUBST(OS_WINDOWS_64)
AM_CONDITIONAL([OS_WINDOWS_64],[test x$OS_WINDOWS_64 = x1])

#look for xraylib
#initialize pkg-config
PKG_PROG_PKG_CONFIG


#search for xraylib and other modules
PKG_CHECK_MODULES([gtkmm],gtkmm-3.0 &gt;= 3.12.0)
PKG_CHECK_MODULES([plplotcxx], [plplot-c++], ,
 [PKG_CHECK_MODULES([plplotcxx], [plplotd-c++])])

#check for the extcairo device
result=
AC_MSG_CHECKING([for plplot extcairo device])
ac_save_CFLAGS=&quot;$CFLAGS&quot;
CFLAGS=$plplotcxx_CFLAGS
AC_LANG_PUSH([C])
AC_TRY_COMPILE([
        #include &lt;plDevs.h&gt;
],[
#ifndef PLD_extcairo
  #error
#endif
],[
  result=yes
  AC_DEFINE([HAVE_EXTCAIRO], [], [extcairo found])
],[result=no])
AC_MSG_RESULT([$result])
if test x$result = xno ; then
  AC_MSG_ERROR([plplot must be built with the extcairo device!])
fi
AC_LANG_POP
CFLAGS=&quot;$ac_save_CFLAGS&quot;





AC_CONFIG_FILES([Makefile])
AC_CONFIG_HEADERS([config.h])



AC_OUTPUT
</code></pre></noscript></div>




<div><script src='https://gist.github.com/c40bb9cca6719478f000.js?file=ax_cxx_compile_stdcxx_11.m4'></script>
<noscript><pre><code># ============================================================================
#  http://www.gnu.org/software/autoconf-archive/ax_cxx_compile_stdcxx_11.html
# ============================================================================
#
# SYNOPSIS
#
#   AX_CXX_COMPILE_STDCXX_11([ext|noext],[mandatory|optional])
#
# DESCRIPTION
#
#   Check for baseline language coverage in the compiler for the C++11
#   standard; if necessary, add switches to CXXFLAGS to enable support.
#
#   The first argument, if specified, indicates whether you insist on an
#   extended mode (e.g. -std=gnu++11) or a strict conformance mode (e.g.
#   -std=c++11).  If neither is specified, you get whatever works, with
#   preference for an extended mode.
#
#   The second argument, if specified &#39;mandatory&#39; or if left unspecified,
#   indicates that baseline C++11 support is required and that the macro
#   should error out if no mode with that support is found.  If specified
#   &#39;optional&#39;, then configuration proceeds regardless, after defining
#   HAVE_CXX11 if and only if a supporting mode is found.
#
# LICENSE
#
#   Copyright (c) 2008 Benjamin Kosnik &lt;bkoz@redhat.com&gt;
#   Copyright (c) 2012 Zack Weinberg &lt;zackw@panix.com&gt;
#   Copyright (c) 2013 Roy Stogner &lt;roystgnr@ices.utexas.edu&gt;
#   Copyright (c) 2014, 2015 Google Inc.; contributed by Alexey Sokolov &lt;sokolov@google.com&gt;
#
#   Copying and distribution of this file, with or without modification, are
#   permitted in any medium without royalty provided the copyright notice
#   and this notice are preserved. This file is offered as-is, without any
#   warranty.

#serial 11

m4_define([_AX_CXX_COMPILE_STDCXX_11_testbody], [[
  template &lt;typename T&gt;
    struct check
    {
      static_assert(sizeof(int) &lt;= sizeof(T), &quot;not big enough&quot;);
    };

    struct Base {
    virtual void f() {}
    };
    struct Child : public Base {
    virtual void f() override {}
    };

    typedef check&lt;check&lt;bool&gt;&gt; right_angle_brackets;

    int a;
    decltype(a) b;

    typedef check&lt;int&gt; check_type;
    check_type c;
    check_type&amp;&amp; cr = static_cast&lt;check_type&amp;&amp;&gt;(c);

    auto d = a;
    auto l = [](){};
    // Prevent Clang error: unused variable &#39;l&#39; [-Werror,-Wunused-variable]
    struct use_l { use_l() { l(); } };

    // http://stackoverflow.com/questions/13728184/template-aliases-and-sfinae
    // Clang 3.1 fails with headers of libstd++ 4.8.3 when using std::function because of this
    namespace test_template_alias_sfinae {
        struct foo {};

        template&lt;typename T&gt;
        using member = typename T::member_type;

        template&lt;typename T&gt;
        void func(...) {}

        template&lt;typename T&gt;
        void func(member&lt;T&gt;*) {}

        void test();

        void test() {
            func&lt;foo&gt;(0);
        }
    }
]])

AC_DEFUN([AX_CXX_COMPILE_STDCXX_11], [dnl
  m4_if([$1], [], [],
        [$1], [ext], [],
        [$1], [noext], [],
        [m4_fatal([invalid argument `$1&#39; to AX_CXX_COMPILE_STDCXX_11])])dnl
  m4_if([$2], [], [ax_cxx_compile_cxx11_required=true],
        [$2], [mandatory], [ax_cxx_compile_cxx11_required=true],
        [$2], [optional], [ax_cxx_compile_cxx11_required=false],
        [m4_fatal([invalid second argument `$2&#39; to AX_CXX_COMPILE_STDCXX_11])])
  AC_LANG_PUSH([C++])dnl
  ac_success=no
  AC_CACHE_CHECK(whether $CXX supports C++11 features by default,
  ax_cv_cxx_compile_cxx11,
  [AC_COMPILE_IFELSE([AC_LANG_SOURCE([_AX_CXX_COMPILE_STDCXX_11_testbody])],
    [ax_cv_cxx_compile_cxx11=yes],
    [ax_cv_cxx_compile_cxx11=no])])
  if test x$ax_cv_cxx_compile_cxx11 = xyes; then
    ac_success=yes
  fi

  m4_if([$1], [noext], [], [dnl
  if test x$ac_success = xno; then
    for switch in -std=gnu++11 -std=gnu++0x; do
      cachevar=AS_TR_SH([ax_cv_cxx_compile_cxx11_$switch])
      AC_CACHE_CHECK(whether $CXX supports C++11 features with $switch,
                     $cachevar,
        [ac_save_CXXFLAGS=&quot;$CXXFLAGS&quot;
         CXXFLAGS=&quot;$CXXFLAGS $switch&quot;
         AC_COMPILE_IFELSE([AC_LANG_SOURCE([_AX_CXX_COMPILE_STDCXX_11_testbody])],
          [eval $cachevar=yes],
          [eval $cachevar=no])
         CXXFLAGS=&quot;$ac_save_CXXFLAGS&quot;])
      if eval test x\$$cachevar = xyes; then
        CXXFLAGS=&quot;$CXXFLAGS $switch&quot;
        ac_success=yes
        break
      fi
    done
  fi])

  m4_if([$1], [ext], [], [dnl
  if test x$ac_success = xno; then
    dnl HP&#39;s aCC needs +std=c++11 according to:
    dnl http://h21007.www2.hp.com/portal/download/files/unprot/aCxx/PDF_Release_Notes/769149-001.pdf
    for switch in -std=c++11 -std=c++0x +std=c++11; do
      cachevar=AS_TR_SH([ax_cv_cxx_compile_cxx11_$switch])
      AC_CACHE_CHECK(whether $CXX supports C++11 features with $switch,
                     $cachevar,
        [ac_save_CXXFLAGS=&quot;$CXXFLAGS&quot;
         CXXFLAGS=&quot;$CXXFLAGS $switch&quot;
         AC_COMPILE_IFELSE([AC_LANG_SOURCE([_AX_CXX_COMPILE_STDCXX_11_testbody])],
          [eval $cachevar=yes],
          [eval $cachevar=no])
         CXXFLAGS=&quot;$ac_save_CXXFLAGS&quot;])
      if eval test x\$$cachevar = xyes; then
        CXXFLAGS=&quot;$CXXFLAGS $switch&quot;
        ac_success=yes
        break
      fi
    done
  fi])
  AC_LANG_POP([C++])
  if test x$ax_cxx_compile_cxx11_required = xtrue; then
    if test x$ac_success = xno; then
      AC_MSG_ERROR([*** A compiler with support for C++11 language features is required.])
    fi
  else
    if test x$ac_success = xno; then
      HAVE_CXX11=0
      AC_MSG_NOTICE([No compiler with C++11 support was found])
    else
      HAVE_CXX11=1
      AC_DEFINE(HAVE_CXX11,1,
                [define if the compiler supports basic C++11 syntax])
    fi

    AC_SUBST(HAVE_CXX11)
  fi
])
</code></pre></noscript></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HDF5 on Windows: UTF-8 filenames support]]></title>
    <link href="http://yeangpeng.tech/blog/2014/11/07/hdf5-on-windows-utf-8-filenames-support/"/>
    <updated>2014-11-07T02:10:35+08:00</updated>
    <id>http://yeangpeng.tech/blog/2014/11/07/hdf5-on-windows-utf-8-filenames-support</id>
    <content type="html"><![CDATA[<p>In a previous <a href="http://tschoonj.github.io/blog/2014/01/29/building-a-64-bit-version-of-hdf5-with-mingw-w64/">post</a>, I have detailed my efforts in getting HDF5 compiled on Windows 64-bit using the MinGW-w64 compiler, which is currently (still) unsupported by the HDF5 developers. Now, I am reporting on yet another problem I encountered with HDF5 on Windows, that is blatantly being ignored by the developers: UTF-8 filename support.</p>

<p>This was brought to my attention by a Japanese user of my software package <a href="http://github.com/tschoonj/xmimsim">XMI-MSIM</a>, who ran into trouble running the program when logged in with a username consisting of Japanese characters. The problem could be traced back to an HDF5 file that has to be opened, which is located in a subdirectory of the user&rsquo;s homedirectory. After investigating the HDF5 code, it became quite clear that this issue is caused by the internal use of the <a href="http://msdn.microsoft.com/en-us/library/z0kc8e3z.aspx"><code>_open</code> function</a>, which is known not to support the Unicode UTF-8 characterset, necessary to represent the Japanese characters. The HDF5 website confirmed this issue with the following statement:</p>

<!--more-->




<blockquote><p>Linux, Unix, and similar systems generally handle UTF-8 encodings in correct and predictable ways. There is an apparent consensus in the Linux community that "UTF-8 is just the right way to go."<br/>Mac OS systems generally handle UTF-8 encodings correctly.</p><p>Windows systems use a different Unicode encoding, UCS-2 (discussed in this UTF-16 article) at the system level. Within an HDF5 file and application on a Windows system, UTF-8 encoding should work correctly and as expected. Problems may arise, however, when that UTF-8 encoding is exposed directly to the Windows system. For example:</p><p>File open and close calls on files with UTF-8 encoded names are likely to fail as the HDF5 open and close operations interact directly with the Windows file system interface.<br/>Anytime an HDF5 command-line utility (h5ls or h5dump, for example) emits text output, the Windows system must interpret the character encodings. If that output is UTF-8 encoded, Windows will correctly interpret only those characters in the ASCII subset of UTF-8.</p><footer><strong>HDF5 documentation</strong> <cite><a href='http://www.hdfgroup.org/HDF5/doc/Advanced/UsingUnicode/'>www.hdfgroup.org/HDF5/doc/&hellip;</a></cite></footer></blockquote>


<p>So basically I was stuck here since there is no way to convert a filename in UTF-8 encoding to the UCS encoding that was expected by <code>_open</code>. <a href="http://stackoverflow.com/questions/23285759/fopen-file-name-with-utf8-string-in-windows">A solution</a> which would have converted the filename to the corresponding short form (8 character filename with 3 character extension) using <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa364989%28v=vs.85%29.aspx"><code>GetShortPathName</code></a> seemed like a very ugly hack and decided not to pursue it. Instead I opted to hack the HDF5 code myself and replace all instances of <code>_open</code> with its wide char counterparts, that could be fed the UTF-8 filenames after converting them with <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd319072.aspx"><code>MultiByteToWideChar</code></a>.</p>

<p>Fortunately, it turned out that I was not the first one who ran into this situation and found a better solution on the <a href="http://mail.lists.hdfgroup.org/pipermail/hdf-forum_lists.hdfgroup.org/2014-August/007988.html">HDF5 forums</a>. Essentially the solution consists of redefining the <code>HDopen</code> macro from <code>_open</code> to a function of our own that converts our filename in UTF-8 encoding to the corresponding wide char representation and feed it to <code>_wopen</code>. Since we are compiling with MinGW-w64, some other modifications were necessary (the original solution relied on CMake): the src/Makefile.am file was modified in order to compile also the H5FDwindows.c and H5FDwindows.h, the latter being added to the public headers. After running <code>autoreconf -i -f</code> (I had to downgrade the required autoconf version in configure.ac for this to work, but this didn&rsquo;t create any problems), and running the configure script, I modified the src/H5pubconf.h file according to my <a href="http://tschoonj.github.io/blog/2014/01/29/building-a-64-bit-version-of-hdf5-with-mingw-w64/">earlier post</a>, but had to add one more line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//fixes first problem</span>
</span><span class='line'><span class="cp">#ifndef H5_HAVE_WIN32_API</span>
</span><span class='line'><span class="cp">#ifdef WIN32 </span><span class="cm">/* defined for all windows systems */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define H5_HAVE_WIN32_API 1</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef H5_HAVE_MINGW</span>
</span><span class='line'><span class="cp">#ifdef __MINGW32__ </span><span class="cm">/*defined for all MinGW compilers */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define H5_HAVE_MINGW 1</span>
</span><span class='line'><span class="c1">//additional line necessary for UTF-8 build to succeed</span>
</span><span class='line'><span class="cp">#define H5_HAVE_WINDOWS 1</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//fixes second problem</span>
</span><span class='line'><span class="cp">#define H5_BUILT_AS_DYNAMIC_LIB 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Keep in mind that this file is recreated after running configure, so these modifications will have to be repeated!!!</p>

<p>This solution is not pretty, and it will have to be repeated every time you compile a new version of HDF5. Ideally, the HDF5 developers would implement a solution based on this hack, which would bring it in line with most other open-source projects that assume UTF-8 filenames on all platforms. I doubt this will happen anytime soon though, since the original solution posted on the HDF5 forums has not been commented on by any of the developers&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Gtk2 64-bit Windows Runtime Environment Installer: now on GitHub!]]></title>
    <link href="http://yeangpeng.tech/blog/2014/09/29/gtk2-64-bit-windows-runtime-environment-installer-now-on-github/"/>
    <updated>2014-09-29T19:33:58+08:00</updated>
    <id>http://yeangpeng.tech/blog/2014/09/29/gtk2-64-bit-windows-runtime-environment-installer-now-on-github</id>
    <content type="html"><![CDATA[<p>As predicted in my <a href="http://tschoonj.github.io/blog/2014/02/08/gtk2-64-bit-windows-runtime-environment-installer/">first post</a> on the Gtk2 64-bit Windows Runtime Environment Installer, I have indeed ventured into compiling Gtk (2.24.24) and all its dependencies, mainly because I was getting increasingly unhappy with the old Gtk 2.22.1 based bundle that <a href="http://www.gtk.org/download/win64.php">is being distributed</a> by the Gtk project. It was in fact this very bundle that I was using to generate the installer I announced in my first post on this subject.</p>

<p>So, after spending about 10 hours of compiling (and recompiling a couple of times when I didn&rsquo;t get the configure options right) of more than a dozen software packages, I ended up with a fully working (at least until now&hellip;) collection of DLLs. I updated the code from my initial installer to include the new DLLs and uploaded the new installer <a href="http://lvserver.ugent.be/gtk-win64/">here</a>. I also uploaded a zip-file (sdk) containing all executables, DLLs, linking libraries (.dll.a) and headers, that can be used by anyone not willing to replicate my compilation effort. In fact I recommend that people using this installer to distribute the Gtk runtime along with their own program, to compile and link against this sdk, in order to avoid any link issues at runtime&hellip;</p>

<p>You may notice that I did not use the exact same dependencies in my compilation stack as those offered by the official Gtk bundle. I followed the <a href="http://hexchat.github.io/gtk-win32/">Hexchat flowchart</a> and ended up with additional dependencies of libffi and harfbuzz. libexpat was replaced by libxml2. This explains why the new installer is considerably larger than the previous one.</p>

<p>Last but not least, I forked the original repository of the installer from <a href="http://sourceforge.net/projects/gtk-win/">its sourceforge</a> repository and created my own personal copy on <a href="https://github.com/tschoonj/GTK-for-Windows-Runtime-Environment-Installer">GitHub</a>. Check the README file for more information.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building a CUDA device function library with autotools]]></title>
    <link href="http://yeangpeng.tech/blog/2014/05/10/building-a-cuda-device-function-library-with-autotools/"/>
    <updated>2014-05-10T21:08:11+08:00</updated>
    <id>http://yeangpeng.tech/blog/2014/05/10/building-a-cuda-device-function-library-with-autotools</id>
    <content type="html"><![CDATA[<p>I have recently started a new development branch in my <a href="http://github.com/tschoonj/xraylib">xraylib</a> project, where I will gradually be adding support for <a href="https://developer.nvidia.com/about-cuda">nVidia&rsquo;s CUDA platform</a>. Essentially the goal is to create a library containing CUDA device function equivalents of most functions that are currently offered by xraylib. Since there is not really much point to include functions that deal with strings, I will be leaving those out.</p>

<p>Compiling such a library has been supported by nVidia since CUDA version 5.5, but for some reason I never got their examples working. However, their recent 6.0 release seems to have fixed things (at least for me). In this post I will share some of the tricks I had to come up with to generate such a library.</p>

<!--more-->


<h2>Adding configure CUDA support</h2>

<p>The configure script that I am using for xraylib allows the user to select which bindings to build. The script would then proceed with checking if all the necessary building dependencies are available on the system. I accomplished this using the <code>AX_CHECK_CUDA</code> m4 macro I found at <a href="http://wili.cc/blog/cuda-m4.html,">http://wili.cc/blog/cuda-m4.html,</a> of course with some modifications to suit my particular needs. Check the gist later in this post for the code.</p>

<p>Important here are the <code>NVCC</code>, <code>CUDA_CFLAGS</code>, <code>CUDA_LDFLAGS</code> and <code>CUDA_LIBDIR</code> variables that get defined and will be used in the Makefile.am&rsquo;s later on.</p>

<h2>Building the library</h2>

<p>Compiling CUDA code into a library and then linking this library into an executable is not a trivial task, which becomes clear after reading through the <a href="http://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/index.html#using-separate-compilation-in-cuda">CUDA documentation on separate compilation</a>.
First of all, we can only create static libraries.
This is not nearly as bad is at sounds: it will make the Makefile.am considerably simpler since we will be able to avoid using libtool this way. Libtool would really make things difficult here since we have to use the nvcc command with its non-standard options and have to define custom compilation rules for our source code files, at least assuming you follow the convention of giving your CUDA source files the .cu extension. In my case I ended up with this code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="nv">xraylibincludedir</span> <span class="o">=</span> <span class="k">${</span><span class="nv">includedir</span><span class="k">}</span>/xraylib
</span><span class='line'>
</span><span class='line'><span class="err">if</span> <span class="err">ENABLE_CUDA</span>
</span><span class='line'><span class="nv">lib_LIBRARIES</span><span class="o">=</span>libxrlcuda.a
</span><span class='line'><span class="nv">xraylibinclude_HEADERS</span> <span class="o">=</span> xraylib-cuda.h
</span><span class='line'><span class="nv">libxrlcuda_a_SOURCES</span> <span class="o">=</span> xraylib-cuda.cu xraylib-cuda.h <span class="se">\</span>
</span><span class='line'>             xraylib-cuda-private.h <span class="se">\</span>
</span><span class='line'>             atomiclevelwidth.cu <span class="se">\</span>
</span><span class='line'>             atomicweight.cu <span class="se">\</span>
</span><span class='line'>             auger_trans.cu <span class="se">\</span>
</span><span class='line'>             comptonprofiles.cu <span class="se">\</span>
</span><span class='line'>             coskron.cu <span class="se">\</span>
</span><span class='line'>             cross_sections.cu <span class="se">\</span>
</span><span class='line'>             densities.cu <span class="se">\</span>
</span><span class='line'>             edges.cu <span class="se">\</span>
</span><span class='line'>             <span class="k">fi</span>.cu <span class="se">\</span>
</span><span class='line'>             fii.cu <span class="se">\</span>
</span><span class='line'>             fluor_yield.cu <span class="se">\</span>
</span><span class='line'>             jump.cu <span class="se">\</span>
</span><span class='line'>             radrate.cu <span class="se">\</span>
</span><span class='line'>             scattering.cu <span class="se">\</span>
</span><span class='line'>             kissel_pe.cu <span class="se">\</span>
</span><span class='line'>             xrf_cross_sections_aux.cu <span class="se">\</span>
</span><span class='line'>             cs_line.cu <span class="se">\</span>
</span><span class='line'>             splint.cu <span class="se">\</span>
</span><span class='line'>             fluor_lines.cu <span class="se">\</span>
</span><span class='line'>             polarized.cu <span class="se">\</span>
</span><span class='line'>             cs_barns.cu
</span><span class='line'><span class="nv">libxrlcuda_a_CFLAGS</span> <span class="o">=</span> <span class="k">$(</span>CUDA_CFLAGS<span class="k">)</span> -I<span class="k">$(</span>top_srcdir<span class="k">)</span>/src -I<span class="k">$(</span>top_srcdir<span class="k">)</span>/include
</span><span class='line'><span class="nv">libxrlcuda_a_AR</span> <span class="o">=</span> <span class="k">$(</span>NVCC<span class="k">)</span> -arch<span class="o">=</span>sm_20 -lib -o
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nf">.cu.o</span><span class="o">:</span> <span class="n">xraylib</span>-<span class="n">cuda</span>.<span class="n">h</span> <span class="n">xraylib</span>-<span class="n">cuda</span>-<span class="n">private</span>.<span class="n">h</span>
</span><span class='line'>  <span class="k">$(</span>NVCC<span class="k">)</span> <span class="k">$(</span>libxrlcuda_a_CFLAGS<span class="k">)</span> -arch<span class="o">=</span>sm_20 -dc -o <span class="nv">$@</span> <span class="nv">$&lt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note how I disabled libtool here: I included the <code>lib_LIBRARIES</code> variable instead of <code>lib_LTLIBRARIES</code>. This two letter difference will ensure that libtool is not being used!
Two other things really set this file apart from typical Makefile.am&rsquo;s:</p>

<ol>
<li><code>libxrlcuda_a_AR = $(NVCC) -arch=sm_20 -lib -o</code>: I am overriding the default archiver here to ensure that both the device and the host functions end up in the static library. The regular archiver (<code>ar</code>) would have ignored the device functions.</li>
<li>The rule for building the CUDA source code: automake has no idea what to do with the .cu files. Enters the suffix rule:</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="nf">.cu.o</span><span class="o">:</span> <span class="n">xraylib</span>-<span class="n">cuda</span>.<span class="n">h</span> <span class="n">xraylib</span>-<span class="n">cuda</span>-<span class="n">private</span>.<span class="n">h</span>
</span><span class='line'>  <span class="k">$(</span>NVCC<span class="k">)</span> <span class="k">$(</span>libxrlcuda_a_CFLAGS<span class="k">)</span> -arch<span class="o">=</span>sm_20 -dc -o <span class="nv">$@</span> <span class="nv">$&lt;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Here, the <code>-dc</code> option ensures that both device and host code will get compiled into the objects.</p>

<h2>Linking an executable with the library</h2>

<p>xraylib contains an example folder with a Makefile.am that will handle the compilation and running of the examples whenever <code>make check</code> is invoked after successful building of the core library and its bindings. The example contains both device (CUDA kernels that use the device functions) as well as host code to launch the kernels and handle the I/O with the GPU.
Here are the relevant sections of this file that deal with the cuda bindings example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="err">if</span> <span class="err">ENABLE_CUDA</span>
</span><span class='line'>  <span class="nv">check_PROGRAMS</span> <span class="o">+=</span> xrlexample11
</span><span class='line'><span class="cp">endif</span>
</span><span class='line'>
</span><span class='line'><span class="err">if</span> <span class="err">ENABLE_CUDA</span>
</span><span class='line'>  <span class="nv">xrlexample11_SOURCES</span> <span class="o">=</span> xrlexample11.cu
</span><span class='line'>  <span class="nv">xrlexample11_LDADD</span> <span class="o">=</span> xrlcudalink.o ../src/libxrl.la  <span class="k">$(</span>CUDA_LDFLAGS<span class="k">)</span> ../cuda/libxrlcuda.a -lcudart
</span><span class='line'>  <span class="nv">xrlexample11_CFLAGS</span> <span class="o">=</span> -I<span class="k">${</span><span class="nv">top_srcdir</span><span class="k">}</span>/include -I<span class="k">${</span><span class="nv">top_builddir</span><span class="k">}</span>/include -I<span class="k">${</span><span class="nv">top_srcdir</span><span class="k">}</span>/cuda -I<span class="k">${</span><span class="nv">top_srcdir</span><span class="k">}</span>/src
</span><span class='line'>  <span class="nv">TESTS_ENVIRONMENT</span> <span class="o">=</span> <span class="nv">DYLD_LIBRARY_PATH</span><span class="o">=</span><span class="s2">&quot;$(CUDA_LIBDIR)&quot;</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s2">&quot;$(CUDA_LIBDIR)&quot;</span>
</span><span class='line'><span class="cp">endif</span>
</span><span class='line'>
</span><span class='line'><span class="nf">.cu.o</span><span class="o">:</span> ../<span class="n">cuda</span>/<span class="n">libxrlcuda</span>.<span class="n">a</span>
</span><span class='line'>  <span class="k">$(</span>NVCC<span class="k">)</span> <span class="k">$(</span>xrlexample11_CFLAGS<span class="k">)</span> -arch<span class="o">=</span>sm_20 -dc -o <span class="nv">$@</span> <span class="nv">$&lt;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">xrlcudalink.o</span><span class="o">:</span> <span class="n">xrlexample</span>11.<span class="n">o</span> ../<span class="n">cuda</span>/<span class="n">libxrlcuda</span>.<span class="n">a</span>
</span><span class='line'>  <span class="k">$(</span>NVCC<span class="k">)</span> -arch<span class="o">=</span>sm_20 -dlink xrlexample11.o ../cuda/libxrlcuda.a -o xrlcudalink.o
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s quite similar to the Makefile.am for the static library: the exact same build rule is required to compile the CUDA source code. Interesting is the <code>xrlcudalink.o</code> build rule which turns out to be essential to link the device code in the example with the device code in the library. The resulting file after linking needs to be added to the <code>LDADD</code> command to ensure it ends up in the eventual executable. I am not overriding the linker here, so the default one will be used which is just fine.</p>

<p>I have tested this on Mac OS X Mavericks and Linux Centos 6.5, both with CUDA 6.0 installed. Soon I will also give this a try on Windows 7, so expect an update soon.</p>

<div><script src='https://gist.github.com/a3b1c346d1cef1cf2a23.js'></script>
<noscript><pre><code>##### 
#
# SYNOPSIS
#
# AX_CHECK_CUDA
#
# DESCRIPTION
#
# Figures out if CUDA Driver API/nvcc is available, i.e. existence of:
#   cuda.h
#   libcuda.so
#   nvcc
#
# If something isn&#39;t found, fails straight away.
#
# Locations of these are included in 
#   CUDA_CFLAGS and 
#   CUDA_LDFLAGS.
# Path to nvcc is included as
#   NVCC_PATH
# in config.h
# 
# The author is personally using CUDA such that the .cu code is generated
# at runtime, so don&#39;t expect any automake magic to exist for compile time
# compilation of .cu files.
#
# LICENCE
# Public domain
#
# AUTHOR
# wili
#
##### 

AC_DEFUN([AX_CHECK_CUDA], [

# Provide your CUDA path with this      
AC_ARG_WITH(cuda, [  --with-cuda=PREFIX      Prefix of your CUDA installation], [cuda_prefix=$withval], [cuda_prefix=&quot;/usr/local/cuda&quot;])

# Setting the prefix to the default if only --with-cuda was given
if test &quot;$cuda_prefix&quot; == &quot;yes&quot;; then
    if test &quot;$withval&quot; == &quot;yes&quot;; then
        cuda_prefix=&quot;/usr/local/cuda&quot;
    fi
fi

# Checking for nvcc
AC_MSG_CHECKING([nvcc in $cuda_prefix/bin])
if test -x &quot;$cuda_prefix/bin/nvcc&quot;; then
    AC_MSG_RESULT([found])
    AC_DEFINE_UNQUOTED([NVCC_PATH], [&quot;$cuda_prefix/bin/nvcc&quot;], [Path to nvcc binary])
    # We need to add the CUDA search directories for header and lib searches

    CUDA_CFLAGS=&quot;&quot;

    # Saving the current flags
    ax_save_CFLAGS=&quot;${CFLAGS}&quot;
    ax_save_LDFLAGS=&quot;${LDFLAGS}&quot;

    # Announcing the new variables
    AC_SUBST([CUDA_CFLAGS])
    AC_SUBST([CUDA_LDFLAGS])
    AC_SUBST([NVCC],[$cuda_prefix/bin/nvcc])
    AC_CHECK_FILE([$cuda_prefix/lib64],[lib64_found=yes],[lib64_found=no])
    if test &quot;x$lib64_found&quot; = xno ; then
        AC_CHECK_FILE([$cuda_prefix/lib],[lib32_found=yes],[lib32_found=no])
        if test &quot;x$lib32_found&quot; = xyes ; then
            AC_SUBST([CUDA_LIBDIR],[$cuda_prefix/lib])
        else
            AC_MSG_WARN([Couldn&#39;t find cuda lib directory])
            VALID_CUDA=no
        fi
    else
        AC_CHECK_SIZEOF([long])
        if test &quot;x$ac_cv_sizeof_long&quot; = &quot;x8&quot; ; then
            AC_SUBST([CUDA_LIBDIR],[$cuda_prefix/lib64])
            CUDA_CFLAGS+=&quot; -m64&quot;
        elif test &quot;x$ac_cv_sizeof_long&quot; = &quot;x4&quot; ; then
            AC_CHECK_FILE([$cuda_prefix/lib32],[lib32_found=yes],[lib32_found=no])
            if test &quot;x$lib32_found&quot; = xyes ; then
                AC_SUBST([CUDA_LIBDIR],[$cuda_prefix/lib])
                CUDA_CFLAGS+=&quot; -m32&quot;
            else
                AC_MSG_WARN([Couldn&#39;t find cuda lib directory])
                VALID_CUDA=no
            fi
        else
            AC_MSG_ERROR([Could not determine size of long variable type])
        fi
    fi

    if test &quot;x$VALID_CUDA&quot; != xno ; then
        CUDA_CFLAGS+=&quot; -I$cuda_prefix/include&quot;
        CFLAGS=&quot;$CUDA_CFLAGS $CFLAGS&quot;
        CUDA_LDFLAGS=&quot;-L$CUDA_LIBDIR&quot;
        LDFLAGS=&quot;$CUDA_LDFLAGS $LDFLAGS&quot;

        # And the header and the lib
        AC_CHECK_HEADER([cuda.h], [],
            AC_MSG_WARN([Couldn&#39;t find cuda.h])
            VALID_CUDA=no
            ,[#include &lt;cuda.h&gt;])
        if test &quot;x$VALID_CUDA&quot; != &quot;xno&quot; ; then
            AC_CHECK_LIB([cuda], [cuInit], [VALID_CUDA=yes], AC_MSG_WARN([Couldn&#39;t find libcuda]
            VALID_CUDA=no))
        fi
    fi
    # Returning to the original flags
    CFLAGS=${ax_save_CFLAGS}
    LDFLAGS=${ax_save_LDFLAGS}
else
    AC_MSG_RESULT([not found!])
    AC_MSG_WARN([nvcc was not found in $cuda_prefix/bin])
    VALID_CUDA=no
fi

if test &quot;x$enable_cuda&quot; = xyes &amp;&amp; test x$VALID_CUDA = xyes ; then 
    AC_MSG_NOTICE([Building with CUDA bindings])
elif test &quot;x$enable_cuda&quot; = xyes &amp;&amp; test x$VALID_CUDA = xno ; then 
    AC_MSG_ERROR([Cannot build CUDA bindings. Check errors])
fi


])</code></pre></noscript></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jvm调优]]></title>
    <link href="http://yeangpeng.tech/blog/2014/02/17/jvm/"/>
    <updated>2014-02-17T14:52:27+08:00</updated>
    <id>http://yeangpeng.tech/blog/2014/02/17/jvm</id>
    <content type="html"><![CDATA[<p><strong>首先看下jvm的常用设置参数</strong></p>

<ol>
<li>栈设置 <br/>
<code>-Xss:</code>调整栈大小</li>
<li>堆设置<br/>
<code>-Xms：</code>初始堆大小<br/>
<code>-Xmx：</code>最大堆大小<br/>
<code>-Xmn：</code>设置年轻代大小 <br/>
<code>-XX:NewRatio=n:</code>设置年轻代和老年代的比值。<br/>
<code>-XX:SurvivorRation=n</code>年轻代中Eden区与两个Suvivor区的比值。注意Survivor区中有两个。如3，表示Eden:Survivor=3:2,一个Survivor区占整个年轻代的1/5<br/>
<code>-XX:MaxTenuringThreshold=0:</code>设置垃圾最大年龄，如果设置为0的话，则年轻代对象不经过Survivor区，直接进入老年代。，对于老年代比较多的应用，可以提高效率<br/>
<code>-XX:HeapDumpOnOutOfMemoryError</code> OOM时导出堆到文件<br/>
<code>-XX:HeapDumpPath</code> 导出OOM的路径<br/>
<code>-XX:OnOutOfMemoryError</code> 在OOM时，执行一个脚本</li>
<li>永久区设置<br/>
<code>-XX:PermSize</code><br/>
<code>-XX:MaxPermSize</code></li>
<li>收集器设置 <br/>
<code>-XX:+UseSerialGC:</code>设置串行收集器 新生代使用复制算法，老年代使用标记压缩算法<br/>
<code>-XX:+UseParalledlGC:</code>设置并行收集器 老年代依然使用串行回收<br/>
<code>-XX:+UseParalledlOldGC:</code>设置并行年老代收集器<br/>
<code>-XX:+UseConcMarkSweepGC:</code>设置并发收集器 在老年代应用 使用标记-清除算法，新生代会使用并行回收器

<ul>
<li>并行收集器设置<br/>
<code>-XX:ParallelGCTheads=n:</code>设置并行收集器收集是使用的CPU数。并行收集线程数<br/>
<code>-XX:MaxGCPauseMillis=n:</code>设置并行收集最大暂停时间<br/>
<code>-XX:GCTimeRatio=n:</code>设置垃圾回收时间占程序运行时间的百分比。公式为1/(1+n)</li>
<li>并发收集器设置<br/>
<code>-XX:GMSFullGCsBeforeCompaction:</code>此值设置运行多少次GC以后对内存空间进行压缩、整理<br/>
<code>-XX:+UseCMSCompactAtFullCollection</code> 打开老年代压缩，可能会影响性能，但是可以消除碎片<br/>
<code>-XX:+CMSInitiatingOccupancyFraction</code> 设置触发GC的阀值，对堆空间占用大小<br/>
<code>-XX:ParallelCMSThreads</code> 设定CMS的线程数量，一般为可用CPU数量<br/>
<code>-XX:+CMSClassUnloadingEnabled</code> 允许对类元数据进行回收<br/>
<code>-XX:CMSInitiatingPermOccupancyFraction：</code>当永久区占用率达到这一百分比时，启动CMS回收<br/>
<code>-XX:UseCMSInitiatingOccupancyOnly：</code>表示只在到达阀值的时候，才进行CMS回收</li>
</ul>
</li>
<li>垃圾回收统计信息<br/>
<code>-XX:+PrintGC</code> 打印GC信息<br/>
<code>-XX:+PrintGCDetails</code> 打印GC详细信息<br/>
<code>-XX:+PrintGCTimeStamps</code> 打印时间戳<br/>
<code>-XX:+PrintHeapAtGC</code> 每一次GC以后，都打印堆信息<br/>
<code>-XX:+TraceClassLoading</code> 监控类加载<br/>
<code>-XX:+PrintClassHistogram</code> 按下Ctrl+Break后，打印所有类信息<br/>
<code>-Xloggc:filename</code></li>
<li>锁设置

<ul>
<li>偏向锁<br/>
<code>-XX:+UseBiasedLocking</code>  –jdk1.6 默认启用 在竞争激烈的场合，偏向锁会增加系统负担
只要没有竞争，获得偏向锁的线程，在将来进入同步块，不需要做同步
当其他线程请求相同的锁时，偏向模式结束<br/>
<code>-XX:BiasedLockingStartupDelay=0</code> 偏向锁开启时间<br/>
<code>-XX:-UseBiasedLocking</code> 移除偏向锁</li>
<li>轻量锁<br/>
如果轻量级锁失败，表示存在竞争，升级为重量级锁（常规锁），在没有锁竞争的前提下，减少传统锁使用OS互斥量产生的性能损耗，在竞争激烈时，轻量级锁会多做很多额外操作，导致性能下降</li>
<li>自旋锁<br/>
当竞争存在时，如果线程可以很快获得锁，那么可以不在OS层挂起线程，让线程做几个空操作（自旋）
JDK1.6中-XX:+UseSpinning开启
JDK1.7中，去掉此参数，改为内置实现
如果同步块很长，自旋失败，会降低系统性能
如果同步块很短，自旋成功，节省线程挂起切换时间，提升系统性能</li>
<li>内置于JVM中的获取锁的优化方法和获取锁的步骤<br/>
–偏向锁可用会先尝试偏向锁
–轻量级锁可用会先尝试轻量级锁
–以上都失败，尝试自旋锁
–再失败，尝试普通锁，使用OS互斥量在操作系统层挂起</li>
</ul>
</li>
</ol>


<p><strong>下面看下常用设置经验</strong></p>

<!-- more -->


<ul>
<li><p>堆大小设置经验<br/>
初始堆和最大堆设置为一样<br/>
最大不超过4G<br/>
年轻代推荐为整个堆的3/8<br/>
幸存代占新生代的1/10</p></li>
<li><p>栈大小设置经验<br/>
默认每个线程的堆栈大小为1M，在相同物理内存下，减小整个值能生成更多的线程。但操作系统对一个进程能的线程数还是有限制的，不能无限生成，经验值在3000-5000左右</p></li>
<li><p>回收器选择<br/>
JVM会根据当前系统进行判断<br/>
吞吐量优先的并行收集器，使用与科学计算和后台处理<br/>
响应时间优先的并发收集器，保证系统的响应时间，减少牢记收集时的停顿时间，由于并发收集器不对内存空间进行压缩、整理，所以运行一段时间以后产生碎片，使得运行效率降低.</p></li>
<li><p>锁优化<br/>
1.减少锁持有时间，对不需要锁的的代码不加锁<br/>
2.减小锁粒度 <br/>
3.锁分离 读写分离 LinkedBlockingQueue<br/>
4.锁粗化 避免频繁获得释放锁<br/>
5.锁消除  -XX:+DoEscapeAnalysis 逃逸分析  -XX:+EliminateLocks 锁消除<br/>
6.无锁 <br/>
  6.1 CAS(Compare And Swap)，非阻塞的同步 比较交换<br/>
  6.2 在应用层面判断多线程的干扰，如果有干扰，则通知线程重试，java.util.concurrent.atomic包使用无锁实现，性能高于一般的有锁操作</p></li>
</ul>


<p><strong>Jvm常见问题：</strong><br/>
1.年老代内存泄露
由集合对象引起</p>

<p>2.持久代被占满
常由大量反射加载造成</p>

<p>3.栈溢出
递归循环调用</p>

<p>4.系统内存被占满
没有足够的资源来产生这个线程造成</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Gtk2 64-bit Windows Runtime Environment Installer]]></title>
    <link href="http://yeangpeng.tech/blog/2014/02/08/gtk2-64-bit-windows-runtime-environment-installer/"/>
    <updated>2014-02-08T12:47:00+08:00</updated>
    <id>http://yeangpeng.tech/blog/2014/02/08/gtk2-64-bit-windows-runtime-environment-installer</id>
    <content type="html"><![CDATA[<p><strong>Update: this post has been largely superseded by <a href="http://tschoonj.github.io/blog/2014/09/29/gtk2-64-bit-windows-runtime-environment-installer-now-on-github">http://tschoonj.github.io/blog/2014/09/29/gtk2-64-bit-windows-runtime-environment-installer-now-on-github</a> </strong></p>

<p>As I already mentioned in my <a href="http://tschoonj.github.io/blog/2014/01/29/building-a-64-bit-version-of-hdf5-with-mingw-w64/">last post</a>, I have been busy compiling software with MinGW-w64 for the Windows 64-bit platform.f. One of the packages I rely on is <a href="http://www.gtk.org">Gtk+</a> (version 2 for now), and its many dependencies. Fortunately however, the <a href="http://www.gtk.org/download/win64.php">Gtk+ website</a> offers binaries for this architecture, so I didn&rsquo;t have to bother compiling them myself.</p>

<p>In the end I also managed to build all the other dependencies I needed for <a href="http://github.com/tschoonj/xmimsim">XMI-MSIM</a>, so the last step for me was to update my <a href="http://nsis.sourceforge.net/Main_Page">NSIS</a> installer for Windows 64-bit machines. It didn&rsquo;t take long for me to realize that one of the crucial components I install is the <a href="http://gtk-win.sourceforge.net/home/">Gtk Windows Runtime Environment Installer</a>, which really facilitates installing Gtk+ based applications. Unfortunately, Alexander Shaduri, the developer only distributes a 32-bit version of this package, and he has assured me through some emailing that he had no plans to write a 64-bit version due to <a href="http://www.gtk.org/download/win64.php">the experimental nature</a> of the packages that are produced by the Gtk+ people.</p>

<p>This being said, I still needed such an installer so I wrote one based on his NSIS script, using the official 64-bit Gtk+ packages for Windows 64-bit. The only major change I introduced was dropping support for the compatibility DLLs, which were redundant anyway. I am sharing the modified NSIS script as Github Gist so start hacking away at it. This script has some dependencies, apart from the DLLs, which are necessary to build the installer. Since I didn&rsquo;t change them at all, use the files that the original developer is sharing on <a href="http://sourceforge.net/p/gtk-win/code/HEAD/tree/">sourceforge</a>.</p>

<p>The installer itself can be obtained <a href="http://lvserver.ugent.be/gtk-win64/">here</a>. If you would like to see an example on how to use this installer from within your own NSIS script, have a look at e.g. <a href="https://github.com/tschoonj/xmimsim/blob/master/nsis/xmimsim-win64.nsi.in">my XMI-MSIM Windows 64-bit installer</a>.</p>

<!-- more -->


<p>The observant reader may have noticed that the version of Gtk+ that is included is 2.22.1, which is relatively old. In the future I may become sufficiently bold and adventurous, and end up compiling the latest Gtk+ 2.24.x version myself and releasing an updated installer. If this happens, I will update this blogpost&hellip;</p>

<div><script src='https://gist.github.com/8882727.js'></script>
<noscript><pre><code>
; NSIS2 Script for GTK2-Runtime
; by Alexander Shaduri &lt;ashaduri &#39;at&#39; gmail.com&gt;.
; Compatible with NSIS Unicode 2.45.
; Public Domain

; The naming convention is:
; Product: GTK2-Runtime;
; Directory and package names: gtk2-runtime.
; The reason for this is that when gtk3 comes out, it
; should be installable side by side with this package.


!define GTK_VERSION &quot;2.22.1&quot;
!define GTK_BIN_VERSION &quot;2.10.0&quot;
!define PRODUCT_VERSION &quot;${GTK_VERSION}-2014-02-01-ts-win64&quot;
!define PRODUCT_NAME &quot;GTK2-Runtime Win64&quot;
!define PRODUCT_PUBLISHER &quot;Tom Schoonjans&quot;
!define PRODUCT_WEB_SITE &quot;http://gtk-win.sourceforge.net&quot;
!define INSTALLER_OUTPUT_FILE &quot;gtk2-runtime-${PRODUCT_VERSION}.exe&quot;

;!define PRODUCT_DIR_REGKEY &quot;Software\Microsoft\Windows\CurrentVersion\App Paths\AppMainExe.exe&quot;
!define PRODUCT_UNINST_ROOT_KEY &quot;HKLM&quot;
!define PRODUCT_UNINST_KEY &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\${PRODUCT_NAME}&quot;

!define REGISTRY_APP_PATHS &quot;Software\Microsoft\Windows\CurrentVersion\App Paths&quot;


; AddToPath and friends should work with all users
!define ALL_USERS

!include nsi_env_var_update.nsh  ; EnvVar* functions
!include &quot;FileFunc.nsh&quot;  ; GetOptions
!include &quot;x64.nsh&quot;
!include &quot;LogicLib.nsh&quot;


; --------------- General Settings


; this is needed for proper start menu item manipulation (for all users) in vista
RequestExecutionLevel admin

; This compressor gives us the best results
SetCompressor /SOLID lzma

; Do a CRC check before installing
CRCCheck On

; This is used in titles
Name &quot;${PRODUCT_NAME}&quot;  ;  ${PRODUCT_VERSION}

; Output File Name
OutFile &quot;${INSTALLER_OUTPUT_FILE}&quot;


; The Default Installation Directory
InstallDir &quot;$PROGRAMFILES64\${PRODUCT_NAME}&quot;
;InstallDir &quot;$WINDIR&quot;
; Detect the old installation
InstallDirRegKey HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;&quot;
;InstallDirRegKey HKLM &quot;${PRODUCT_DIR_REGKEY}&quot; &quot;&quot;

ShowInstDetails show
ShowUnInstDetails show





; --------------------- MUI INTERFACE

; MUI 2.0 compatible install
!include &quot;MUI2.nsh&quot;
!include &quot;InstallOptions.nsh&quot;

; Icon &quot;gtk.ico&quot;
; UninstallIcon &quot;gtk.ico&quot;

; MUI Settings
!define MUI_ABORTWARNING
;!define MUI_ICON &quot;nsi_install.ico&quot;
!define MUI_ICON &quot;gtk.ico&quot;
;!define MUI_UNICON &quot;nsi_uninstall.ico&quot;
!define MUI_UNICON &quot;gtk.ico&quot;


; Things that need to be extracted on first (keep these lines before any File command!)
; Only useful for BZIP2 compression
ReserveFile &quot;nsi_pathpage.ini&quot;
ReserveFile &quot;nsi_configpage.ini&quot;
ReserveFile &quot;${NSISDIR}\Plugins\InstallOptions.dll&quot;


; Pages to show during installation
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE &quot;license.txt&quot;
!insertmacro MUI_PAGE_COMPONENTS
Page custom PathPage PathPageExit ; Custom page
!define MUI_PAGE_CUSTOMFUNCTION_LEAVE DirectoryPageExit
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES

;!define MUI_FINISHPAGE_RUN &quot;$INSTDIR\gtk2-runtime\gtk2_prefs.exe&quot;
;!define MUI_FINISHPAGE_SHOWREADME &quot;$INSTDIR\Example.file&quot;
;!define MUI_FINISHPAGE_RUN_NOTCHECKED
!define MUI_FINISHPAGE_NOAUTOCLOSE
;!define MUI_FINISHPAGE_NOREBOOTSUPPORT
!insertmacro MUI_PAGE_FINISH



; Uninstaller page
!insertmacro MUI_UNPAGE_CONFIRM
UninstPage custom un.DeleteConfig  ;Custom page
!insertmacro MUI_UNPAGE_INSTFILES




Function PathPage
    !insertmacro MUI_HEADER_TEXT &quot;$(TEXT_IO_TITLE)&quot; &quot;$(TEXT_IO_SUBTITLE)&quot;
    !insertmacro INSTALLOPTIONS_DISPLAY &quot;nsi_pathpage.ini&quot;
FunctionEnd


; Note: These options are unsupported unless the installer is launched in silent mode (/S).
; e.g. /setpath=no /dllpath=root /sideeffects=no
var install_option_setpath  ; set PATH: yes (default), no
var install_option_dllpath  ; bin (default), lib, root
var install_option_sideeffects  ; yes (default), no. no = don&#39;t write to registry, PATH or start menu.
var install_option_translations  ; install translations: yes, no (default)
var install_option_removeold  ; uninstall the old version first (if present): yes (default), no.

var LIB_INSTDIR
var DLL_DIR_NAME
var DLL_TMP


; Executed when leaving PathPage page.
; Sets DLL_DIR_NAME to dll directory name.
Function PathPageExit
    
    IfSilent dllpath_silent
        ; if not silent, show a page with radiobuttons
        !insertmacro INSTALLOPTIONS_READ $DLL_TMP &quot;nsi_pathpage.ini&quot; &quot;Field 3&quot; &quot;State&quot;
        StrCmp $DLL_TMP &quot;1&quot; goto_dll_bin
        !insertmacro INSTALLOPTIONS_READ $DLL_TMP &quot;nsi_pathpage.ini&quot; &quot;Field 4&quot; &quot;State&quot;
        StrCmp $DLL_TMP &quot;1&quot; goto_dll_lib
        !insertmacro INSTALLOPTIONS_READ $DLL_TMP &quot;nsi_pathpage.ini&quot; &quot;Field 5&quot; &quot;State&quot;
        StrCmp $DLL_TMP &quot;1&quot; goto_dll_none
        goto dllpath_exit
    dllpath_silent:
        ; if silent, use the /dllpath= option
        StrCmp $install_option_dllpath &quot;bin&quot; goto_dll_bin
        StrCmp $install_option_dllpath &quot;lib&quot; goto_dll_lib
        StrCmp $install_option_dllpath &quot;root&quot; goto_dll_none goto_dll_bin  ; default to bin if not matched
    dllpath_exit:

    goto_dll_none:
        StrCpy $DLL_DIR_NAME &quot;&quot;
        goto goto_dll_exit
    goto_dll_lib:
        StrCpy $DLL_DIR_NAME &quot;lib&quot;
        goto goto_dll_exit
    goto_dll_bin:
        StrCpy $DLL_DIR_NAME &quot;bin&quot;
        goto goto_dll_exit
    goto_dll_exit:

FunctionEnd


; Set $LIB_INSTDIR to &lt;instpath&gt;\bin, &lt;instpath&gt;\lib or &lt;instpath&gt;\ .
; Must be after the directory selection page.
Function DirectoryPageExit
    StrCpy $LIB_INSTDIR &quot;$INSTDIR&quot;
    StrCmp $DLL_DIR_NAME &quot;&quot; no_dll_append
        StrCpy $LIB_INSTDIR &quot;$INSTDIR\$DLL_DIR_NAME&quot;
    no_dll_append:
FunctionEnd



Function un.DeleteConfig
    ; !insertmacro MUI_HEADER_TEXT &quot;$(TEXT_IO_TITLE)&quot; &quot;$(TEXT_IO_SUBTITLE)&quot;
    !insertmacro INSTALLOPTIONS_DISPLAY &quot;nsi_configpage.ini&quot;
FunctionEnd



; Language files
!insertmacro MUI_LANGUAGE &quot;English&quot;


; --------------- END MUI



;Description
LangString DESC_SecCopyUI ${LANG_ENGLISH} &quot;GTK2 Runtime&quot;
LangString TEXT_IO_TITLE ${LANG_ENGLISH} &quot;GTK2 Runtime&quot;
LangString TEXT_IO_SUBTITLE ${LANG_ENGLISH} &quot;Additional options&quot;


;License page Introduction
;LicenseText &quot;You must agree to this license before installing.&quot;
;License text
;LicenseData /LANG=${LANG_ENGLISH} &quot;license.txt&quot;





; ----------------- INSTALLATION TYPES

InstType &quot;Recommended&quot;  ; 1
InstType &quot;Full&quot;  ; 2


var SEC_TRANSLATIONS_INSTALLED


Section &quot;GTK+ libraries (required)&quot; SecGTK
SectionIn 1 2 RO
    SetShellVarContext all  ; use all user variables as opposed to current user
    SetOverwrite On

    SetOutPath &quot;$LIB_INSTDIR&quot;

    ; NOTE: If you add or remove any of these,
    ; be sure to do the same in the uninstall section.

    File libfreetype-6.dll  ; freetype is needed for ft2 pango backend
    File libintl-8.dll  ; gettext, needed by all i18n libs
    File libatk-1.0-0.dll  ; atk
    File libcairo-2.dll  ; cairo, needed by gtk
    File libcairo-gobject-2.dll  ; cairo. Doesn&#39;t seem to be required, but since we&#39;re distributing cairo...
    File libcairo-script-interpreter-2.dll  ; cairo. Doesn&#39;t seem to be required, but since we&#39;re distributing cairo...
    File libexpat-1.dll  ; fontconfig needs this
    File libfontconfig-1.dll  ; fontconfig is needed for ft2 pango backend
    File libgailutil-18.dll  ; from gtk
    File libgdk_pixbuf-2.0-0.dll  ; from gtk
    File libgdk-win32-2.0-0.dll  ; from gtk
    File libgio-2.0-0.dll  ; from glib
    File libglib-2.0-0.dll  ; glib
    File libgmodule-2.0-0.dll  ; from glib
    File libgobject-2.0-0.dll  ; from glib
    File libgthread-2.0-0.dll  ; from glib
    File libgtk-win32-2.0-0.dll  ; gtk
    File libpango-1.0-0.dll  ; pango, needed by gtk
    File libpangocairo-1.0-0.dll  ; pango, needed by gtk
    File libpangoft2-1.0-0.dll  ; pango, needed by gtk
    File libpangowin32-1.0-0.dll  ; pango, needed by gtk
    File libpng14-14.dll  ; for gdk_pixbuf loader.
    File zlib1.dll  ; png and many others need this


    ; We install this into the same place as the DLLs to avoid any PATH manipulation.
    SetOutPath &quot;$LIB_INSTDIR&quot;
    File bin\fc-cache.exe
    File bin\fc-list.exe
    File bin\gdk-pixbuf-query-loaders.exe  ; from gdk_pixbuf
    File bin\gspawn-win64-helper.exe
    File bin\gspawn-win64-helper-console.exe
    File bin\gtk-query-immodules-2.0.exe
    File bin\gtk-update-icon-cache.exe
    File bin\gtk-update-icon-cache.exe.manifest
    File bin\pango-querymodules.exe
    
    
    SetOutPath &quot;$INSTDIR&quot;
    SetOverwrite off
    File /r etc  ; don&#39;t overwrite config files
    SetOverwrite On


    SetOutPath &quot;$INSTDIR\lib\gdk-pixbuf-2.0\${GTK_BIN_VERSION}&quot;
    File lib\gdk-pixbuf-2.0\${GTK_BIN_VERSION}\loaders.cache

    ; SetOutPath &quot;$INSTDIR\lib\gdk-pixbuf-2.0\${GTK_BIN_VERSION}\loaders&quot;
    ; File /r lib\gdk-pixbuf-2.0\${GTK_BIN_VERSION}\loaders

    SetOutPath &quot;$INSTDIR\lib\gtk-2.0\modules&quot;
    File /r lib\gtk-2.0\modules

    SetOutPath &quot;$INSTDIR\lib\gtk-2.0\${GTK_BIN_VERSION}&quot;
    ; no longer in gtk as of 2.14.5.
    ; File /r lib\gtk-2.0\${GTK_BIN_VERSION}\immodules
    ; gone as of gtk 2.16.6-2.
    ; File /r lib\gtk-2.0\${GTK_BIN_VERSION}\loaders

    ; wimp
    SetOutPath &quot;$INSTDIR\lib\gtk-2.0\${GTK_BIN_VERSION}\engines&quot;
    File lib\gtk-2.0\${GTK_BIN_VERSION}\engines\libwimp*.dll
    ; We install this, but other installers may not have it.
    File lib\gtk-2.0\${GTK_BIN_VERSION}\engines\libpixmap*.dll

    SetOutPath &quot;$INSTDIR\share\locale&quot;
    File share\locale\locale.alias  ; from gettext

    ; Default theme
    SetOutPath &quot;$INSTDIR\share\themes&quot;
    ; Why have two dirs with the same content? disable &quot;Default&quot;.
    ; File /r share\themes\Default
    File /r share\themes\Emacs
    File /r share\themes\MS-Windows
    File /r share\themes\Raleigh


    SetOutPath &quot;$INSTDIR\gtk2-runtime&quot;
    ; File gtk-postinstall.bat ; this file is generated now
    File license.txt
    File license_gpl.txt
    File license_lgpl.txt
    File license_jpeg.txt
    File license_png.txt
    File license_zlib.txt
    File gtk.ico  ; needed for &quot;add/remove programs&quot;


    ; this script updates some config files, but it&#39;s unsafe
    ; (gtk or pango may not work afterwards), so don&#39;t call it.
    Push $INSTDIR\gtk2-runtime\gtk-postinstall.bat
    Call WritePostInstall
    ; update pango.modules, not working for now
    ; Exec &#39;$INSTDIR\gtk2-runtime\gtk-postinstall.bat&#39;

SectionEnd ; end of gtk section





Section &quot;Translations&quot; SecTranslations
SectionIn 2
    SetShellVarContext all  ; use all user variables as opposed to current user
    StrCpy $SEC_TRANSLATIONS_INSTALLED &quot;1&quot;
    SetOutPath &quot;$INSTDIR&quot;
    SetOverwrite On

    ; SetOutPath &quot;$INSTDIR\lib&quot;
    ; File /r lib\locale

    ; gtk (beginning with 2.12.3) uses share\locale
    SetOutPath &quot;$INSTDIR\share&quot;
    File /r share\locale

SectionEnd



; Section descriptions
!insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
    !insertmacro MUI_DESCRIPTION_TEXT ${SecGTK} &quot;GTK+ 64-bit Runtime Libraries&quot;
    !insertmacro MUI_DESCRIPTION_TEXT ${SecTranslations} &quot;Additional translations (some are incomplete)&quot;
!insertmacro MUI_FUNCTION_DESCRIPTION_END




; Executed on installer run
Function .onInit
    SetShellVarContext all  ; use all user variables as opposed to current user
    ${IfNot} ${RunningX64} 
        MessageBox MB_OK|MB_ICONEXCLAMATION &quot;This installation requires a 64-bit Windows system&quot; /SD IDOK
        Abort
    ${EndIf}

    SetRegView 64
        
    

    !insertmacro INSTALLOPTIONS_EXTRACT &quot;nsi_pathpage.ini&quot;

    StrCpy $SEC_TRANSLATIONS_INSTALLED &quot;0&quot;  ; set to 1 in appropriate section

    ${GetOptions} &quot;$CMDLINE&quot; &quot;/setpath=&quot; $install_option_setpath
    ${GetOptions} &quot;$CMDLINE&quot; &quot;/dllpath=&quot; $install_option_dllpath
    ${GetOptions} &quot;$CMDLINE&quot; &quot;/sideeffects=&quot; $install_option_sideeffects
    ${GetOptions} &quot;$CMDLINE&quot; &quot;/translations=&quot; $install_option_translations
    ${GetOptions} &quot;$CMDLINE&quot; &quot;/removeold=&quot; $install_option_removeold

    ; Debug stuff
    ; MessageBox MB_ICONINFORMATION|MB_OK &quot;/setpath=$install_option_setpath \
    ;   /dllpath=$install_option_dllpath /sideeffects=$install_option_sideeffects \
    ;   INSTDIR: $INSTDIR&quot; /SD IDOK

    ; if we&#39;re using /sideeffects=no, set /setpath=no, because we can&#39;t
    ; revert it during uninstall (there&#39;s no dllpath in registry).
    StrCmp $install_option_sideeffects &quot;no&quot; &quot;&quot; init_sideeffects
        StrCpy $install_option_setpath &quot;no&quot;  ; set /setpath=no
        goto init_sideeffects_exit
    init_sideeffects:
        Call PreventMultipleInstances  ; in no-sideeffects mode this has no purpose
        Call DetectPrevInstallation  ; we don&#39;t want local installations to interfere with global ones.
    init_sideeffects_exit:


    ; enable translations if requested through command line
    StrCmp $install_option_translations &quot;yes&quot; &quot;&quot; no_translations
        push $R0
        SectionGetFlags ${SecTranslations} $R0
        IntOp $R0 $R0 | ${SF_SELECTED}
        SectionSetFlags ${SecTranslations} $R0
        pop $R0
    no_translations:

    ; Page callbacks are not called if in silent mode, so call these manually
    IfSilent &quot;&quot; +3
        Call PathPageExit
        Call DirectoryPageExit

FunctionEnd



; ------------------ POST INSTALL


var ADD_TO_PATH


Section -post
    SetShellVarContext all  ; use all user variables as opposed to current user

    IfSilent PATH_silent
        ; Read a value from an InstallOptions INI File
        !insertmacro INSTALLOPTIONS_READ $ADD_TO_PATH &quot;nsi_pathpage.ini&quot; &quot;Field 1&quot; &quot;State&quot;
        StrCmp $ADD_TO_PATH &quot;1&quot; goto_set_path_yes goto_set_path_no
        goto PATH_exit
    PATH_silent:
        ; if silent, use the /setpath= option
        StrCmp $install_option_setpath &quot;no&quot; goto_set_path_no goto_set_path_yes
    PATH_exit:


    goto_set_path_yes:
        ; The user requested to add the libdir to $PATH.
        StrCpy $ADD_TO_PATH &quot;1&quot;
        ; Push $LIB_INSTDIR
        ; Call AddToPath  ; add $LIB_INSTDIR to system $PATH
        Push $0  ; result PATH
        ${EnvVarUpdate} $0 &quot;PATH&quot; &quot;A&quot; &quot;HKLM&quot; &quot;$LIB_INSTDIR&quot; ; Append
        Pop $0
        ; MessageBox MB_ICONINFORMATION|MB_OK &quot;$LIB_INSTDIR added to path&quot;
        goto goto_set_path_exit
    goto_set_path_no:
        StrCpy $ADD_TO_PATH &quot;0&quot;
        goto goto_set_path_exit
    goto_set_path_exit:


    ; write out uninstaller
    WriteUninstaller &quot;$INSTDIR\gtk2_runtime_uninst.exe&quot;

    StrCmp $install_option_sideeffects &quot;no&quot; no_sideeffects
        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;InstallationDirectory&quot; &quot;$INSTDIR&quot;
        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;DllPath&quot; &quot;$LIB_INSTDIR&quot;
        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;Vendor&quot; &quot;${PRODUCT_PUBLISHER}&quot;
        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;PackageVersion&quot; &quot;${PRODUCT_VERSION}&quot;
        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;Version&quot; &quot;${GTK_VERSION}&quot;
        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;BinVersion&quot; &quot;${GTK_BIN_VERSION}&quot;

        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;DllDirName&quot; &quot;$DLL_DIR_NAME&quot;  ; lib, bin, or &quot;&quot;
        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;UsingSystemPath&quot; $ADD_TO_PATH
        WriteRegStr HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;TranslationsInstalled&quot; $SEC_TRANSLATIONS_INSTALLED

        ; compat with installer from http://gimp-win.sourceforge.net/
        WriteRegStr HKLM &quot;SOFTWARE\GTK\2.0&quot; &quot;Path&quot; &quot;$INSTDIR&quot;
        WriteRegStr HKLM &quot;SOFTWARE\GTK\2.0&quot; &quot;Version&quot; &quot;${GTK_VERSION}&quot;
        ; compat with Dropline&#39;s GTK
        WriteRegStr HKLM &quot;SOFTWARE\GTK\2.0&quot; &quot;DllPath&quot; &quot;$LIB_INSTDIR&quot;

        ; Information for the uninstall component in &quot;add/remove programs&quot;
        WriteRegStr HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;DisplayName&quot; &quot;${PRODUCT_NAME}&quot;
        WriteRegStr HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;UninstallString&quot; &quot;$INSTDIR\gtk2_runtime_uninst.exe&quot;
        WriteRegStr HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;InstallLocation&quot; &quot;$INSTDIR&quot;
        WriteRegStr HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;Publisher&quot; &quot;${PRODUCT_PUBLISHER}&quot;
        WriteRegStr HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;DisplayIcon&quot; &quot;$INSTDIR\gtk2-runtime\gtk.ico&quot;
        WriteRegStr HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;URLInfoAbout&quot; &quot;${PRODUCT_WEB_SITE}&quot;
        WriteRegStr HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;DisplayVersion&quot; &quot;${PRODUCT_VERSION}&quot;
        WriteRegDWORD HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;NoModify&quot; 1
        WriteRegDWORD HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;NoRepair&quot; 1

        ; uninstall shortcut
        CreateDirectory &quot;$SMPROGRAMS\GTK2 Runtime&quot;
        CreateShortCut &quot;$SMPROGRAMS\GTK2 Runtime\Uninstall GTK2 Runtime.lnk&quot; &quot;$INSTDIR\gtk2_runtime_uninst.exe&quot; &quot;&quot; &quot;&quot;
        WriteIniStr &quot;$SMPROGRAMS\GTK2 Runtime\Go to the website.url&quot; &quot;InternetShortcut&quot; &quot;URL&quot; &quot;${PRODUCT_WEB_SITE}&quot;


        ; Write $INSTDIR\gtk2-runtime\gtk2r-env.bat
        ; This script sets the GTK environment variables
        DetailPrint &quot;Generating $INSTDIR\gtk2-runtime\gtk2r-env.bat&quot;
        Push $INSTDIR\gtk2-runtime\gtk2r-env.bat
        Call WriteEnvBat
        DetailPrint &quot;Done&quot;

    no_sideeffects:

SectionEnd ; post





; ---------------- UNINSTALL


; Note: These options are unsupported unless the uninstaller is launched in silent mode (/S).
var uninstall_option_remove_config  ; yes, no (default).
var uninstall_option_sideeffects  ; yes (default), no. Use if it was installed with this option.
; These are used only if /sideffects=no :
var uninstall_option_dllpath  ; uninstall dlls from: bin (default), lib, root.
var uninstall_option_translations  ; uninstall translations: yes, no (default)


Function un.onInit
    SetRegView 64
    ${GetOptions} &quot;$CMDLINE&quot; &quot;/remove_config=&quot; $uninstall_option_remove_config
    ${GetOptions} &quot;$CMDLINE&quot; &quot;/sideeffects=&quot; $uninstall_option_sideeffects
    ${GetOptions} &quot;$CMDLINE&quot; &quot;/dllpath=&quot; $uninstall_option_dllpath
    ${GetOptions} &quot;$CMDLINE&quot; &quot;/translations=&quot; $uninstall_option_translations
FunctionEnd



Function un.onUninstSuccess
    HideWindow
    MessageBox MB_ICONINFORMATION|MB_OK &quot;$(^Name) was successfully removed from your computer.&quot; /SD IDOK
FunctionEnd




var leave_config  ; don&#39;t remove global gtk config (uninstall page option)
;var INST_DIR_REG  ; installation dir from registry (uninstall stage)


; This is a separate function to allow multiple calls to it
Function un.DeleteDlls
    SetShellVarContext all  ; use all user variables as opposed to current user

    StrCpy $LIB_INSTDIR &quot;$INSTDIR&quot;
    StrCmp $DLL_DIR_NAME &quot;&quot; un_no_dll_append
        StrCpy $LIB_INSTDIR &quot;$INSTDIR\$DLL_DIR_NAME&quot;
    un_no_dll_append:

    ; bin stuff (they are in the same directory)
    Delete $LIB_INSTDIR\fc-cache.exe
    Delete $LIB_INSTDIR\fc-list.exe
    Delete $LIB_INSTDIR\gdk-pixbuf-query-loaders.exe
    Delete $LIB_INSTDIR\gspawn-win64-helper.exe
    Delete $LIB_INSTDIR\gspawn-win64-helper-console.exe
    Delete $LIB_INSTDIR\gtk-query-immodules-2.0.exe
    Delete $LIB_INSTDIR\gtk-update-icon-cache.exe
    Delete $LIB_INSTDIR\gtk-update-icon-cache.exe.manifest
    Delete $LIB_INSTDIR\pango-querymodules.exe

    ; dlls
    Delete $LIB_INSTDIR\libfreetype-6.dll  ; freetype is needed for ft2 pango backend
    Delete $LIB_INSTDIR\libintl-8.dll  ; gettext, needed by all i18n libs
    Delete $LIB_INSTDIR\libatk-1.0-0.dll  ; atk
    Delete $LIB_INSTDIR\libcairo-2.dll  ; cairo, needed by gtk
    Delete $LIB_INSTDIR\libcairo-gobject-2.dll  ; cairo. Doesn&#39;t seem to be required, but since we&#39;re distributing cairo...
    Delete $LIB_INSTDIR\libcairo-script-interpreter-2.dll  ; cairo. Doesn&#39;t seem to be required, but since we&#39;re distributing cairo...
    Delete $LIB_INSTDIR\libexpat-1.dll  ; fontconfig needs this
    Delete $LIB_INSTDIR\libfontconfig-1.dll  ; fontconfig is needed for ft2 pango backend
    Delete $LIB_INSTDIR\libgailutil-18.dll  ; from gtk
    Delete $LIB_INSTDIR\libgdk_pixbuf-2.0-0.dll  ; from gtk
    Delete $LIB_INSTDIR\libgdk-win32-2.0-0.dll  ; from gtk
    Delete $LIB_INSTDIR\libgio-2.0-0.dll  ; from glib
    Delete $LIB_INSTDIR\libglib-2.0-0.dll  ; glib
    Delete $LIB_INSTDIR\libgmodule-2.0-0.dll  ; from glib
    Delete $LIB_INSTDIR\libgobject-2.0-0.dll  ; from glib
    Delete $LIB_INSTDIR\libgthread-2.0-0.dll  ; from glib
    Delete $LIB_INSTDIR\libgtk-win32-2.0-0.dll  ; gtk
    Delete $LIB_INSTDIR\libpango-1.0-0.dll  ; pango, needed by gtk
    Delete $LIB_INSTDIR\libpangocairo-1.0-0.dll  ; pango, needed by gtk
    Delete $LIB_INSTDIR\libpangoft2-1.0-0.dll  ; pango, needed by gtk
    Delete $LIB_INSTDIR\libpangowin32-1.0-0.dll  ; pango, needed by gtk
    Delete $LIB_INSTDIR\libpng14-14.dll  ; for gdk_pixbuf loader.
    Delete $LIB_INSTDIR\zlib1.dll  ; png and many others need this


FunctionEnd



var found_dir
var find_handle_lang_dir


Section Uninstall
    SetShellVarContext all  ; use all user variables as opposed to current user
    SetAutoClose false

    ; Note: Checking if there is a registry key present, and using it to determine
    ; if this is a private installation will not work, as it will break if a parallel
    ; shared installation is present.

    ; ReadRegStr $INST_DIR_REG HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;InstallationDirectory&quot;
    ; StrCmp $INST_DIR_REG &quot;&quot; uninst_no_sideeffects
    StrCmp $uninstall_option_sideeffects &quot;no&quot; uninst_no_sideeffects
        ; For PATH removal
        ReadRegStr $LIB_INSTDIR HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;DllPath&quot;
        ReadRegStr $DLL_DIR_NAME HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;DllDirName&quot;
        ReadRegStr $ADD_TO_PATH HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;UsingSystemPath&quot;
        ReadRegStr $SEC_TRANSLATIONS_INSTALLED HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot; &quot;TranslationsInstalled&quot;

        DeleteRegKey HKLM &quot;SOFTWARE\GTK\2.0&quot;  ; dropline, etc...
        DeleteRegKey /ifempty HKLM &quot;SOFTWARE\GTK&quot;  ; don&#39;t damage other installations

        DeleteRegKey HKLM &quot;SOFTWARE\${PRODUCT_NAME}&quot;
        DeleteRegKey HKLM &quot;${PRODUCT_UNINST_KEY}&quot;

        ; FIXME: Do we have this registry key?
        ; DeleteRegKey HKCU &quot;Software\${PRODUCT_NAME}&quot;

        Delete &quot;$SMPROGRAMS\GTK2 Runtime\Uninstall GTK2 Runtime.lnk&quot;
        Delete &quot;$SMPROGRAMS\GTK2 Runtime\Go to the website.url&quot;
        RMDir &quot;$SMPROGRAMS\GTK2 Runtime&quot;  ; only if empty, theme selector may still be there

        ; Remove GTK from $PATH
        StrCmp $ADD_TO_PATH &quot;0&quot; un_nopath  ; Setting $PATH was not requested during installation
        ; Push $LIB_INSTDIR
        ; Call un.RemoveFromPath
        Push $0  ; result PATH
        ${un.EnvVarUpdate} $0 &quot;PATH&quot; &quot;R&quot; &quot;HKLM&quot; &quot;$LIB_INSTDIR&quot; ; remove
        Pop $0
        ; MessageBox MB_OK &quot;$LIB_INSTDIR removed from PATH&quot; /SD IDOK
        un_nopath:

        ; $DLL_DIR_NAME is from the registry here
        Call un.DeleteDlls

        goto delete_dlls_exit


    uninst_no_sideeffects:


        Strcpy $SEC_TRANSLATIONS_INSTALLED &quot;0&quot;
        StrCmp $uninstall_option_translations &quot;yes&quot; &quot;&quot; nodelete_translations
            Strcpy $SEC_TRANSLATIONS_INSTALLED &quot;1&quot;
        nodelete_translations:


        ; All dll files. We delete them before /bin and /lib, so that
        ; the directories are empty afterwards.

        ; Since we have no registry, we have to remove dlls from all possible locations
        ; StrCpy $DLL_DIR_NAME &quot;&quot;
        ; Call un.DeleteDlls
        ; StrCpy $DLL_DIR_NAME &quot;bin&quot;
        ; Call un.DeleteDlls
        ; StrCpy $DLL_DIR_NAME &quot;lib&quot;
        ; Call un.DeleteDlls
        
        ; Force users to use the command-line argument instead:
        ; if silent, use the /dllpath= option
        StrCmp $uninstall_option_dllpath &quot;bin&quot; goto_undll_bin
        StrCmp $uninstall_option_dllpath &quot;lib&quot; goto_undll_lib
        StrCmp $uninstall_option_dllpath &quot;root&quot; goto_undll_none goto_undll_bin  ; default to bin if not matched

        goto_undll_none:
            StrCpy $DLL_DIR_NAME &quot;&quot;
            goto goto_undll_exit
        goto_undll_lib:
            StrCpy $DLL_DIR_NAME &quot;lib&quot;
            goto goto_undll_exit
        goto_undll_bin:
            StrCpy $DLL_DIR_NAME &quot;bin&quot;
            goto goto_undll_exit

        goto_undll_exit:
            Call un.DeleteDlls

    delete_dlls_exit:


    ; Delete config file?
    IfSilent &quot;&quot; read_config_page
        StrCmp $uninstall_option_remove_config &quot;yes&quot; delete_config skip_config

    read_config_page:
        !insertmacro INSTALLOPTIONS_READ $leave_config &quot;nsi_configpage.ini&quot; &quot;Field 1&quot; &quot;State&quot;
        StrCmp $leave_config &quot;1&quot; skip_config

    delete_config:
        Delete &quot;$INSTDIR\etc\gtk-2.0\gtkrc&quot;
    skip_config:


    Delete &quot;$INSTDIR\etc\fonts\fonts.conf&quot;
    RMDir &quot;$INSTDIR\etc\fonts&quot;  ; only if empty
    Delete &quot;$INSTDIR\etc\pango\pango.modules&quot;
    RMDir &quot;$INSTDIR\etc\pango&quot;  ; only if empty
    ; Delete &quot;$INSTDIR\etc\gtk-2.0\gdk-pixbuf.loaders&quot;
    Delete &quot;$INSTDIR\etc\gtk-2.0\gtk.immodules&quot;
    Delete &quot;$INSTDIR\etc\gtk-2.0\gtkrc.default&quot;
    Delete &quot;$INSTDIR\etc\gtk-2.0\im-multipress.conf&quot;
    RMDir &quot;$INSTDIR\etc\gtk-2.0&quot; ; only if empty
    RMDir &quot;$INSTDIR\etc&quot; ; only if empty

    ; some helper files here
    RMDir /r &quot;$INSTDIR\gtk2-runtime&quot;

    RMDir &quot;$INSTDIR\bin&quot;  ; only if empty

    ; RMDir /r &quot;$INSTDIR\lib&quot;
    ; pango modules are gone as of gtk 2.10
    ;  RMDir /r &quot;$INSTDIR\lib\pango&quot;
    
    Delete &quot;$INSTDIR\lib\gdk-pixbuf-2.0\${GTK_BIN_VERSION}\loaders.cache&quot;
    ; RMDir &quot;$INSTDIR\lib\gdk-pixbuf-2.0\${GTK_BIN_VERSION}\loaders&quot;  ; not forced
    RMDir &quot;$INSTDIR\lib\gdk-pixbuf-2.0\${GTK_BIN_VERSION}&quot;  ; not forced
    RMDir &quot;$INSTDIR\lib\gdk-pixbuf-2.0&quot;  ; not forced


    RMDir /r &quot;$INSTDIR\lib\gtk-2.0\modules&quot;

    ; no longer in gtk as of 2.14.5
    ; RMDir /r &quot;$INSTDIR\lib\gtk-2.0\${GTK_BIN_VERSION}\immodules&quot;
    ; gone as of gtk 2.16.6-2
    ;RMDir /r &quot;$INSTDIR\lib\gtk-2.0\${GTK_BIN_VERSION}\loaders&quot;

    Delete &quot;$INSTDIR\lib\gtk-2.0\${GTK_BIN_VERSION}\engines\libwimp*.dll&quot;
    ; there should be no problem deleting this
    Delete &quot;$INSTDIR\lib\gtk-2.0\${GTK_BIN_VERSION}\engines\libpixmap*.dll&quot;

    RMDir &quot;$INSTDIR\lib\gtk-2.0\${GTK_BIN_VERSION}\engines&quot;  ; not forced
    RMDir &quot;$INSTDIR\lib\gtk-2.0\${GTK_BIN_VERSION}&quot;  ; not forced
    RMDir &quot;$INSTDIR\lib\gtk-2.0&quot;  ; not forced

    RMDir &quot;$INSTDIR\lib&quot;  ; not forced

    Delete &quot;$INSTDIR\share\locale\locale.alias&quot;  ; gettext

    ; Remove our translations only
    StrCmp $SEC_TRANSLATIONS_INSTALLED &quot;1&quot; &quot;&quot; un_notranslations
        FindFirst $find_handle_lang_dir $found_dir &quot;$INSTDIR\share\locale\*&quot;
        find_lang_dir_next:
        ; DetailPrint &quot;LOC: $found_dir&quot;
        StrCmp $found_dir &quot;&quot; find_lang_dir_done
        ; check if it&#39;s a directory
        IfFileExists &quot;$INSTDIR\share\locale\$found_dir\*.*&quot; &quot;&quot; find_lang_dir_continue
        IfFileExists &quot;$INSTDIR\share\locale\$found_dir\LC_MESSAGES\*.*&quot; &quot;&quot; find_lang_dir_continue

        Delete &quot;$INSTDIR\share\locale\$found_dir\LC_MESSAGES\atk10.mo&quot;
        Delete &quot;$INSTDIR\share\locale\$found_dir\LC_MESSAGES\gdk-pixbuf.mo&quot;
        Delete &quot;$INSTDIR\share\locale\$found_dir\LC_MESSAGES\glib20.mo&quot;
        Delete &quot;$INSTDIR\share\locale\$found_dir\LC_MESSAGES\gtk20.mo&quot;
        Delete &quot;$INSTDIR\share\locale\$found_dir\LC_MESSAGES\gtk20-properties.mo&quot;

        RmDir &quot;$INSTDIR\share\locale\$found_dir\LC_MESSAGES&quot;  ; only if empty
        RmDir &quot;$INSTDIR\share\locale\$found_dir&quot;

        find_lang_dir_continue:
        FindNext $find_handle_lang_dir $found_dir
        goto find_lang_dir_next
        find_lang_dir_done:
        FindClose $find_handle_lang_dir

        RMDir &quot;$INSTDIR\share\locale&quot;  ; only if empty, not to remove the other programs&#39; translations
    un_notranslations:


    RMDir /r &quot;$INSTDIR\share\themes\Raleigh&quot;
    RMDir /r &quot;$INSTDIR\share\themes\MS-Windows&quot;
    RMDir /r &quot;$INSTDIR\share\themes\Emacs&quot;

    RMDir &quot;$INSTDIR\share\themes&quot;  ; not forced
    RMDir &quot;$INSTDIR\share&quot;  ; not forced

    Delete &quot;$INSTDIR\gtk2_runtime_uninst.exe&quot;

    RMDir &quot;$INSTDIR&quot;  ; delete only if empty

SectionEnd ; end of uninstall section






; --------------- Helpers


; WriteEnvBat
Function WriteEnvBat
    Pop $R0 ; Output file
    Push $R9
        FileOpen $R9 $R0 w
        FileWrite $R9 &quot;@set GTK2R_PREFIX=$LIB_INSTDIR$\r$\n&quot;
        FileWrite $R9 &quot;$\r$\n&quot;
        FileWrite $R9 &quot;@echo Setting environment variables for GTK2-Runtime.$\r$\n&quot;
        FileWrite $R9 &quot;@echo.$\r$\n&quot;
        FileWrite $R9 &quot;$\r$\n&quot;
        FileWrite $R9 &quot;@echo set PATH=%GTK2R_PREFIX%;%%PATH%%$\r$\n&quot;
        FileWrite $R9 &quot;@set PATH=%GTK2R_PREFIX%;%PATH%$\r$\n&quot;
        FileWrite $R9 &quot;$\r$\n&quot;
        FileWrite $R9 &quot;@echo.$\r$\n&quot;
        FileClose $R9
    Pop $R9
FunctionEnd



; WritePostInstall
Function WritePostInstall
    SetShellVarContext all  ; use all user variables as opposed to current user
    Pop $R0 ; Output file
    Push $R9
        FileOpen $R9 $R0 w
        FileWrite $R9 &quot;@echo off$\r$\n&quot;
        FileWrite $R9 &quot;$\&quot;$INSTDIR\bin\pango-querymodules.exe$\&quot; &gt; $\&quot;$INSTDIR\etc\pango\pango.modules$\&quot;$\r$\n&quot;
        FileWrite $R9 &quot;rem $\&quot;$INSTDIR\bin\gdk-pixbuf-query-loaders.exe$\&quot; &gt; $\&quot;$INSTDIR\etc\gtk-2.0\gdk-pixbuf.loaders$\&quot;$\r$\n&quot;
        FileWrite $R9 &quot;$\&quot;$INSTDIR\bin\gtk-query-immodules-2.0.exe$\&quot; &gt; $\&quot;$INSTDIR\etc\gtk-2.0\gtk.immodules$\&quot;$\r$\n&quot;
        FileWrite $R9 &quot;rem $\&quot;$INSTDIR\bin\gtk-update-icon-cache.exe$\&quot;$\r$\n&quot;
        FileClose $R9
    Pop $R9
FunctionEnd




; Detect previous installation
Function DetectPrevInstallation
    ; if /removeold=no option is given, don&#39;t check anything.
    StrCmp $install_option_removeold &quot;no&quot; old_detect_done

    SetShellVarContext all  ; use all user variables as opposed to current user
    push $R0

    ; detect previous installation
    ReadRegStr $R0 HKLM &quot;${PRODUCT_UNINST_KEY}&quot; &quot;UninstallString&quot;
    StrCmp $R0 &quot;&quot; old_detect_done

    MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION \
        &quot;${PRODUCT_NAME} is already installed. $\n$\nClick `OK` to remove the \
        previous version or `Cancel` to continue anyway.&quot; \
        /SD IDOK IDOK old_uninst
        ; Abort
        goto old_detect_done

    ; Run the old uninstaller
    old_uninst:
        ClearErrors
        IfSilent old_silent_uninst old_nosilent_uninst

        old_nosilent_uninst:
            ExecWait &#39;$R0&#39;
            goto old_uninst_continue

        old_silent_uninst:
            ; We assume it&#39;s an NSIS-generated uninstaller.
            ExecWait &#39;$R0 /S _?=$INSTDIR&#39;

        old_uninst_continue:

        IfErrors old_no_remove_uninstaller

        ; You can either use Delete /REBOOTOK in the uninstaller or add some code
        ; here to remove to remove the uninstaller. Use a registry key to check
        ; whether the user has chosen to uninstall. If you are using an uninstaller
        ; components page, make sure all sections are uninstalled.
        old_no_remove_uninstaller:

    old_detect_done: ; old installation not found, all ok

    pop $R0
FunctionEnd



; Prevent running multiple instances of the installer
Function PreventMultipleInstances
    Push $R0
    System::Call &#39;kernel32::CreateMutexA(i 0, i 0, t ${PRODUCT_NAME}) ?e&#39;
    Pop $R0
    StrCmp $R0 0 +3
        MessageBox MB_OK|MB_ICONEXCLAMATION &quot;The installer is already running.&quot; /SD IDOK
        Abort
    Pop $R0
FunctionEnd




; eof
</code></pre></noscript></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building a 64-bit version of HDF5 with MinGW-w64]]></title>
    <link href="http://yeangpeng.tech/blog/2014/01/29/building-a-64-bit-version-of-hdf5-with-mingw-w64/"/>
    <updated>2014-01-29T16:35:00+08:00</updated>
    <id>http://yeangpeng.tech/blog/2014/01/29/building-a-64-bit-version-of-hdf5-with-mingw-w64</id>
    <content type="html"><![CDATA[<p>I have finally decided to try building a 64-bit version of the Windows package of <a href="http://github.com/tschoonj/xmimsim">XMI-MSIM</a>.
As is the case for my 32-bit builds, I am using the MinGW compiler as provided by <a href="http://tdm-gcc.tdragon.net">TDM-GCC</a>, although obviously this time I opted for the 64-bit variant.
Now XMI-MSIM has a considerable amount of dependencies (GTK+, GSL, HDF5, libxml2, libxslt, curl, json-glib and others), I am again forced to compile these all again from source before I can even think of compiling my actualy software. One exception here is GTK+ and its dependencies since the good people from the GTK project are offering 64-bit builds (compiled with MinGW-w64) on their <a href="http://www.gtk.org/download/win64.php">website</a>.</p>

<p>In the past, the HDF5 build has always cost me most of my time, compared to the other packages, to get it compiled on MSYS, especially the Fortran bindings part. Now since I have dropped the dependency for these Fortran bindings in my latest version, because of my past experiences, I hoped that compiling them with MinGW-w64 might somehow have become easier.</p>

<p>Alas&hellip;</p>

<!--more-->


<p>As it turns out the HDF5 people have decided to drop support for building HDF5 with MinGW with their 1.8.5 release, and are currently only supporting builds on Windows with either cygwin (with the configure script) or Visual Studio (with CMake), none of which was suitable for me.
I downloaded the latest version 1.8.12 from the <a href="http://www.hdfgroup.org/HDF5/release/obtainsrc.html">HDF5 website</a>, unpacked the tarball and ran:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./configure --host=x86_64-w64-mingw32 --build=x86_64-w64-mingw32 --disable-hl --prefix=$HOME</span></code></pre></td></tr></table></div></figure>


<p>The two first options ensure that the configure script realizes that I am using a 64-bit MinGW compiler, which may be necessary for some tests to pass (at least with other packages I compiled this was necessary).
The third option disable the high-level bindings, while the last option makes sure that they files will be installed in subfolders of my home directory.</p>

<p>Running make resulted in the compilation process starting but it halted after some time with errors that were related to some preprocessor macros that were not defined. A quick google search yielded <a href="http://mail.lists.hdfgroup.org/pipermail/hdf-forum_lists.hdfgroup.org/2012-April/005699.html">this</a>. After implementing this fix I resumed compilation but ran again into trouble. This time google was not helpful but I found the fix myself.</p>

<p>The solution to both problems was to append the following lines to the src/H5pubconf.h within your <em>builddirectory</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//fixes first problem</span>
</span><span class='line'><span class="cp">#ifndef H5_HAVE_WIN32_API</span>
</span><span class='line'><span class="cp">#ifdef WIN32 </span><span class="cm">/* defined for all windows systems */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define H5_HAVE_WIN32_API 1</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifndef H5_HAVE_MINGW</span>
</span><span class='line'><span class="cp">#ifdef __MINGW32__ </span><span class="cm">/*defined for all MinGW compilers */</span><span class="cp"></span>
</span><span class='line'><span class="cp">#define H5_HAVE_MINGW 1</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//fixes second problem</span>
</span><span class='line'><span class="cp">#define H5_BUILT_AS_DYNAMIC_LIB 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Afterwards everything builds fine, and even make check went pretty well except for one error, which seemed harmless.</p>

<p>There&rsquo;s a good chance that future HDF5 versions will either fix this by including this patch (although I wouldn&rsquo;t count on it) or will break building HDF5 with MinGW-w64 once again in new and fascinating ways (I put my money on this). Since I will be stuck with HDF5 for a while longer, don&rsquo;t be surprised if this post gets updated&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building libtool modules: Python bindings]]></title>
    <link href="http://yeangpeng.tech/blog/2013/09/04/building-libtool-modules-python-bindings/"/>
    <updated>2013-09-04T10:47:00+08:00</updated>
    <id>http://yeangpeng.tech/blog/2013/09/04/building-libtool-modules-python-bindings</id>
    <content type="html"><![CDATA[<p>One of the software packages (<a href="http://github.com/tschoonj/xraylib">xraylib</a>) I am working on, consists of a C-library with bindings to a number of other languages such as Python, Fortran 2003, IDL, Java, Ruby, Lua and Perl. Apart from IDL and Fortran 2003, the source code for these bindings is generated automatically using <a href="http://www.swig.org">swig</a>, although with considerable language-specific modifications to the swig interface file.</p>

<p>The bindings source code afterwards needs to be compiled into a dynamically loadable library, which will then be loaded at runtime by the program whenever the user needs to use a function or variable from the bindings (actually from the underlying C-library, but exposed through the swig generated bindings).
As a rule, each programming language that supports such dynamically loadable libraries comes with specific instructions on how to generate the libraries from the bindings source code, often using platform independent tools.</p>

<p>However, these tools never seem to integrate well with autoconf and automake and lead to quite complicated Makefile.am files. A considerable more easy approach would consist of relying on libtool&rsquo;s functionality of generating these dynamically loadable libraries (called modules in the libtool documentation).
In this series of posts I will share my experiences on generating bindings to the aforementioned languages using libtool in a relatively clear and easy way. All the code has been tested on Linux and Mac OS X. It may also work on Windows though, provided you install a bash shell with the required tools.</p>

<p>In this first post I will discuss Python extension modules.</p>

<!--more-->


<h2>Checking for python development tools</h2>

<p>If you want to create an autotools based project consisting of a C-library and python bindings, then one of the first things that configure will need to check for is the presence of the python interpreter and the development kit consisting of the python headers and some essential tools.
I accomplished this by adding the following lines into configure.ac</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#configure.ac snippet</span>
</span><span class='line'><span class="c">#copy paste into your own configure.ac file</span>
</span><span class='line'>
</span><span class='line'><span class="c">#check for swig</span>
</span><span class='line'>AC_CHECK_PROGS<span class="o">([</span>SWIG<span class="o">]</span>,<span class="o">[</span>swig<span class="o">]</span>,<span class="o">[</span><span class="s2">&quot;noswig&quot;</span><span class="o">])</span>
</span><span class='line'>
</span><span class='line'><span class="c">#present configure with a command-line option to disable the python bindings</span>
</span><span class='line'>AC_ARG_ENABLE<span class="o">([</span>python<span class="o">]</span>,<span class="o">[</span>AS_HELP_STRING<span class="o">([</span>--disable-python<span class="o">]</span>,<span class="o">[</span>build without the python bindings<span class="o">])]</span>,<span class="o">[</span><span class="nv">enable_python</span><span class="o">=</span><span class="nv">$enableval</span><span class="o">]</span>,<span class="o">[</span><span class="nv">enable_python</span><span class="o">=</span>check<span class="o">])</span>
</span><span class='line'><span class="c">#default behavior is to install the python bindings into subfolders of $prefix</span>
</span><span class='line'><span class="c">#however, this may require the user to set the PYTHONPATH environment variable</span>
</span><span class='line'><span class="c">#in order to avoid this, invoke configure with the --enable-python-integration option</span>
</span><span class='line'>
</span><span class='line'>AC_ARG_ENABLE<span class="o">([</span>python-integration<span class="o">]</span>,<span class="o">[</span>AS_HELP_STRING<span class="o">([</span>--enable-python-integration<span class="o">]</span>,<span class="o">[</span>install the python bindings in the interpreters site-packages folder<span class="o">])]</span>,<span class="o">[</span><span class="nv">enable_python_integration</span><span class="o">=</span><span class="nv">$enableval</span><span class="o">]</span>,<span class="o">[</span><span class="nv">enable_python_integration</span><span class="o">=</span>check<span class="o">])</span>
</span><span class='line'>
</span><span class='line'><span class="nv">VALID_PYTHON</span><span class="o">=</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;x$SWIG&quot;</span> <span class="o">=</span> xnoswig <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="s2">&quot;x$enable_python&quot;</span> <span class="o">=</span> xyes <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="c">#don&#39;t even bother when swig is not found</span>
</span><span class='line'>        AC_MSG_ERROR<span class="o">([</span>--enable-python was given as an option but swig was not found on the system<span class="o">])</span>
</span><span class='line'><span class="k">elif</span> <span class="nb">test</span> <span class="s2">&quot;x$SWIG&quot;</span> <span class="o">=</span> xswig <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="s2">&quot;x$enable_python&quot;</span> !<span class="o">=</span> xno <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="c">#verify the python installation</span>
</span><span class='line'>        AM_PATH_PYTHON<span class="o">(</span>,<span class="o">[</span><span class="nv">PYTHON_FOUND</span><span class="o">=</span><span class="nb">true</span><span class="o">]</span>,<span class="o">[</span><span class="nv">PYTHON_FOUND</span><span class="o">=</span><span class="nb">false</span><span class="o">])</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;x$PYTHON_FOUND&quot;</span> <span class="o">=</span> xtrue <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                <span class="nv">PYTHON_CPPFLAGS</span><span class="o">=</span>
</span><span class='line'>                <span class="nv">PYTHON_LDFLAGS</span><span class="o">=</span>
</span><span class='line'>                AX_PYTHON_DEVEL
</span><span class='line'>                <span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;x$PYTHON&quot;</span> <span class="o">=</span> x <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                        <span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;x$enable_python&quot;</span> <span class="o">=</span> xyes <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                                AC_MSG_ERROR<span class="o">([</span>Incomplete python development package<span class="o">])</span>
</span><span class='line'>                        <span class="k">else</span>
</span><span class='line'>                                AC_MSG_WARN<span class="o">([</span>Incomplete python development package<span class="o">])</span>
</span><span class='line'>                        <span class="k">fi</span>
</span><span class='line'>                        <span class="nv">VALID_PYTHON</span><span class="o">=</span>no
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                        <span class="nv">VALID_PYTHON</span><span class="o">=</span>yes
</span><span class='line'>                <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;x$VALID_PYTHON&quot;</span> <span class="o">=</span> xyes <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>  AC_MSG_NOTICE<span class="o">([</span>Building with Python bindings<span class="o">])</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;x$enable_python_integration&quot;</span> <span class="o">=</span> xyes <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>          <span class="nv">pythondir</span><span class="o">=</span><span class="nv">$PYTHON_SITE_PKG</span>
</span><span class='line'>          <span class="nv">pyexecdir</span><span class="o">=</span><span class="nv">$PYTHON_SITE_PKG_EXEC</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  AC_SUBST<span class="o">(</span>PYTHONDIR,<span class="nv">$pythondir</span><span class="o">)</span>
</span><span class='line'>  AC_SUBST<span class="o">(</span>PKGPYTHONDIR,<span class="nv">$pkgpythondir</span><span class="o">)</span>
</span><span class='line'>  AC_SUBST<span class="o">(</span>PYEXECDIR,<span class="nv">$pyexecdir</span><span class="o">)</span>
</span><span class='line'>  AC_SUBST<span class="o">(</span>PKGPYEXECDIR,<span class="nv">$pkgpyexecdir</span><span class="o">)</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>AM_CONDITIONAL<span class="o">([</span>ENABLE_PYTHON<span class="o">]</span>,<span class="o">[</span><span class="nb">test </span>x<span class="nv">$VALID_PYTHON</span> <span class="o">=</span> xyes<span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>As can be seen from this snippet, I depend on two m4 macros to obtain the required information: <a href="http://www.gnu.org/software/automake/manual/html_node/Python.html">AM_PATH_PYTHON</a>, which searches for Python interpreter and subsequently sets a number of variables that will be used at installation time, and AX_PYTHON_DEVEL (I am using a heavily modified version of the code found at <a href="http://www.gnu.org/software/autoconf-archive/ax_python_devel.html">autoconf archives</a>), which will check for the required headers and perform a test compilation to make sure everything works.</p>

<h2>Writing the Makefile.am</h2>

<p>The Python way of building and installing extensions relies on the <a href="http://docs.python.org/3.3/distutils/setupscript.html#describing-extension-modules">Distutils package</a>, and is guaranteed to work on all platforms but integrates with difficulty into autotools based installation scripts.
However, recent versions of <a href="http://www.gnu.org/software/automake/manual/html_node/Python.html">automake</a> come with built-in support for installing python source files (and even byte-compile them), and comes with some recommendations on how to build your Python extensions module (possibly linked to a C-library as in our case) using libtool. The following example code is based upon these recommendations but also contains additional Makefile targets that deal with generating the Python extension module source through swig. Let&rsquo;s assume our original C-library is called <code>mytest</code>, and is located in the <code>src</code> subfolder of the source tree. The Python bindings will be built in the <code>python</code> subfolder.</p>

<p>In this example, I followed the Python recommendations with regard to naming the extension module:</p>

<blockquote><p>When an extension module written in C or C++ has an accompanying Python module that provides a higher level (e.g. more object oriented) interface, the C/C++ module has a leading underscore.</p><footer><strong>http://www.python.org/dev/peps/pep-0008/#package-and-module-names PEP 8 -- Style Guide for Python Code</strong></footer></blockquote>


<p>In this case, the accompanying Python module will be automatically generated by swig, and will be called <code>mytest.py</code>, while the extension module will receive the libtool name <code>_mytest.la</code>. The actual library extension will be platform dependent (.so on Linux/Mac OS X, .dll on Windows).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="c">#python bindings will only be built if all buildtools are available, hence the following automake conditional</span>
</span><span class='line'><span class="err">if</span> <span class="err">ENABLE_PYTHON</span>
</span><span class='line'><span class="c">#our python extension module</span>
</span><span class='line'><span class="nv">pyexec_LTLIBRARIES</span> <span class="o">=</span> _mytest.la
</span><span class='line'><span class="nv">_mytest_la_CFLAGS</span> <span class="o">=</span> <span class="k">$(</span>PYTHON_CFLAGS<span class="k">)</span> -I<span class="k">$(</span>top_srcdir<span class="k">)</span>/include <span class="k">$(</span>PYTHON_CPPFLAGS<span class="k">)</span>
</span><span class='line'><span class="c">#link to the C-library</span>
</span><span class='line'><span class="c">#probably on Windows one will need to link against the python dll as well</span>
</span><span class='line'><span class="nv">_mytest_la_LIBADD</span> <span class="o">=</span> ../src/mytest.la
</span><span class='line'><span class="c">#the source code for our extensions module</span>
</span><span class='line'><span class="c">#nodist because this file will be generated by swig</span>
</span><span class='line'><span class="nv">nodist__mytest_la_SOURCES</span> <span class="o">=</span> mytest_wrap.c
</span><span class='line'><span class="c">#-module forces libtool to generate a dynamically loadable module</span>
</span><span class='line'><span class="nv">_mytest_la_LDFLAGS</span> <span class="o">=</span> -avoid-version -module -shared -export-dynamic
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#nodist because this file will be generated by swig</span>
</span><span class='line'><span class="nv">nodist_python_PYTHON</span> <span class="o">=</span> mytest.py
</span><span class='line'>
</span><span class='line'><span class="c">#this line assumes that the swig interface file mytest.i is located in the src subdirectory</span>
</span><span class='line'><span class="nf">mytest_wrap.c</span><span class="o">:</span> <span class="k">$(</span><span class="nv">top_srcdir</span><span class="k">)</span>/<span class="n">src</span>/<span class="n">mytest</span>.<span class="n">i</span>
</span><span class='line'>  <span class="k">$(</span>SWIG<span class="k">)</span> -I<span class="k">${</span><span class="nv">top_srcdir</span><span class="k">}</span>/include -includeall -o mytest_wrap.c -python <span class="k">${</span><span class="nv">top_srcdir</span><span class="k">}</span>/src/mytest.i
</span><span class='line'>
</span><span class='line'><span class="nf">mytest.py</span><span class="o">:</span> <span class="n">mytest_wrap</span>.<span class="n">c</span>
</span><span class='line'>
</span><span class='line'><span class="nf">clean-local</span><span class="o">:</span>
</span><span class='line'>  rm -rf mytest_wrap.c mytest.py mytest.pyc
</span><span class='line'>
</span><span class='line'><span class="cp">endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>When writing an autotools based project using these guidelines, you should have no problem compiling and installing your python bindings and the C-library it depends on, with the familiar commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./configure
</span><span class='line'>make
</span><span class='line'>make install</span></code></pre></td></tr></table></div></figure>


<h2>The code</h2>

<p>The full code follows: as usual it&rsquo;s a github gist so feel free to clone it and hack away at it.</p>

<div><script src='https://gist.github.com/6441999.js'></script>
<noscript><pre><code>#python bindings will only be built if all buildtools are available, hence the following automake conditional
if ENABLE_PYTHON
#our python extension module
pyexec_LTLIBRARIES = _mytest.la
_mytest_la_CFLAGS = $(PYTHON_CFLAGS) -I$(top_srcdir)/include $(PYTHON_CPPFLAGS)
#link to the C-library
#probably on Windows one will need to link against the python dll as well
_mytest_la_LIBADD = ../src/mytest.la
#the source code for our extensions module
#nodist because this file will be generated by swig
nodist__mytest_la_SOURCES = mytest_wrap.c
#-module forces libtool to generate a dynamically loadable module
_mytest_la_LDFLAGS = -avoid-version -module -shared -export-dynamic


#nodist because this file will be generated by swig
nodist_python_PYTHON = mytest.py

#this line assumes that the swig interface file mytest.i is located in the src subdirectory
mytest_wrap.c: $(top_srcdir)/src/mytest.i
    $(SWIG) -I${top_srcdir}/include -includeall -o mytest_wrap.c -python ${top_srcdir}/src/mytest.i
        
mytest.py: mytest_wrap.c

clean-local:
    rm -rf mytest_wrap.c mytest.py mytest.pyc
        
endif</code></pre></noscript></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Exporting and printing a GtkExtra plot canvas]]></title>
    <link href="http://yeangpeng.tech/blog/2013/07/22/exporting-and-printing-a-gtkextra-plot-canvas/"/>
    <updated>2013-07-22T10:24:00+08:00</updated>
    <id>http://yeangpeng.tech/blog/2013/07/22/exporting-and-printing-a-gtkextra-plot-canvas</id>
    <content type="html"><![CDATA[<p>My software package <a href="http://github.com/tschoonj/xmimsim">XMI-MSIM</a> relies on <a href="http://gtkextra.sourceforge.net/cms/">GtkExtra</a> for the visualization of the simulated X-ray fluorescence spectra.
This library contains a number of useful widgets, such as a spreadsheet widget and a number of plotting tools, for your Gtk2 based GUI&rsquo;s.
Recently, I have become a minor contributor of this project, and I have been particularly active in improving the buildsystem and also generating RPM files for a number of Fedora/RHEL based distros, and DEB files for several recent releases of Ubuntu and Debian. Full instructions on how to obtain access to these packages, which are hosted by <a href="http://www.xmi.ugent.be">my old research group</a>, can be found <a href="http://gtkextra.sourceforge.net/cms/index.php?option=com_content&amp;view=article&amp;id=40&amp;Itemid=21">here</a>.</p>

<p>In todays blog post I am presenting an example of how one can relatively easily add printing and exporting capabilities to GtkExtra&rsquo;s <code>GtkPlotCanvas</code> widget. I will demonstrate this with a short program that I have written that contains a plot of a sine function, and two buttons that allow the user to invoke the dialog windows that will set up the exporting and the printing of the canvas, respectively.</p>

<!--more-->


<h2>Generating the interface</h2>

<p>Start off with a <code>GtkWindow</code> that contains a <code>GtkVBox</code>, which in turn is packed with two widgets: a <code>GtkHBox</code> that contains three buttons (Print, Save As and Quit), and the <code>GtkPlotCanvas</code>. The code itself is pretty straightforward Gtk+, except for the bit that deals with the <code>GtkPlotCanvas</code>. This is a perhaps a good time to mention that I am in no way a GtkExtra expert (or even Gtk+ for that matter&hellip;), and that the following code is the result of my studying of the GtkExtra examples, and the (unfortunately very limited) documentation. Anyway, I&rsquo;ll try and clarify as much as possible&hellip;</p>

<h3>Set up the canvas</h3>

<p>Define a canvas widget that will be used to draw the plot later and give it dimensions that correspond to those of the <a href="http://en.wikipedia.org/wiki/ISO_216">A4 paper size standard</a>. Other sizes are also available (letter, executive and legal), and are defined in <code>gtkplotpc.h</code>.The last parameter of the <code>gtk_plot_canvas_new</code> function is the magnification, which acts a scale factor for the dimensions of the canvas, and will therefore determine the size of the widget in the application. However, it has no impact on the size of the print or the size of the exported image.
Next, I disable the user-interaction with the canvas and its items with the call to <code>GTK_PLOT_CANVAS_UNSET_FLAGS</code>, and I define the <code>GdkColor</code>s that will be used in the plot and canvas. The last call sets explicitly the background color of the canvas to white.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GtkWidget</span> <span class="o">*</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">gtk_plot_canvas_new</span><span class="p">(</span><span class="n">GTK_PLOT_A4_H</span><span class="p">,</span> <span class="n">GTK_PLOT_A4_W</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_box_pack_start</span><span class="p">(</span><span class="n">GTK_BOX</span><span class="p">(</span><span class="n">mainbox</span><span class="p">),</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'><span class="n">GTK_PLOT_CANVAS_UNSET_FLAGS</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">canvas</span><span class="p">),</span> <span class="n">GTK_PLOT_CANVAS_CAN_SELECT</span> <span class="o">|</span> <span class="n">GTK_PLOT_CANVAS_CAN_SELECT_ITEM</span><span class="p">);</span>
</span><span class='line'><span class="n">gdk_color_parse</span><span class="p">(</span><span class="s">&quot;white&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">white</span><span class="p">);</span>
</span><span class='line'><span class="n">gdk_colormap_alloc_color</span><span class="p">(</span><span class="n">gdk_colormap_get_system</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">white</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'><span class="n">gdk_color_parse</span><span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">red</span><span class="p">);</span>
</span><span class='line'><span class="n">gdk_colormap_alloc_color</span><span class="p">(</span><span class="n">gdk_colormap_get_system</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">red</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_canvas_set_background</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">canvas</span><span class="p">),</span><span class="o">&amp;</span><span class="n">white</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Add a plot to the window&hellip;</h3>

<p>The following calls will generate the plot and set its properties.
Most functionnames should be pretty selfexplanatory, especially when combined with the GtkExtra documentation.
I am not entirely confident about <code>gtk_plot_new_with_size</code> though: at least in this example the two last arguments (width and height), appear to have no influence on the result.
Anyway, after constructing the plot to your liking, it must be added to the <code>GtkPlotCanvas</code> that was defined in the previous section.
This is accomplished with the calls to <code>gtk_plot_canvas_plot_new</code> and <code>gtk_plot_canvas_put_child</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GtkWidget</span> <span class="o">*</span><span class="n">plot_window</span><span class="p">;</span>
</span><span class='line'><span class="n">plot_window</span> <span class="o">=</span> <span class="n">gtk_plot_new_with_size</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="mf">.65</span><span class="p">,</span><span class="mf">.45</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_set_background</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span><span class="o">&amp;</span><span class="n">white</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_hide_legends</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">));</span>
</span><span class='line'>  
</span><span class='line'><span class="n">gtk_plot_set_ticks</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_X</span><span class="p">,</span> <span class="n">M_PI_2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_set_ticks</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_Y</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_grids_set_visible</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span><span class="n">TRUE</span> <span class="p">,</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span><span class="n">FALSE</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_axis_hide_title</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_TOP</span><span class="p">));</span>
</span><span class='line'><span class="n">gtk_plot_axis_hide_title</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_RIGHT</span><span class="p">));</span>
</span><span class='line'><span class="n">gtk_plot_axis_set_title</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_BOTTOM</span><span class="p">),</span><span class="s">&quot;x&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_axis_set_title</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_LEFT</span><span class="p">),</span><span class="s">&quot;y=sin(x)&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_axis_title_set_attributes</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_LEFT</span><span class="p">),</span><span class="s">&quot;Helvetica&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">TRUE</span><span class="p">,</span><span class="n">GTK_JUSTIFY_CENTER</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_axis_title_set_attributes</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_BOTTOM</span><span class="p">),</span><span class="s">&quot;Helvetica&quot;</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">TRUE</span><span class="p">,</span><span class="n">GTK_JUSTIFY_CENTER</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_axis_set_labels_attributes</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_LEFT</span><span class="p">),</span><span class="s">&quot;Helvetica&quot;</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">TRUE</span><span class="p">,</span><span class="n">GTK_JUSTIFY_RIGHT</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_axis_set_labels_attributes</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_RIGHT</span><span class="p">),</span><span class="s">&quot;Helvetica&quot;</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">TRUE</span><span class="p">,</span><span class="n">GTK_JUSTIFY_LEFT</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_axis_set_labels_attributes</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_BOTTOM</span><span class="p">),</span><span class="s">&quot;Helvetica&quot;</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">TRUE</span><span class="p">,</span><span class="n">GTK_JUSTIFY_CENTER</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_axis_show_labels</span><span class="p">(</span><span class="n">gtk_plot_get_axis</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">GTK_PLOT_AXIS_TOP</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">GtkPlotCanvasChild</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">gtk_plot_canvas_plot_new</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">));</span>
</span><span class='line'><span class="n">gtk_plot_canvas_put_child</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">canvas</span><span class="p">),</span> <span class="n">child</span><span class="p">,</span> <span class="mf">.15</span><span class="p">,</span><span class="mf">.05</span><span class="p">,</span><span class="mf">.90</span><span class="p">,</span><span class="mf">.85</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>&hellip;and finish off with the data</h3>

<p>So far, we have defined the <code>GtkPlotCanvas</code> and the <code>GtkPlot</code>. The latter currently consists of an empty grid. I made things a bit more interesting by adding a graph of a sine function. The following lines calculate 1000 values of the sine function within the interval [0, 4π], and add them subsequently to a <code>GtkPlotData</code> variable, that in turn is added to the <code>GtkPlot</code> with <code>gtk_plot_add_data</code>
As with the grid in the previous section, it is possible to change the properties of the graph using a few appropriately named functions.
This part of the code finishes by drawing and showing all widgets. I am doing this here with several calls, some of which are definitely unnecessary, but the documentation and examples of GtkExtra are pretty unclear on how to do this (especially when updating, erasing canvases, plots etc). Anyway, calling all of them seems to work just fine :-)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//calculate a sine function</span>
</span><span class='line'><span class="kt">double</span> <span class="o">*</span><span class="n">xvals</span> <span class="o">=</span> <span class="n">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="kt">double</span> <span class="o">*</span><span class="n">yvals</span> <span class="o">=</span> <span class="n">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">xvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">M_PI</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="mi">999</span><span class="p">;</span>
</span><span class='line'>  <span class="n">yvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">GtkPlotData</span> <span class="o">*</span><span class="n">dataset</span><span class="p">;</span>
</span><span class='line'><span class="n">dataset</span> <span class="o">=</span> <span class="n">GTK_PLOT_DATA</span><span class="p">(</span><span class="n">gtk_plot_data_new</span><span class="p">());</span>
</span><span class='line'><span class="n">gtk_plot_add_data</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span><span class="n">dataset</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_data_set_numpoints</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_data_set_x</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">xvals</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_data_set_y</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">yvals</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_set_range</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">M_PI</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_clip_data</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span> <span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_widget_show</span><span class="p">(</span><span class="n">GTK_WIDGET</span><span class="p">(</span><span class="n">dataset</span><span class="p">));</span>
</span><span class='line'><span class="n">gtk_plot_data_set_line_attributes</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="n">GTK_PLOT_LINE_SOLID</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">red</span><span class="p">);</span>
</span><span class='line'><span class="n">gtk_plot_canvas_paint</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">canvas</span><span class="p">));</span>
</span><span class='line'><span class="n">gtk_widget_queue_draw</span><span class="p">(</span><span class="n">GTK_WIDGET</span><span class="p">(</span><span class="n">canvas</span><span class="p">));</span>
</span><span class='line'><span class="n">gtk_plot_canvas_refresh</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">canvas</span><span class="p">));</span>
</span><span class='line'><span class="n">gtk_plot_paint</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">));</span>
</span><span class='line'><span class="n">gtk_plot_refresh</span><span class="p">(</span><span class="n">GTK_PLOT</span><span class="p">(</span><span class="n">plot_window</span><span class="p">),</span><span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">gtk_widget_show_all</span><span class="p">(</span><span class="n">window</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">gtk_main</span><span class="p">();</span> 
</span></code></pre></td></tr></table></div></figure>


<p>After compilation with something like:</p>

<pre><code>gcc -o gtkextra-print-export `pkg-config --cflags gtkextra-3.0` gtkextra-print-export.c `pkg-config --libs gtkextra-3.0`
</code></pre>

<p>and running <code>gtkextra-print-export</code>, you should get something like:</p>

<p><img class="center" src="http://yeangpeng.tech/images/gtkextra.png"></p>

<h2>Printing the canvas</h2>

<p>Both the printing and exporting of the canvas rely on Cairo. The most important function here is <code>gtk_plot_canvas_export_cairo</code>, which accepts a cairo context as argument and will &lsquo;paint&rsquo; the canvas on it. When printing, this cairo context is produced by <code>gtk_print_context_get_cairo_context</code>, as is shown in the following code snippet. It contains both the &lsquo;clicked&rsquo; callback for the Print button, as well as the &lsquo;draw-page&rsquo; callback for the <code>GtkPrintOperation</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">draw_page</span><span class="p">(</span><span class="n">GtkPrintOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">GtkPrintContext</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">gint</span> <span class="n">page_nr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dialogData</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">cairo_t</span> <span class="o">*</span><span class="n">cr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//the following two lines do all the magic</span>
</span><span class='line'>        <span class="n">cr</span> <span class="o">=</span> <span class="n">gtk_print_context_get_cairo_context</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_plot_canvas_export_cairo</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">canvas</span><span class="p">),</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">print_button_clicked_cb</span><span class="p">(</span><span class="n">GtkWidget</span> <span class="o">*</span><span class="n">button</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dialogData</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">GtkPrintOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">;</span>
</span><span class='line'>        <span class="n">GError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>        <span class="n">GtkPrintOperationResult</span> <span class="n">res</span><span class="p">;</span>
</span><span class='line'>  <span class="n">GtkPrintSettings</span> <span class="o">*</span><span class="n">print_settings</span><span class="p">;</span>
</span><span class='line'>  <span class="n">GtkPageSetup</span> <span class="o">*</span><span class="n">page_setup</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//print settings</span>
</span><span class='line'>        <span class="n">print_settings</span> <span class="o">=</span> <span class="n">gtk_print_settings_new</span><span class="p">();</span>
</span><span class='line'>        <span class="n">gtk_print_settings_set_orientation</span><span class="p">(</span><span class="n">print_settings</span><span class="p">,</span><span class="n">GTK_PAGE_ORIENTATION_LANDSCAPE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_print_settings_set_paper_size</span><span class="p">(</span><span class="n">print_settings</span><span class="p">,</span><span class="n">gtk_paper_size_new</span><span class="p">(</span><span class="n">GTK_PAPER_NAME_A4</span><span class="p">));</span>
</span><span class='line'>        <span class="n">page_setup</span> <span class="o">=</span> <span class="n">gtk_page_setup_new</span><span class="p">();</span>
</span><span class='line'>        <span class="n">gtk_page_setup_set_orientation</span><span class="p">(</span><span class="n">page_setup</span><span class="p">,</span><span class="n">GTK_PAGE_ORIENTATION_LANDSCAPE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_page_setup_set_paper_size_and_default_margins</span><span class="p">(</span><span class="n">page_setup</span><span class="p">,</span><span class="n">gtk_paper_size_new</span><span class="p">(</span><span class="n">GTK_PAPER_NAME_A4</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">operation</span> <span class="o">=</span> <span class="n">gtk_print_operation_new</span><span class="p">();</span>
</span><span class='line'>        <span class="n">gtk_print_operation_set_print_settings</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span><span class="n">print_settings</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_print_operation_set_default_page_setup</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span><span class="n">page_setup</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_print_operation_set_show_progress</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span><span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_print_operation_set_track_print_status</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">g_signal_connect</span><span class="p">(</span><span class="n">G_OBJECT</span><span class="p">(</span><span class="n">operation</span><span class="p">),</span> <span class="s">&quot;draw-page&quot;</span><span class="p">,</span> <span class="n">G_CALLBACK</span><span class="p">(</span><span class="n">draw_page</span><span class="p">),</span> <span class="n">dd</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_print_operation_set_n_pages</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">res</span> <span class="o">=</span> <span class="n">gtk_print_operation_run</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">GTK_PRINT_OPERATION_ACTION_PRINT_DIALOG</span><span class="p">,</span> <span class="n">GTK_WINDOW</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">),</span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">GTK_PRINT_OPERATION_RESULT_APPLY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">g_object_unref</span><span class="p">(</span><span class="n">print_settings</span><span class="p">);</span>
</span><span class='line'>                <span class="n">print_settings</span> <span class="o">=</span> <span class="n">g_object_ref</span><span class="p">(</span><span class="n">gtk_print_operation_get_print_settings</span><span class="p">(</span><span class="n">operation</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="n">g_object_unref</span><span class="p">(</span><span class="n">operation</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Exporting the canvas to a file</h2>

<p>In this example, I have created the possibility to export to Encapsulated PostScript, PDF and PNG. Cairo also offers <a href="http://www.cairographics.org/manual/cairo-SVG-Surfaces.html">SVG support</a>, which may be useful to some. Other fileformats like JPEG may be supported through <a href="http://openil.sourceforge.net">devIL</a>&hellip;</p>

<p>The function in this example is a callback of the Save As button, and pops up a <code>GtkFileChooserDialog</code>, with three <code>GtkFileFilter</code>s, each corresponding to one of the supported fileformats. After selecting a filter and choosing the filename, a cairo surface is created for the selected filetype. Next, a cairo context is created for the surface, which will be used to paint the canvas on using <code>gtk_plot_canvas_export_cairo</code>. Multipage formats such as PostScript and PDF require the extra call to <code>cairo_show_page</code>. The function terminates after destroying the cairo surfaces and contexts.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">export_button_clicked_cb</span><span class="p">(</span><span class="n">GtkWidget</span> <span class="o">*</span><span class="n">button</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dialogData</span> <span class="o">*</span><span class="n">dd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">GtkWidget</span> <span class="o">*</span><span class="n">dialog</span><span class="p">;</span>
</span><span class='line'>        <span class="n">GtkFileFilter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>
</span><span class='line'>        <span class="n">gchar</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">cairo_t</span> <span class="o">*</span><span class="n">cr</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">cairo_surface_t</span> <span class="o">*</span><span class="n">surface</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dialog</span> <span class="o">=</span> <span class="n">gtk_file_chooser_dialog_new</span><span class="p">(</span><span class="s">&quot;Export spectra&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">GTK_WINDOW</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">),</span> <span class="n">GTK_FILE_CHOOSER_ACTION_SAVE</span><span class="p">,</span>
</span><span class='line'>                <span class="n">GTK_STOCK_CANCEL</span><span class="p">,</span> <span class="n">GTK_RESPONSE_CANCEL</span><span class="p">,</span>
</span><span class='line'>                <span class="n">GTK_STOCK_SAVE</span><span class="p">,</span> <span class="n">GTK_RESPONSE_ACCEPT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">gtk_file_chooser_set_do_overwrite_confirmation</span> <span class="p">(</span><span class="n">GTK_FILE_CHOOSER</span> <span class="p">(</span><span class="n">dialog</span><span class="p">),</span> <span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">filter</span> <span class="o">=</span> <span class="n">gtk_file_filter_new</span><span class="p">();</span>
</span><span class='line'>        <span class="n">gtk_file_filter_add_pattern</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span><span class="s">&quot;*.eps&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_file_filter_set_name</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span><span class="s">&quot;EPS (Encapsulated PostScript)&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_file_chooser_add_filter</span><span class="p">(</span><span class="n">GTK_FILE_CHOOSER</span><span class="p">(</span><span class="n">dialog</span><span class="p">),</span> <span class="n">filter</span><span class="p">);</span>
</span><span class='line'>        <span class="n">filter</span> <span class="o">=</span> <span class="n">gtk_file_filter_new</span><span class="p">();</span>
</span><span class='line'>        <span class="n">gtk_file_filter_add_pattern</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span><span class="s">&quot;*.pdf&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_file_filter_set_name</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span><span class="s">&quot;PDF (Adobe Portable Document Format)&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_file_chooser_add_filter</span><span class="p">(</span><span class="n">GTK_FILE_CHOOSER</span><span class="p">(</span><span class="n">dialog</span><span class="p">),</span> <span class="n">filter</span><span class="p">);</span>
</span><span class='line'>        <span class="n">filter</span> <span class="o">=</span> <span class="n">gtk_file_filter_new</span><span class="p">();</span>
</span><span class='line'>        <span class="n">gtk_file_filter_add_pattern</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span><span class="s">&quot;*.png&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_file_filter_set_name</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span><span class="s">&quot;PNG (Portable Network Graphics)&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gtk_file_chooser_add_filter</span><span class="p">(</span><span class="n">GTK_FILE_CHOOSER</span><span class="p">(</span><span class="n">dialog</span><span class="p">),</span> <span class="n">filter</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">gtk_dialog_run</span><span class="p">(</span><span class="n">GTK_DIALOG</span><span class="p">(</span><span class="n">dialog</span><span class="p">))</span> <span class="o">==</span> <span class="n">GTK_RESPONSE_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">filename</span> <span class="o">=</span> <span class="n">gtk_file_chooser_get_filename</span><span class="p">(</span><span class="n">GTK_FILE_CHOOSER</span><span class="p">(</span><span class="n">dialog</span><span class="p">));</span>
</span><span class='line'>                <span class="c1">//get selected filter</span>
</span><span class='line'>                <span class="n">filter</span> <span class="o">=</span> <span class="n">gtk_file_chooser_get_filter</span><span class="p">(</span><span class="n">GTK_FILE_CHOOSER</span><span class="p">(</span><span class="n">dialog</span><span class="p">));</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">gtk_file_filter_get_name</span><span class="p">(</span><span class="n">filter</span><span class="p">),</span><span class="s">&quot;EPS&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;.eps&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">gchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">g_realloc</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gchar</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>                                <span class="n">strcat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&quot;.eps&quot;</span><span class="p">);</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="n">surface</span> <span class="o">=</span> <span class="n">cairo_ps_surface_create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="mi">842</span><span class="p">,</span><span class="mi">595</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_ps_surface_set_eps</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cr</span> <span class="o">=</span> <span class="n">cairo_create</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">gtk_plot_canvas_export_cairo</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">canvas</span><span class="p">),</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_show_page</span><span class="p">(</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_surface_destroy</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_destroy</span><span class="p">(</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">gtk_file_filter_get_name</span><span class="p">(</span><span class="n">filter</span><span class="p">),</span><span class="s">&quot;PDF&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;.pdf&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">gchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">g_realloc</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gchar</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>                                <span class="n">strcat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&quot;.pdf&quot;</span><span class="p">);</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="n">surface</span> <span class="o">=</span> <span class="n">cairo_pdf_surface_create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="mf">842.0</span><span class="p">,</span><span class="mf">595.0</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cr</span> <span class="o">=</span> <span class="n">cairo_create</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">gtk_plot_canvas_export_cairo</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">canvas</span><span class="p">),</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_show_page</span><span class="p">(</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_surface_destroy</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_destroy</span><span class="p">(</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">gtk_file_filter_get_name</span><span class="p">(</span><span class="n">filter</span><span class="p">),</span><span class="s">&quot;PNG&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;.png&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">gchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">g_realloc</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gchar</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>                                <span class="n">strcat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&quot;.png&quot;</span><span class="p">);</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="n">surface</span> <span class="o">=</span> <span class="n">cairo_image_surface_create</span><span class="p">(</span><span class="n">CAIRO_FORMAT_ARGB32</span><span class="p">,</span> <span class="mi">842</span><span class="p">,</span> <span class="mi">595</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cr</span> <span class="o">=</span> <span class="n">cairo_create</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">gtk_plot_canvas_export_cairo</span><span class="p">(</span><span class="n">GTK_PLOT_CANVAS</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">canvas</span><span class="p">),</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_surface_write_to_png</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_surface_destroy</span><span class="p">(</span><span class="n">surface</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">cairo_destroy</span><span class="p">(</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">g_free</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
</span><span class='line'>                <span class="n">gtk_widget_destroy</span><span class="p">(</span><span class="n">dialog</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>                <span class="n">gtk_widget_destroy</span><span class="p">(</span><span class="n">dialog</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The code</h2>

<p>This is the full code: feel free to hack away at it.
It is taken from <a href="https://github.com/tschoonj/xmimsim/blob/master/bin/xmimsim-gui-results.c">xmimsim-gui-results.c</a>, which contains a lot more GtkExtra related code: drawing lines, changing graph properties, hiding data etc.
Keep in mind that up to today, GtkExtra is still only compatible with Gtk2. However, the developers are actively working on providing Gtk3 support as well. Any help in accomplishing this transition would be greatly appreciated!</p>

<div><script src='https://gist.github.com/6040427.js'></script>
<noscript><pre><code>/*
 * compile with gcc -o gtkextra-print-export `pkg-config --cflags gtkextra-3.0` gtkextra-print-export.c `pkg-config --libs gtkextra-3.0`
 */


#include &lt;gtkextra/gtkextra.h&gt;
#include &lt;cairo-ps.h&gt;
#include &lt;cairo-pdf.h&gt;
#include &lt;math.h&gt;
#include &lt;string.h&gt;



struct dialogData {
    GtkWidget *window;
    GtkWidget *canvas;
};


void destroy_window_cb(GtkWidget *widget, gpointer data) {
    gtk_main_quit();
}

gboolean delete_event_cb(GtkWidget *widget, GdkEvent *event, gpointer data) {
    return FALSE;
}

void draw_page(GtkPrintOperation *operation, GtkPrintContext *context, gint page_nr, struct dialogData *dd) {
        cairo_t *cr;

    //the following two lines do all the magic
        cr = gtk_print_context_get_cairo_context(context);
        gtk_plot_canvas_export_cairo(GTK_PLOT_CANVAS(dd-&gt;canvas),cr);

        return;
}

void print_button_clicked_cb(GtkWidget *button, struct dialogData *dd) {
    GtkPrintOperation *operation;
        GError *error = NULL;
        GtkPrintOperationResult res;
    GtkPrintSettings *print_settings;
    GtkPageSetup *page_setup;

    //print settings
        print_settings = gtk_print_settings_new();
        gtk_print_settings_set_orientation(print_settings,GTK_PAGE_ORIENTATION_LANDSCAPE);
        gtk_print_settings_set_paper_size(print_settings,gtk_paper_size_new(GTK_PAPER_NAME_A4));
        page_setup = gtk_page_setup_new();
        gtk_page_setup_set_orientation(page_setup,GTK_PAGE_ORIENTATION_LANDSCAPE);
        gtk_page_setup_set_paper_size_and_default_margins(page_setup,gtk_paper_size_new(GTK_PAPER_NAME_A4));

        operation = gtk_print_operation_new();
        gtk_print_operation_set_print_settings(operation,print_settings);
        gtk_print_operation_set_default_page_setup(operation,page_setup);
        gtk_print_operation_set_show_progress(operation,TRUE);
        gtk_print_operation_set_track_print_status(operation, TRUE);
        g_signal_connect(G_OBJECT(operation), &quot;draw-page&quot;, G_CALLBACK(draw_page), dd);
        gtk_print_operation_set_n_pages(operation, 1);
        
        res = gtk_print_operation_run(operation, GTK_PRINT_OPERATION_ACTION_PRINT_DIALOG, GTK_WINDOW(dd-&gt;window),&amp;error);

        if (res == GTK_PRINT_OPERATION_RESULT_APPLY) {
                g_object_unref(print_settings);
                print_settings = g_object_ref(gtk_print_operation_get_print_settings(operation));
        }


        g_object_unref(operation);



        return;

}

void export_button_clicked_cb(GtkWidget *button, struct dialogData *dd) {
    GtkWidget *dialog;
        GtkFileFilter *filter;
        gchar *filename;
        cairo_t *cr;
        cairo_surface_t *surface;

    dialog = gtk_file_chooser_dialog_new(&quot;Export spectra&quot;, 
                GTK_WINDOW(dd-&gt;window), GTK_FILE_CHOOSER_ACTION_SAVE,
                GTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL,
                GTK_STOCK_SAVE, GTK_RESPONSE_ACCEPT, NULL);

    gtk_file_chooser_set_do_overwrite_confirmation (GTK_FILE_CHOOSER (dialog), TRUE);
        filter = gtk_file_filter_new();
        gtk_file_filter_add_pattern(filter,&quot;*.eps&quot;);
        gtk_file_filter_set_name(filter,&quot;EPS (Encapsulated PostScript)&quot;);
        gtk_file_chooser_add_filter(GTK_FILE_CHOOSER(dialog), filter);
        filter = gtk_file_filter_new();
        gtk_file_filter_add_pattern(filter,&quot;*.pdf&quot;);
        gtk_file_filter_set_name(filter,&quot;PDF (Adobe Portable Document Format)&quot;);
        gtk_file_chooser_add_filter(GTK_FILE_CHOOSER(dialog), filter);
        filter = gtk_file_filter_new();
        gtk_file_filter_add_pattern(filter,&quot;*.png&quot;);
        gtk_file_filter_set_name(filter,&quot;PNG (Portable Network Graphics)&quot;);
        gtk_file_chooser_add_filter(GTK_FILE_CHOOSER(dialog), filter);

    if (gtk_dialog_run(GTK_DIALOG(dialog)) == GTK_RESPONSE_ACCEPT) {
                filename = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(dialog));
                //get selected filter
                filter = gtk_file_chooser_get_filter(GTK_FILE_CHOOSER(dialog));
                if (strncmp(gtk_file_filter_get_name(filter),&quot;EPS&quot;, 3) == 0) {
                        if (strcmp(filename+strlen(filename)-4, &quot;.eps&quot;) != 0) {
                                filename = (gchar *) g_realloc(filename,sizeof(gchar)*(strlen(filename)+4));
                                strcat(filename,&quot;.eps&quot;);
                        }
                        surface = cairo_ps_surface_create(filename,842,595);
                        cairo_ps_surface_set_eps(surface,1);
                        cr = cairo_create(surface);

                        gtk_plot_canvas_export_cairo(GTK_PLOT_CANVAS(dd-&gt;canvas),cr);
                        cairo_show_page(cr);
                        cairo_surface_destroy(surface);
                        cairo_destroy(cr);

                }
        else if (strncmp(gtk_file_filter_get_name(filter),&quot;PDF&quot;, 3) == 0) {
                        if (strcmp(filename+strlen(filename)-4, &quot;.pdf&quot;) != 0) {
                                filename = (gchar *) g_realloc(filename,sizeof(gchar)*(strlen(filename)+4));
                                strcat(filename,&quot;.pdf&quot;);
                        }
                        surface = cairo_pdf_surface_create(filename,842.0,595.0);
                        cr = cairo_create(surface);
                        gtk_plot_canvas_export_cairo(GTK_PLOT_CANVAS(dd-&gt;canvas),cr);
                        cairo_show_page(cr);
                        cairo_surface_destroy(surface);
                        cairo_destroy(cr);
                }
                else if (strncmp(gtk_file_filter_get_name(filter),&quot;PNG&quot;, 3) == 0) {
                        if (strcmp(filename+strlen(filename)-4, &quot;.png&quot;) != 0) {
                                filename = (gchar *) g_realloc(filename,sizeof(gchar)*(strlen(filename)+4));
                                strcat(filename,&quot;.png&quot;);
                        }
                        surface = cairo_image_surface_create(CAIRO_FORMAT_ARGB32, 842, 595);
                        cr = cairo_create(surface);
                        gtk_plot_canvas_export_cairo(GTK_PLOT_CANVAS(dd-&gt;canvas),cr);
                        cairo_surface_write_to_png(surface,filename);
                        cairo_surface_destroy(surface);
                        cairo_destroy(cr);
                }
                g_free(filename);
                gtk_widget_destroy(dialog);
    }
    else
                gtk_widget_destroy(dialog);


        return;

}

int main(int argc, char *argv[]) {

    GdkColor white, red;

    gtk_init(&amp;argc, &amp;argv);

    //create window
    GtkWidget *window = gtk_window_new(GTK_WINDOW_TOPLEVEL);
    g_signal_connect(window, &quot;destroy&quot;, G_CALLBACK(destroy_window_cb), NULL);
    g_signal_connect(window, &quot;delete-event&quot;, G_CALLBACK(delete_event_cb), NULL);
        gtk_window_set_title(GTK_WINDOW(window), &quot;GtkExtra example&quot;);
        gtk_window_set_position(GTK_WINDOW(window), GTK_WIN_POS_CENTER);

    //create box that will contain the buttons and the canvas
    GtkWidget *mainbox = gtk_vbox_new(FALSE, 2);
    gtk_container_set_border_width(GTK_CONTAINER(mainbox),5);
    gtk_container_add(GTK_CONTAINER(window), mainbox);

    GtkWidget *buttonbox = gtk_hbox_new(TRUE, 2);
    GtkWidget *printButton, *exportButton, *quitButton;
    
    printButton = gtk_button_new_from_stock(GTK_STOCK_PRINT);
    exportButton = gtk_button_new_from_stock(GTK_STOCK_SAVE_AS);
    quitButton = gtk_button_new_from_stock(GTK_STOCK_QUIT);

    gtk_box_pack_start(GTK_BOX(buttonbox), printButton, FALSE, FALSE, 1);
    gtk_box_pack_start(GTK_BOX(buttonbox), exportButton, FALSE, FALSE, 1);
    gtk_box_pack_start(GTK_BOX(buttonbox), quitButton, FALSE, FALSE, 1);

    struct dialogData *dd = g_malloc(sizeof(struct dialogData));
    dd-&gt;window = window;

    g_signal_connect(G_OBJECT(exportButton),&quot;clicked&quot;,G_CALLBACK(export_button_clicked_cb), dd);
    g_signal_connect(G_OBJECT(printButton),&quot;clicked&quot;,G_CALLBACK(print_button_clicked_cb), dd);
    g_signal_connect_swapped(G_OBJECT(quitButton), &quot;clicked&quot;, G_CALLBACK(gtk_widget_destroy), window);

    gtk_box_pack_start(GTK_BOX(mainbox), buttonbox, FALSE, FALSE, 1);

    GtkWidget *canvas = gtk_plot_canvas_new(GTK_PLOT_A4_H, GTK_PLOT_A4_W, 0.8);
    gtk_box_pack_start(GTK_BOX(mainbox), canvas, FALSE, FALSE, 2);
    GTK_PLOT_CANVAS_UNSET_FLAGS(GTK_PLOT_CANVAS(canvas), GTK_PLOT_CANVAS_CAN_SELECT | GTK_PLOT_CANVAS_CAN_SELECT_ITEM);
    gdk_color_parse(&quot;white&quot;, &amp;white);
    gdk_colormap_alloc_color(gdk_colormap_get_system(), &amp;white, FALSE, TRUE);
    gdk_color_parse(&quot;red&quot;, &amp;red);
    gdk_colormap_alloc_color(gdk_colormap_get_system(), &amp;red, FALSE, TRUE);
    gtk_plot_canvas_set_background(GTK_PLOT_CANVAS(canvas),&amp;white);
    dd-&gt;canvas = canvas;

    //lets add a graph to canvas
    //calculate a sine function
    double *xvals = g_malloc(sizeof(double)*1000);
    double *yvals = g_malloc(sizeof(double)*1000);

    int i;

    for (i = 0 ; i &lt; 1000 ; i++) {
        xvals[i] = 4*M_PI*i/999;
        yvals[i] = sin(xvals[i]);
    }
    GtkWidget *plot_window;
        plot_window = gtk_plot_new_with_size(NULL,.65,.45);
        gtk_plot_set_background(GTK_PLOT(plot_window),&amp;white);
    gtk_plot_hide_legends(GTK_PLOT(plot_window));
    
    gtk_plot_set_ticks(GTK_PLOT(plot_window), GTK_PLOT_AXIS_X, M_PI_2, 5);
    gtk_plot_set_ticks(GTK_PLOT(plot_window), GTK_PLOT_AXIS_Y, 0.2, 5);
    gtk_plot_grids_set_visible(GTK_PLOT(plot_window),TRUE ,FALSE, TRUE,FALSE);
    gtk_plot_axis_hide_title(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_TOP));
    gtk_plot_axis_hide_title(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_RIGHT));
    gtk_plot_axis_set_title(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_BOTTOM),&quot;x&quot;);
    gtk_plot_axis_set_title(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_LEFT),&quot;y=sin(x)&quot;);
    gtk_plot_axis_title_set_attributes(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_LEFT),&quot;Helvetica&quot;,40,90,NULL,NULL,TRUE,GTK_JUSTIFY_CENTER);
    gtk_plot_axis_title_set_attributes(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_BOTTOM),&quot;Helvetica&quot;,40,0,NULL,NULL,TRUE,GTK_JUSTIFY_CENTER);
    gtk_plot_axis_set_labels_attributes(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_LEFT),&quot;Helvetica&quot;,20,0,NULL,NULL,TRUE,GTK_JUSTIFY_RIGHT);
    gtk_plot_axis_set_labels_attributes(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_RIGHT),&quot;Helvetica&quot;,20,0,NULL,NULL,TRUE,GTK_JUSTIFY_LEFT);
    gtk_plot_axis_set_labels_attributes(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_BOTTOM),&quot;Helvetica&quot;,20,0,NULL,NULL,TRUE,GTK_JUSTIFY_CENTER);
    gtk_plot_axis_show_labels(gtk_plot_get_axis(GTK_PLOT(plot_window), GTK_PLOT_AXIS_TOP),0);

    GtkPlotCanvasChild *child = gtk_plot_canvas_plot_new(GTK_PLOT(plot_window));
        gtk_plot_canvas_put_child(GTK_PLOT_CANVAS(canvas), child, .15,.05,.90,.85);
    GtkPlotData *dataset;
        dataset = GTK_PLOT_DATA(gtk_plot_data_new());
        gtk_plot_add_data(GTK_PLOT(plot_window),dataset);
        gtk_plot_data_set_numpoints(dataset, 1000);
        gtk_plot_data_set_x(dataset, xvals);
        gtk_plot_data_set_y(dataset, yvals);
    gtk_plot_set_range(GTK_PLOT(plot_window),0.0, 4*M_PI, -1.0, 1.0);
        gtk_plot_clip_data(GTK_PLOT(plot_window), TRUE);
        gtk_widget_show(GTK_WIDGET(dataset));
        gtk_plot_data_set_line_attributes(dataset,GTK_PLOT_LINE_SOLID,0,0,1,&amp;red);
        gtk_plot_canvas_paint(GTK_PLOT_CANVAS(canvas));
        gtk_widget_queue_draw(GTK_WIDGET(canvas));
        gtk_plot_canvas_refresh(GTK_PLOT_CANVAS(canvas));
        gtk_plot_paint(GTK_PLOT(plot_window));
        gtk_plot_refresh(GTK_PLOT(plot_window),NULL);

    gtk_widget_show_all(window);

    gtk_main(); 
}</code></pre></noscript></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Checking for updates using git tags]]></title>
    <link href="http://yeangpeng.tech/blog/2013/07/08/checking-for-updates-using-git-tags/"/>
    <updated>2013-07-08T19:39:00+08:00</updated>
    <id>http://yeangpeng.tech/blog/2013/07/08/checking-for-updates-using-git-tags</id>
    <content type="html"><![CDATA[<p>At some point during the development of version 2.0 of my software package <a href="http://github.com/tschoonj/xmimsim">XMI-MSIM</a>, I decided to implement a routine that would allow for the program to check if newer versions (updates) were available. This would be extremely useful for the users of the Windows and Mac OS X builds of my package, since these operating systems do not come with package-management tools as most Linux distributions do (I am staying far away from Mac App Store and Windows store as I am not willing to pay their developer fees).</p>

<p>Initially I was looking at <a href="http://sparkle.andymatuschak.org">Sparkle</a>, a fantastic tool for OS X apps.
However, this would mean a different solution for my Windows build&hellip;</p>

<p>Since my goal is to keep the platform specific code as low as possible (#ifdef&rsquo;s really are quite ugly things), obviously I had to come up with a different solution.</p>

<!--more-->


<h2>Getting the tags with curl</h2>

<p>In a rare moment of clarity, I came up with the idea of using git tags for this. Like most people, I am using the tags to indicate releases, and as a rule I include the version number in the tagname (e.g. XMI-MSIM-1.0). My method consists of having a routine called <code>check_for_updates</code> (what&rsquo;s in a name?), download the list of tags from github.com (using the <a href="http://developer.github.com/v3/git/tags/">github v3 API for tags</a>). As I was writing (this part of) my application XMI-MSIM in C, I was looking for a library that could easily accomplish this. The quest yielded <a href="http://curl.haxx.se">libcurl</a>, an extremely versatile tool for transferring data using many, many protocols. The code I used for this was something like (full code at the end of this post):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="c1">//this line is obviously specific to your github account name and project name.</span>
</span><span class='line'>  <span class="c1">//Change it accordingly</span>
</span><span class='line'>  <span class="cp">#define XMIMSIM_GITHUB_TAGS_LOCATION &quot;https:</span><span class="c1">//api.github.com/repos/tschoonj/xmimsim/git/refs/tags&quot;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">char</span> <span class="n">curlerrors</span><span class="p">[</span><span class="n">CURL_ERROR_SIZE</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="n">CURL</span> <span class="o">*</span><span class="n">curl</span><span class="p">;</span>
</span><span class='line'>        <span class="n">CURLcode</span> <span class="n">res</span><span class="p">;</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">MemoryStruct</span> <span class="n">chunk</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">chunk</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">chunk</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="s">&quot;checking for updates...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//setup curl</span>
</span><span class='line'>        <span class="n">curl</span> <span class="o">=</span> <span class="n">curl_easy_init</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">curl</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;Could not initialize cURL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">XMIMSIM_UPDATES_ERROR</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">curl</span><span class="p">,</span> <span class="n">CURLOPT_URL</span><span class="p">,</span><span class="n">XMIMSIM_GITHUB_TAGS_LOCATION</span><span class="p">);</span>
</span><span class='line'>        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">curl</span><span class="p">,</span> <span class="n">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
</span><span class='line'>        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">curl</span><span class="p">,</span> <span class="n">CURLOPT_WRITEFUNCTION</span><span class="p">,</span> <span class="n">WriteMemoryCallback</span><span class="p">);</span>
</span><span class='line'>        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">curl</span><span class="p">,</span> <span class="n">CURLOPT_WRITEDATA</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">chunk</span><span class="p">);</span>
</span><span class='line'>        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">curl</span><span class="p">,</span> <span class="n">CURLOPT_USERAGENT</span><span class="p">,</span> <span class="s">&quot;libcurl-agent/1.0&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">curl</span><span class="p">,</span> <span class="n">CURLOPT_ERRORBUFFER</span><span class="p">,</span> <span class="n">curlerrors</span><span class="p">);</span>
</span><span class='line'>        <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">curl</span><span class="p">,</span> <span class="n">CURLOPT_CONNECTTIMEOUT</span><span class="p">,</span> <span class="mi">4L</span><span class="p">);</span>
</span><span class='line'>        <span class="n">res</span> <span class="o">=</span> <span class="n">curl_easy_perform</span><span class="p">(</span><span class="n">curl</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;check_for_updates: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">curlerrors</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">XMIMSIM_UPDATES_ERROR</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">curl_easy_cleanup</span><span class="p">(</span><span class="n">curl</span><span class="p">);</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>Parse the JSON code with Json-Glib and compare versions</h2>

<p>The buffer that is returned in <code>chunk</code>, contains JSON code. To parse this, I used the Json-Glib library, a logical choice since my project is written in Gtk+ anyway&hellip; Code extract:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">parser</span> <span class="o">=</span> <span class="n">json_parser_new</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">json_parser_load_from_data</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">chunk</span><span class="p">.</span><span class="n">memory</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">error</span><span class="p">)</span> <span class="o">==</span>  <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;check_for_updates: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">return</span> <span class="n">XMIMSIM_UPDATES_ERROR</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">JsonNode</span> <span class="o">*</span><span class="n">rootNode</span> <span class="o">=</span> <span class="n">json_parser_get_root</span><span class="p">(</span><span class="n">parser</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">json_node_get_node_type</span><span class="p">(</span><span class="n">rootNode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">JSON_NODE_ARRAY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;check_for_updates: rootNode is not an Array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">XMIMSIM_UPDATES_ERROR</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">JsonArray</span> <span class="o">*</span><span class="n">rootArray</span> <span class="o">=</span> <span class="n">json_node_get_array</span><span class="p">(</span><span class="n">rootNode</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">max_version</span> <span class="o">=</span> <span class="n">g_strdup</span><span class="p">(</span><span class="n">PACKAGE_VERSION</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">current_version</span> <span class="o">=</span> <span class="n">g_strdup</span><span class="p">(</span><span class="n">max_version</span><span class="p">);</span>
</span><span class='line'>        <span class="n">json_array_foreach_element</span><span class="p">(</span><span class="n">rootArray</span><span class="p">,</span> <span class="p">(</span><span class="n">JsonArrayForeach</span><span class="p">)</span> <span class="n">check_version_of_tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_version</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">g_ascii_strtod</span><span class="p">(</span><span class="n">max_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">g_ascii_strtod</span><span class="p">(</span><span class="n">current_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
</span><span class='line'>                <span class="n">rv</span> <span class="o">=</span> <span class="n">XMIMSIM_UPDATES_AVAILABLE</span><span class="p">;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>                <span class="n">rv</span> <span class="o">=</span> <span class="n">XMIMSIM_UPDATES_NONE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">*</span><span class="n">max_version_rv</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">g_strstrip</span><span class="p">(</span><span class="n">max_version</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">g_object_unref</span><span class="p">(</span><span class="n">parser</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="s">&quot;done checking for updates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Important here is the <code>json_array_foreach_element</code> function, which will call <code>check_version_of_tag</code> for each tag, and update the highest found tag version number with each iteration.</p>

<p>After this, all that needs to be done is to compare this highest tag version with the internal version number (<code>PACKAGE_VERSION</code>, typically provided by a configure script), and the result is returned.</p>

<p>Now the method that I just described assumes that the version numbering is done with one major number and one minor number, allowing me to easily convert into a float for version comparison. Although this is sufficient for my personal needs, others may have to come up with a slightly more complex algorithm allowing to compare version numbers consisting of a major, minor and macro version number.</p>

<h2>The code</h2>

<p>This is the full code: feel free to hack away at it.
It is taken from <a href="https://github.com/tschoonj/xmimsim/blob/master/bin/xmimsim-gui-updater.c">xmimsim-gui-updater.c</a>, which also contains code to download the new packages from a webserver (also using curl).</p>

<div><script src='https://gist.github.com/5951294.js'></script>
<noscript><pre><code>#include &lt;curl/curl.h&gt;
#include &lt;json-glib/json-glib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;


/*
 *
 * This code allows for the checking of available updates by parsing the JSON output obtained
 * through requesting the tags from the GitHub repo of XMI-MSIM
 *
 *
 * compile with gcc -o github-updater `pkg-config --cflags json-glib-1.0 libcurl` github-updater.c `pkg-config --libs json-glib-1.0 libcurl`
 *
 *
 */

#define XMIMSIM_GITHUB_TAGS_LOCATION &quot;https://api.github.com/repos/tschoonj/xmimsim/git/refs/tags&quot;
#define XMIMSIM_DOWNLOADS_LOCATION &quot;http://lvserver.ugent.be/xmi-msim&quot;
#define PACKAGE_VERSION &quot;1.0&quot; 

enum {
        XMIMSIM_UPDATES_ERROR,
        XMIMSIM_UPDATES_AVAILABLE,
        XMIMSIM_UPDATES_NONE
};

struct MemoryStruct {
        char *memory;
        size_t size;
};

static size_t WriteMemoryCallback(void *contents, size_t size, size_t nmemb, void *userp) {
        size_t realsize = size * nmemb;
        struct MemoryStruct *mem = (struct MemoryStruct *)userp;
        
        mem-&gt;memory = realloc(mem-&gt;memory, mem-&gt;size + realsize + 1);
                       
        memcpy(&amp;(mem-&gt;memory[mem-&gt;size]), contents, realsize);
        mem-&gt;size += realsize;
        mem-&gt;memory[mem-&gt;size] = 0;
        
        return realsize;
}

static void check_version_of_tag(JsonArray *array, guint index, JsonNode *node, char **max_version) {
        JsonObject *object = json_node_get_object(node);
        if (!json_object_has_member(object,&quot;ref&quot;)) {
                return;
        }

        const gchar *ref_string = json_object_get_string_member(object, &quot;ref&quot;);

        //discard old tag...
        if (strncmp(ref_string,&quot;refs/tags/XMI-MSIM-&quot;,strlen(&quot;refs/tags/XMI-MSIM-&quot;)) != 0)
                return;

        char *tag_version_str = strrchr(ref_string,&#39;-&#39;)+1;
        gdouble tag_version = g_ascii_strtod(tag_version_str,NULL);
        if (tag_version &gt; g_ascii_strtod(*max_version,NULL)) {
                free(*max_version);
                *max_version = strdup(tag_version_str);
        }

        return;
}


int check_for_updates(char **max_version_rv) {
        GError *error = NULL;
        JsonParser *parser;
        char curlerrors[CURL_ERROR_SIZE];


        CURL *curl;
        CURLcode res;
        struct MemoryStruct chunk;
        
        chunk.memory = malloc(1);
        chunk.size = 0;

        fprintf(stdout,&quot;checking for updates...\n&quot;);
        
        
        curl = curl_easy_init();
        if (!curl) {
                fprintf(stderr,&quot;Could not initialize cURL\n&quot;);
                return XMIMSIM_UPDATES_ERROR;
        } 

        curl_easy_setopt(curl, CURLOPT_URL,XMIMSIM_GITHUB_TAGS_LOCATION);
        curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 0L);
        curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, WriteMemoryCallback);
        curl_easy_setopt(curl, CURLOPT_WRITEDATA, (void *)&amp;chunk);
        curl_easy_setopt(curl, CURLOPT_USERAGENT, &quot;libcurl-agent/1.0&quot;);
        curl_easy_setopt(curl, CURLOPT_ERRORBUFFER, curlerrors);
        curl_easy_setopt(curl, CURLOPT_CONNECTTIMEOUT, 4L);
        res = curl_easy_perform(curl);
        if (res != 0) {
                fprintf(stderr,&quot;check_for_updates: %s\n&quot;,curlerrors);
                return XMIMSIM_UPDATES_ERROR;
        }
        curl_easy_cleanup(curl);
        
        
                
        
        parser = json_parser_new();
        if (json_parser_load_from_data(parser, chunk.memory, -1,&amp;error) ==  FALSE) {
                if (error) {
                        fprintf(stderr,&quot;check_for_updates: %s\n&quot;,error-&gt;message);
                        return XMIMSIM_UPDATES_ERROR;
                }
        }
        JsonNode *rootNode = json_parser_get_root(parser);
        if(json_node_get_node_type(rootNode) != JSON_NODE_ARRAY) {
                fprintf(stderr,&quot;check_for_updates: rootNode is not an Array\n&quot;);
                return XMIMSIM_UPDATES_ERROR;
        }
        JsonArray *rootArray = json_node_get_array(rootNode);
        char *max_version = g_strdup(PACKAGE_VERSION);
        char *current_version = g_strdup(max_version);
        json_array_foreach_element(rootArray, (JsonArrayForeach) check_version_of_tag, &amp;max_version);

        int rv;
        if (g_ascii_strtod(max_version, NULL) &gt; g_ascii_strtod(current_version, NULL))
                rv = XMIMSIM_UPDATES_AVAILABLE;
        else
                rv = XMIMSIM_UPDATES_NONE;

        *max_version_rv = strdup(g_strstrip(max_version));

        g_object_unref(parser);
        fprintf(stdout,&quot;done checking for updates\n&quot;);

        return rv;
}

int main (int argc, char *argv[]) {
  char *max_version;

    int check = check_for_updates(&amp;max_version);

    if (check == XMIMSIM_UPDATES_AVAILABLE) {
        fprintf(stdout, &quot;Update available: now write some code to download the damn update\n&quot;);
    }
    return 0;
}</code></pre></noscript></div>



]]></content>
  </entry>
  
</feed>
